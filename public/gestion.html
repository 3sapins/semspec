<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <title>Gestion | Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 25px 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        h1 { color: #667eea; font-size: 28px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 15px; border-radius: 12px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; border: none; background: #f3f4f6; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .tab.active { background: #667eea; color: white; }
        .tab-content { display: none; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; }
        input, select, textarea { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; }
        tr:hover { background: #f9fafb; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .alert-success { background: #d1fae5; color: #065f46; }
        .alert-error { background: #fee2e2; color: #991b1b; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
        .card { background: #f9fafb; padding: 20px; border-radius: 10px; margin-bottom: 15px; }
        .badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        .badge-red { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ Gestion</h1>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="inscriptions-incompletes.html" class="btn" style="background:#f59e0b; color:white;">âš ï¸ Inscriptions incomplÃ¨tes</a>
                <a href="index.html" class="btn btn-secondary">â† Retour Admin</a>
            </div>
        </div>
        <div id="alert" class="alert"></div>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('listes')">ğŸ“‹ Listes</button>
            <button class="tab" onclick="switchTab('import')">ğŸ“¥ Import CSV</button>
            <button class="tab" onclick="switchTab('config-semaine')">ğŸ“… Semaine</button>
            <button class="tab" onclick="switchTab('quotas')">ğŸ“Š Quotas</button>
            <button class="tab" onclick="switchTab('inscriptions-classes')">ğŸ” Inscriptions</button>
            <button class="tab" onclick="switchTab('evaluations')">â­ Ã‰valuations</button>
            <button class="tab" onclick="switchTab('inscrire')">âœï¸ Inscrire</button>
            <button class="tab" onclick="switchTab('piquet')">ğŸ‘® Piquet</button>
            <button class="tab" onclick="switchTab('eleves-creneaux')">ğŸ‘ï¸ Ã‰lÃ¨ves/CrÃ©neaux</button>
            <button class="tab" onclick="switchTab('creneaux-faibles')">âš ï¸ Faibles</button>
            <button class="tab" style="background:#ef4444; color:white;" onclick="switchTab('cloturer')" >ğŸ ClÃ´turer</button>
        </div>

        <!-- LISTES -->
        <div id="listes" class="tab-content active">
            <h2 style="margin-bottom: 20px;">ğŸ“‹ Listes</h2>
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="loadListe('enseignants')">ğŸ‘¨â€ğŸ« Enseignants</button>
                <button class="btn btn-primary" onclick="showElevesAvecFiltres()">ğŸ“ Ã‰lÃ¨ves</button>
                <button class="btn btn-primary" onclick="loadListe('classes')">ğŸ« Classes</button>
                <button class="btn btn-primary" onclick="loadListe('salles')">ğŸšª Salles</button>
                <button class="btn btn-primary" onclick="loadListe('themes')">ğŸ¨ ThÃ¨mes</button>
                <button class="btn btn-primary" onclick="loadListe('types_salles')">ğŸ·ï¸ Types de Salles</button>
            </div>
            <div id="listeContainer"></div>
        </div>

        <!-- IMPORT CSV -->
        <div id="import" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ“¥ Import CSV</h2>
            
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px;">
                
                <!-- Import Ã‰lÃ¨ves -->
                <div class="card">
                    <h3>ğŸ“ Importer des Ã‰lÃ¨ves</h3>
                    <p style="color:#6b7280; font-size:13px; margin-bottom:15px;">
                        Format CSV: <code>nom,prenom,classe</code> ou <code>nom,prenom,classe,email</code><br>
                        <strong>Nouveau :</strong> Si l'Ã©lÃ¨ve existe dÃ©jÃ  (mÃªme nom/prÃ©nom ou email), sa classe sera mise Ã  jour !
                    </p>
                    <textarea id="csvEleves" rows="6" placeholder="nom,prenom,classe,email
Dupont,Jean,10VP1,jean.dupont@eduvaud.ch
Martin,Marie,10VP2,marie.martin@eduvaud.ch" style="width:100%; padding:10px; font-family:monospace; font-size:12px; border:1px solid #ddd; border-radius:5px;"></textarea>
                    
                    <div style="margin-top:10px; padding:10px; background:#fef3c7; border-radius:8px; border:1px solid #fcd34d;">
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                            <input type="checkbox" id="syncModeEleves" style="width:18px; height:18px;">
                            <div>
                                <strong style="color:#92400e;">ğŸ”„ Mode synchronisation</strong>
                                <div style="font-size:12px; color:#a16207;">Les Ã©lÃ¨ves absents de la liste seront dÃ©sactivÃ©s (ne pourront plus se connecter)</div>
                            </div>
                        </label>
                    </div>
                    
                    <button class="btn btn-success" style="margin-top:10px; width:100%;" onclick="importCSV('eleves')">ğŸ“¥ Importer / Mettre Ã  jour les Ã©lÃ¨ves</button>
                    <div id="importElevesResult" style="margin-top:10px;"></div>
                </div>
                
                <!-- Import Enseignants -->
                <div class="card">
                    <h3>ğŸ‘¨â€ğŸ« Importer des Enseignants</h3>
                    <p style="color:#6b7280; font-size:13px; margin-bottom:15px;">
                        Format CSV: <code>acronyme,nom,prenom,email,charge_max</code><br>
                        Exemple: <code>DUP,Dupont,Jean,j.dupont@ecole.ch,12</code>
                    </p>
                    <textarea id="csvEnseignants" rows="6" placeholder="acronyme,nom,prenom,email,charge_max
DUP,Dupont,Jean,j.dupont@ecole.ch,12
MAR,Martin,Marie,,10" style="width:100%; padding:10px; font-family:monospace; font-size:12px; border:1px solid #ddd; border-radius:5px;"></textarea>
                    <button class="btn btn-success" style="margin-top:10px; width:100%;" onclick="importCSV('enseignants')">ğŸ“¥ Importer les enseignants</button>
                </div>
                
                <!-- Import Ateliers -->
                <div class="card">
                    <h3>ğŸ¨ Importer des Ateliers</h3>
                    <p style="color:#6b7280; font-size:13px; margin-bottom:15px;">
                        Format CSV: <code>nom,enseignant,duree,places,type_salle,theme,statut</code><br>
                        DurÃ©e: 2, 4 ou 6 pÃ©riodes. Statut: brouillon, soumis, valide
                    </p>
                    <textarea id="csvAteliers" rows="6" placeholder="nom,enseignant,duree,places,type_salle,theme,statut
Cuisine italienne,DUP,4,15,Cuisine,Culinaire,soumis
Football,MAR,2,20,Gymnase,Sport,valide" style="width:100%; padding:10px; font-family:monospace; font-size:12px; border:1px solid #ddd; border-radius:5px;"></textarea>
                    <button class="btn btn-success" style="margin-top:10px; width:100%;" onclick="importCSV('ateliers')">ğŸ“¥ Importer les ateliers</button>
                </div>
                
                <!-- Import Classes -->
                <div class="card">
                    <h3>ğŸ« Importer des Classes</h3>
                    <p style="color:#6b7280; font-size:13px; margin-bottom:15px;">
                        Format CSV: <code>nom,niveau</code><br>
                        Exemple: <code>9VP1,9</code>
                    </p>
                    <textarea id="csvClasses" rows="6" placeholder="nom,niveau
9VP1,9
9VP2,9
10VP1,10" style="width:100%; padding:10px; font-family:monospace; font-size:12px; border:1px solid #ddd; border-radius:5px;"></textarea>
                    <button class="btn btn-success" style="margin-top:10px; width:100%;" onclick="importCSV('classes')">ğŸ“¥ Importer les classes</button>
                </div>
                
                <!-- Import Salles -->
                <div class="card">
                    <h3>ğŸšª Importer des Salles</h3>
                    <p style="color:#6b7280; font-size:13px; margin-bottom:15px;">
                        Format CSV: <code>nom,capacite,type_salle,batiment</code><br>
                        Exemple: <code>C101,25,Classe standard,BÃ¢timent A</code>
                    </p>
                    <textarea id="csvSalles" rows="6" placeholder="nom,capacite,type_salle,batiment
C101,25,Classe standard,BÃ¢timent A
Gym1,30,Gymnase,Sports
Cuisine,15,Cuisine,BÃ¢timent B" style="width:100%; padding:10px; font-family:monospace; font-size:12px; border:1px solid #ddd; border-radius:5px;"></textarea>
                    <button class="btn btn-success" style="margin-top:10px; width:100%;" onclick="importCSV('salles')">ğŸ“¥ Importer les salles</button>
                </div>
                
            </div>
            
            <!-- RÃ©sultats d'import -->
            <div id="importResults" style="margin-top:20px; display:none;">
                <h3>ğŸ“Š RÃ©sultats de l'import</h3>
                <div id="importResultsContent" style="background:#f9fafb; padding:15px; border-radius:10px; margin-top:10px;"></div>
            </div>
            
            <!-- Aide -->
            <div style="margin-top:30px; background:#eff6ff; padding:20px; border-radius:10px; border-left:4px solid #3b82f6;">
                <h3 style="color:#1e40af; margin-bottom:10px;">ğŸ’¡ Conseils pour l'import</h3>
                <ul style="color:#1e40af; margin-left:20px; line-height:1.8;">
                    <li>La premiÃ¨re ligne doit contenir les en-tÃªtes (nom des colonnes)</li>
                    <li>Les colonnes doivent Ãªtre sÃ©parÃ©es par des virgules</li>
                    <li>Pour les Ã©lÃ¨ves, la classe doit exister dans le systÃ¨me</li>
                    <li>Pour les ateliers, l'enseignant (acronyme) doit exister</li>
                    <li>Les doublons seront ignorÃ©s avec un message d'erreur</li>
                    <li>Vous pouvez aussi coller depuis Excel (copier les cellules)</li>
                </ul>
            </div>
        </div>

        <!-- EVALUATIONS -->
        <div id="evaluations" class="tab-content">
            <h2 style="margin-bottom: 20px;">â­ Gestion des Ã‰valuations</h2>
            
            <div style="background:#f9fafb; padding:20px; border-radius:10px; margin-bottom:20px;">
                <h3 style="margin-bottom:15px;">ParamÃ¨tres globaux</h3>
                <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                    <label style="font-weight:600;">Ã‰valuations :</label>
                    <button id="btnEvalOuvertes" class="btn btn-success" onclick="toggleEvaluationsGlobal(true)">ğŸ”“ Ouvrir</button>
                    <button id="btnEvalFermees" class="btn btn-danger" onclick="toggleEvaluationsGlobal(false)">ğŸ”’ Fermer</button>
                    <span id="evalStatus" style="margin-left:10px; font-weight:bold;"></span>
                </div>
                <p style="color:#6b7280; font-size:13px;">Quand ouvertes, les Ã©lÃ¨ves peuvent noter et commenter les ateliers auxquels ils ont participÃ©.</p>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                <div style="background:#f9fafb; padding:20px; border-radius:10px;">
                    <h4 style="margin-bottom:10px;">ğŸ“Š Statistiques</h4>
                    <div id="evalStatsContainer">Chargement...</div>
                </div>
                <div style="background:#f9fafb; padding:20px; border-radius:10px;">
                    <h4 style="margin-bottom:10px;">ğŸ† Top ateliers</h4>
                    <div id="evalTopContainer">Chargement...</div>
                </div>
            </div>
            
            <h3 style="margin-bottom:15px;">DerniÃ¨res Ã©valuations</h3>
            <div id="evalListContainer">Chargement...</div>
        </div>

        <!-- CLOTURER -->
        <div id="cloturer" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ ClÃ´turer la Semaine SpÃ©ciale</h2>
            
            <div style="background:#fee2e2; border:2px solid #ef4444; padding:20px; border-radius:10px; margin-bottom:20px;">
                <h3 style="color:#991b1b; margin-bottom:10px;">âš ï¸ Action irrÃ©versible</h3>
                <p style="color:#991b1b;">La clÃ´ture va :</p>
                <ul style="color:#991b1b; margin:10px 0 0 20px;">
                    <li>CrÃ©er une archive de tous les ateliers et inscriptions</li>
                    <li>Conserver les Ã©valuations dans l'archive</li>
                    <li>Vider le planning et les inscriptions</li>
                    <li>Remettre tous les ateliers en brouillon</li>
                </ul>
            </div>
            
            <div style="background:#f9fafb; padding:20px; border-radius:10px; margin-bottom:20px;">
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:5px;">AnnÃ©e *</label>
                    <input type="number" id="clotureAnnee" value="2026" min="2020" max="2100" style="padding:10px; border:2px solid #e5e7eb; border-radius:8px; width:150px;">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:5px;">Nom de l'archive</label>
                    <input type="text" id="clotureNom" placeholder="Semaine SpÃ©ciale 2026" style="padding:10px; border:2px solid #e5e7eb; border-radius:8px; width:100%; max-width:400px;">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:5px;">Notes (optionnel)</label>
                    <textarea id="clotureNotes" rows="3" placeholder="Commentaires sur cette Ã©dition..." style="padding:10px; border:2px solid #e5e7eb; border-radius:8px; width:100%;"></textarea>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                        <input type="checkbox" id="clotureReset" checked style="width:20px; height:20px;">
                        <span>RÃ©initialiser pour la nouvelle annÃ©e (recommandÃ©)</span>
                    </label>
                </div>
            </div>
            
            <button class="btn btn-danger" style="padding:15px 30px; font-size:16px;" onclick="cloturerSemaine()">
                ğŸ ClÃ´turer et Archiver
            </button>
            
            <div style="margin-top:20px;">
                <a href="archives.html" class="btn btn-secondary">ğŸ“š Voir les archives existantes</a>
            </div>
        </div>

        <!-- CONFIGURATION SEMAINE -->
        <div id="config-semaine" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ“… Configuration de la Semaine SpÃ©ciale</h2>
            <p style="margin-bottom:20px; color:#6b7280;">DÃ©finissez les dates et les jours actifs de la semaine spÃ©ciale.</p>
            
            <div class="grid">
                <div class="card">
                    <h3 style="margin-bottom:15px; color:#667eea;">ğŸ“† Dates</h3>
                    <div class="form-group">
                        <label>Date de dÃ©but</label>
                        <input type="date" id="semaineDebut">
                    </div>
                    <div class="form-group">
                        <label>Date de fin</label>
                        <input type="date" id="semaineFin">
                    </div>
                </div>
                
                <div class="card">
                    <h3 style="margin-bottom:15px; color:#667eea;">âœ… Jours actifs</h3>
                    <p style="margin-bottom:15px; font-size:13px; color:#6b7280;">DÃ©cochez les jours oÃ¹ il n'y a pas d'ateliers.</p>
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:normal;">
                            <input type="checkbox" id="jourLundi" value="lundi" style="width:20px; height:20px;">
                            <span>Lundi</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:normal;">
                            <input type="checkbox" id="jourMardi" value="mardi" style="width:20px; height:20px;">
                            <span>Mardi</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:normal;">
                            <input type="checkbox" id="jourMercredi" value="mercredi" style="width:20px; height:20px;">
                            <span>Mercredi</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:normal;">
                            <input type="checkbox" id="jourJeudi" value="jeudi" style="width:20px; height:20px;">
                            <span>Jeudi</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:normal;">
                            <input type="checkbox" id="jourVendredi" value="vendredi" style="width:20px; height:20px;">
                            <span>Vendredi</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div style="margin-top:20px;">
                <button class="btn btn-primary" onclick="sauvegarderConfigSemaine()">ğŸ’¾ Enregistrer la configuration</button>
            </div>
            
            <div class="card" style="margin-top:20px; background:#fef3c7; border:1px solid #f59e0b;">
                <h4 style="color:#92400e; margin-bottom:10px;">âš ï¸ Attention</h4>
                <p style="font-size:13px; color:#92400e;">
                    Les jours dÃ©sactivÃ©s ne seront plus disponibles pour le planning et les inscriptions.<br>
                    Les crÃ©neaux existants sur ces jours seront masquÃ©s mais pas supprimÃ©s.
                </p>
            </div>
        </div>

        <!-- QUOTAS -->
        <div id="quotas" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ“Š Quotas d'inscription</h2>
            <p style="margin-bottom:20px; color:#6b7280;">ContrÃ´le le pourcentage des places disponibles pour les inscriptions Ã©lÃ¨ves.</p>
            <div style="background:#f9fafb; padding:20px; border-radius:10px; margin-bottom:20px;">
                <label style="font-weight:600; margin-bottom:10px; display:block;">Quota actuel</label>
                <div style="display:flex; align-items:center; gap:15px;">
                    <input type="range" id="quotaSlider" min="0" max="100" value="100" style="flex:1; height:8px;" onchange="updateQuotaDisplay()">
                    <span id="quotaValue" style="font-size:24px; font-weight:bold; color:#667eea; min-width:60px;">100%</span>
                </div>
                <p style="margin-top:10px; font-size:13px; color:#6b7280;">0% = inscriptions fermÃ©es, 100% = toutes les places disponibles</p>
            </div>
            <button class="btn btn-success" onclick="saveQuota()">ğŸ’¾ Enregistrer le quota</button>
            <div id="quotaStatus" style="margin-top:15px;"></div>
        </div>

        <!-- INSCRIPTIONS CLASSES -->
        <div id="inscriptions-classes" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ” Inscriptions par Classe</h2>
            <p style="margin-bottom:20px; color:#6b7280;">Ouvrir ou fermer les inscriptions pour chaque classe.</p>
            <div style="margin-bottom:15px; display:flex; gap:10px;">
                <button class="btn btn-success" onclick="ouvrirToutesClasses()">âœ… Ouvrir toutes</button>
                <button class="btn btn-danger" onclick="fermerToutesClasses()">ğŸš« Fermer toutes</button>
            </div>
            <div id="classesInscriptionsContainer">Chargement...</div>
        </div>
        <div id="ajouter" class="tab-content">
            <h2 style="margin-bottom: 20px;">â• Ajouter</h2>
            <div class="grid">
                <div class="card">
                    <h3>ğŸ‘¨â€ğŸ« Enseignant</h3>
                    <form id="formEnseignant">
                        <div class="form-group"><label>Acronyme *</label><input type="text" id="ens_acronyme" required></div>
                        <div class="form-group"><label>Nom *</label><input type="text" id="ens_nom" required></div>
                        <div class="form-group"><label>PrÃ©nom *</label><input type="text" id="ens_prenom" required></div>
                        <div class="form-group"><label>Email</label><input type="email" id="ens_email"></div>
                        <div class="form-group"><label>Charge max (pÃ©riodes)</label><input type="number" id="ens_charge_max" min="0" max="30" value="0" placeholder="0 = illimitÃ©"></div>
                        <button type="submit" class="btn btn-success">Ajouter</button>
                    </form>
                </div>
                <div class="card">
                    <h3>ğŸ« Classe</h3>
                    <form id="formClasse">
                        <div class="form-group"><label>Nom *</label><input type="text" id="classe_nom" required placeholder="ex: 9VP1"></div>
                        <div class="form-group"><label>Niveau</label><select id="classe_niveau"><option value="">--</option><option>9VP</option><option>9VG</option><option>10VP</option><option>10VG</option></select></div>
                        <button type="submit" class="btn btn-success">Ajouter</button>
                    </form>
                </div>
                <div class="card">
                    <h3>ğŸšª Salle</h3>
                    <form id="formSalle">
                        <div class="form-group"><label>Nom *</label><input type="text" id="salle_nom" required></div>
                        <div class="form-group"><label>CapacitÃ©</label><input type="number" id="salle_capacite" value="25"></div>
                        <div class="form-group"><label>Type</label><select id="salle_type"></select></div>
                        <button type="submit" class="btn btn-success">Ajouter</button>
                    </form>
                </div>
                <div class="card">
                    <h3>ğŸ“ Ã‰lÃ¨ve</h3>
                    <form id="formEleve">
                        <div class="form-group"><label>Nom *</label><input type="text" id="eleve_nom" required></div>
                        <div class="form-group"><label>PrÃ©nom *</label><input type="text" id="eleve_prenom" required></div>
                        <div class="form-group"><label>Classe *</label><select id="eleve_classe" required></select></div>
                        <button type="submit" class="btn btn-success">Ajouter</button>
                    </form>
                </div>
                <div class="card">
                    <h3>ğŸ¨ ThÃ¨me</h3>
                    <form id="formTheme">
                        <div class="form-group"><label>Nom *</label><input type="text" id="theme_nom" required></div>
                        <div class="form-group"><label>Couleur</label><input type="color" id="theme_couleur" value="#667eea"></div>
                        <div class="form-group"><label>IcÃ´ne</label><input type="text" id="theme_icone" value="ğŸ¨" maxlength="5"></div>
                        <div class="form-group"><label>Description</label><input type="text" id="theme_description"></div>
                        <button type="submit" class="btn btn-success">Ajouter</button>
                    </form>
                </div>
                <div class="card">
                    <h3>ğŸ·ï¸ Type de Salle</h3>
                    <form id="formTypeSalle">
                        <div class="form-group"><label>Nom *</label><input type="text" id="type_salle_nom" required placeholder="ex: Salle informatique"></div>
                        <div class="form-group"><label>Description</label><input type="text" id="type_salle_description"></div>
                        <button type="submit" class="btn btn-success">Ajouter</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- INSCRIRE -->
        <div id="inscrire" class="tab-content">
            <h2 style="margin-bottom: 20px;">âœï¸ Inscrire Ã  un crÃ©neau</h2>
            <div class="grid">
                <div class="card">
                    <h3>ğŸ“‹ Inscrire une classe</h3>
                    <form id="formInscrireClasse">
                        <div class="form-group">
                            <label>ğŸ” Rechercher un crÃ©neau</label>
                            <input type="text" id="searchCreneauClasse" placeholder="Tapez le nom de l'atelier..." oninput="filterCreneaux('classe')">
                        </div>
                        <div class="form-group"><label>CrÃ©neau *</label><select id="inscr_planning_classe" required></select></div>
                        <div class="form-group"><label>Classe *</label><select id="inscr_classe" required></select></div>
                        <button type="submit" class="btn btn-success" style="width:100%;">ğŸ“¥ Inscrire</button>
                    </form>
                    <div id="resultatInscrClasse" style="margin-top: 15px;"></div>
                </div>
                <div class="card">
                    <h3>ğŸ¯ Inscrire des Ã©lÃ¨ves</h3>
                    <form id="formInscrireEleves">
                        <div class="form-group">
                            <label>ğŸ” Rechercher un crÃ©neau</label>
                            <input type="text" id="searchCreneauEleves" placeholder="Tapez le nom de l'atelier..." oninput="filterCreneaux('eleves')">
                        </div>
                        <div class="form-group"><label>CrÃ©neau *</label><select id="inscr_planning_eleves" required></select></div>
                        <div class="form-group"><label>Rechercher Ã©lÃ¨ve</label><input type="text" id="rechercheEleve" placeholder="Nom ou prÃ©nom..." oninput="rechercherEleves()"></div>
                        <div id="resultatsRecherche" style="max-height:150px;overflow-y:auto;border:1px solid #eee;border-radius:8px;margin-bottom:10px;"></div>
                        <div class="form-group"><label>SÃ©lectionnÃ©s</label><div id="elevesSelectionnes" style="min-height:40px;padding:10px;background:#f3f4f6;border-radius:8px;"></div></div>
                        <button type="submit" class="btn btn-success" style="width:100%;">ğŸ“¥ Inscrire</button>
                    </form>
                    <div id="resultatInscrEleves" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>

        <!-- PIQUET -->
        <div id="piquet" class="tab-content">

        <!-- INSCRIPTIONS Ã‰LÃˆVES -->
        <div id="inscriptions-eleves" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ“ Gestion Inscriptions Ã‰lÃ¨ves</h2>
            <div class="card">
                <div class="form-group">
                    <label>ğŸ” Rechercher un Ã©lÃ¨ve</label>
                    <input type="text" id="searchEleve" placeholder="Nom ou prÃ©nom..." oninput="rechercherEleveAdmin()">
                </div>
                <div id="resultatsRechercheEleve" style="max-height:200px;overflow-y:auto;border:1px solid #eee;border-radius:8px;margin-bottom:20px;"></div>
            </div>
            <div id="eleveInscriptionsContainer" style="display:none;">
                <div class="card">
                    <div id="eleveInfoHeader" style="margin-bottom:20px;"></div>
                    <div style="display:flex;gap:10px;margin-bottom:20px;">
                        <button class="btn btn-danger" id="btnDevalider" onclick="devaliderEleve()">ğŸ”“ DÃ©-valider</button>
                        <button class="btn btn-primary" onclick="showAjouterInscription()">â• Ajouter inscription</button>
                    </div>
                    <h3 style="margin-bottom:15px;">Inscriptions actuelles</h3>
                    <div id="eleveInscriptionsListe"></div>
                </div>
            </div>
            <!-- Modal ajouter inscription -->
            <div id="modalAjouterInscr" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
                <div style="background:white;padding:30px;border-radius:15px;max-width:500px;width:90%;">
                    <h3 style="color:#667eea;margin-bottom:20px;">â• Ajouter une inscription</h3>
                    <div class="form-group">
                        <label>ğŸ” Rechercher crÃ©neau</label>
                        <input type="text" id="searchCreneauAdmin" placeholder="Nom atelier..." oninput="filterCreneauxAdmin()">
                    </div>
                    <div class="form-group">
                        <label>CrÃ©neau</label>
                        <select id="adminInscriptionCreneau"></select>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="adminNotifier" checked> Notifier l'Ã©lÃ¨ve</label>
                    </div>
                    <div style="display:flex;gap:10px;justify-content:flex-end;">
                        <button class="btn btn-secondary" onclick="hideAjouterInscription()">Annuler</button>
                        <button class="btn btn-success" onclick="ajouterInscriptionAdmin()">Ajouter</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PIQUET (ancien) -->
            <h2 style="margin-bottom: 20px;">ğŸ‘® Piquet / DÃ©gagement</h2>
            <div class="grid">
                <div class="card">
                    <h3>Ajouter</h3>
                    <form id="formPiquet">
                        <div class="form-group"><label>Enseignant *</label><select id="piquet_enseignant" required></select></div>
                        <div class="form-group"><label>CrÃ©neau *</label><select id="piquet_creneau" required></select></div>
                        <div class="form-group"><label>Type *</label><select id="piquet_type"><option value="piquet">Piquet</option><option value="degagement">DÃ©gagement</option></select></div>
                        <div class="form-group"><label>Commentaire</label><input type="text" id="piquet_commentaire" placeholder="Optionnel"></div>
                        <button type="submit" class="btn btn-success" style="width:100%;">âœ… Ajouter</button>
                    </form>
                </div>
                <div><h3 style="margin-bottom: 15px;">Liste</h3><div id="piquetListe"></div></div>
            </div>
        </div>

        <!-- Ã‰LÃˆVES PAR CRÃ‰NEAU -->
        <div id="eleves-creneaux" class="tab-content">
            <h2 style="margin-bottom: 20px;">ğŸ‘ï¸ Ã‰lÃ¨ves par crÃ©neau</h2>
            <div class="card">
                <div style="display:flex;gap:15px;flex-wrap:wrap;margin-bottom:20px;">
                    <div class="form-group" style="flex:1;min-width:150px;"><label>Jour</label><select id="filtre_jour" onchange="loadElevesCreneaux()"><option value="">Tous</option><option value="lundi">Lundi</option><option value="mardi">Mardi</option><option value="mercredi">Mercredi</option><option value="jeudi">Jeudi</option><option value="vendredi">Vendredi</option></select></div>
                    <div class="form-group" style="flex:1;min-width:150px;"><label>Classe</label><select id="filtre_classe_eleves" onchange="loadElevesCreneaux()"></select></div>
                </div>
                <div id="elevesCreneauxContainer"></div>
            </div>
        </div>

        <!-- CRÃ‰NEAUX FAIBLES -->
        <div id="creneaux-faibles" class="tab-content">
            <h2 style="margin-bottom: 20px;">âš ï¸ CrÃ©neaux faibles</h2>
            <div class="card">
                <div class="form-group" style="max-width:150px;"><label>Seuil</label><input type="number" id="seuil_faibles" value="5" min="1" onchange="loadCreneauxFaibles()"></div>
                <div id="creneauxFaiblesContainer"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/gestion';
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'index.html';

        let allPlannings = [];
        let tousLesEleves = [];
        let elevesSelectionnesIds = new Set();

        document.addEventListener('DOMContentLoaded', () => {
            loadClassesForSelects();
            loadEnseignantsForSelects();
            loadCreneauxForSelects();
            loadPlanningsForSelects();
            chargerTousEleves();
            loadTypesSalles();
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'piquet') loadPiquetListe();
            if (tabName === 'eleves-creneaux') loadElevesCreneaux();
            if (tabName === 'creneaux-faibles') loadCreneauxFaibles();
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        // ========== IMPORT CSV ==========
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            // DÃ©tecter le sÃ©parateur (virgule ou tab pour Excel)
            const firstLine = lines[0];
            const separator = firstLine.includes('\t') ? '\t' : ',';
            
            // Parser les headers
            const headers = lines[0].split(separator).map(h => h.trim().toLowerCase().replace(/['"]/g, ''));
            
            // Parser les donnÃ©es
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = line.split(separator).map(v => v.trim().replace(/^["']|["']$/g, ''));
                const row = {};
                headers.forEach((header, idx) => {
                    row[header] = values[idx] || '';
                });
                data.push(row);
            }
            
            return data;
        }
        
        async function importCSV(type) {
            const textareaId = {
                'eleves': 'csvEleves',
                'enseignants': 'csvEnseignants',
                'ateliers': 'csvAteliers',
                'classes': 'csvClasses',
                'salles': 'csvSalles'
            }[type];
            
            const csvText = document.getElementById(textareaId).value.trim();
            if (!csvText) {
                showAlert('âŒ Veuillez coller des donnÃ©es CSV', 'error');
                return;
            }
            
            const data = parseCSV(csvText);
            if (data.length === 0) {
                showAlert('âŒ Aucune donnÃ©e valide trouvÃ©e', 'error');
                return;
            }
            
            // VÃ©rifier le mode sync pour les Ã©lÃ¨ves
            let syncMode = false;
            if (type === 'eleves') {
                syncMode = document.getElementById('syncModeEleves')?.checked || false;
                if (syncMode) {
                    if (!confirm(`âš ï¸ MODE SYNCHRONISATION ACTIVÃ‰ âš ï¸\n\nImporter ${data.length} Ã©lÃ¨ves ET dÃ©sactiver ceux qui ne sont pas dans la liste ?\n\nCette action dÃ©sactivera les comptes des Ã©lÃ¨ves absents de votre CSV.`)) return;
                } else {
                    if (!confirm(`Importer ${data.length} ${type} ?`)) return;
                }
            } else {
                if (!confirm(`Importer ${data.length} ${type} ?`)) return;
            }
            
            try {
                const bodyData = { data };
                if (type === 'eleves' && syncMode) {
                    bodyData.syncMode = true;
                }
                
                const response = await fetch(`${API_BASE}/import/${type}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify(bodyData)
                });
                
                const result = await response.json();
                
                // Afficher les rÃ©sultats
                const resultsDiv = document.getElementById('importResults');
                const contentDiv = document.getElementById('importResultsContent');
                
                let html = '';
                
                // Nouveau format pour les Ã©lÃ¨ves (avec created/updated/unchanged/deactivated)
                if (type === 'eleves' && result.data.created !== undefined) {
                    html += `<div style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:15px;">
                        <div style="background:#d1fae5; padding:15px 20px; border-radius:10px; text-align:center;">
                            <div style="font-size:28px; font-weight:bold; color:#059669;">${result.data.created}</div>
                            <div style="font-size:12px; color:#065f46;">CrÃ©Ã©s</div>
                        </div>
                        <div style="background:#dbeafe; padding:15px 20px; border-radius:10px; text-align:center;">
                            <div style="font-size:28px; font-weight:bold; color:#2563eb;">${result.data.updated}</div>
                            <div style="font-size:12px; color:#1d4ed8;">Mis Ã  jour</div>
                        </div>
                        <div style="background:#f3f4f6; padding:15px 20px; border-radius:10px; text-align:center;">
                            <div style="font-size:28px; font-weight:bold; color:#6b7280;">${result.data.unchanged}</div>
                            <div style="font-size:12px; color:#4b5563;">InchangÃ©s</div>
                        </div>
                        ${result.data.deactivated > 0 ? `
                        <div style="background:#fef2f2; padding:15px 20px; border-radius:10px; text-align:center;">
                            <div style="font-size:28px; font-weight:bold; color:#dc2626;">${result.data.deactivated}</div>
                            <div style="font-size:12px; color:#991b1b;">DÃ©sactivÃ©s</div>
                        </div>
                        ` : ''}
                    </div>`;
                    
                    // Afficher rÃ©sultat dans la zone dÃ©diÃ©e
                    const eleveResultDiv = document.getElementById('importElevesResult');
                    if (eleveResultDiv) {
                        let summaryHtml = `
                            <div style="background:#f0fdf4; border:1px solid #86efac; border-radius:8px; padding:12px; margin-top:10px;">
                                <strong>âœ… ${result.data.created}</strong> crÃ©Ã©s, 
                                <strong>ğŸ”„ ${result.data.updated}</strong> mis Ã  jour, 
                                <strong>â¸ï¸ ${result.data.unchanged}</strong> inchangÃ©s`;
                        if (result.data.deactivated > 0) {
                            summaryHtml += `, <strong style="color:#dc2626;">ğŸš« ${result.data.deactivated}</strong> dÃ©sactivÃ©s`;
                        }
                        summaryHtml += `</div>`;
                        eleveResultDiv.innerHTML = summaryHtml;
                    }
                } else {
                    // Ancien format pour les autres types
                    html += `<p style="font-size:18px; margin-bottom:15px;"><strong>âœ… ${result.data.success || result.data.created}</strong> ${type} importÃ©(e)s</p>`;
                }
                
                if (result.data.errors && result.data.errors.length > 0) {
                    html += `<div style="background:#fef2f2; padding:10px; border-radius:5px; margin-bottom:10px;">
                        <strong style="color:#dc2626;">âš ï¸ ${result.data.errors.length} erreurs :</strong>
                        <ul style="margin:10px 0 0 20px; color:#dc2626; font-size:13px;">
                            ${result.data.errors.slice(0, 20).map(e => `<li>${e}</li>`).join('')}
                            ${result.data.errors.length > 20 ? `<li>... et ${result.data.errors.length - 20} autres</li>` : ''}
                        </ul>
                    </div>`;
                }
                
                // DÃ©tails pour les Ã©lÃ¨ves (nouveau format)
                if (result.data.details && result.data.details.length > 0) {
                    const created = result.data.details.filter(d => d.action === 'created');
                    const updated = result.data.details.filter(d => d.action === 'updated');
                    
                    if (created.length > 0) {
                        html += `<details style="margin-top:10px;">
                            <summary style="cursor:pointer; color:#059669; font-weight:600;">ğŸ“— ${created.length} nouveaux comptes crÃ©Ã©s</summary>
                            <div style="max-height:150px; overflow-y:auto; margin-top:10px; font-size:12px; background:#f9fafb; padding:10px; border-radius:5px;">
                                <table style="width:100%; border-collapse:collapse;">
                                    <tr style="background:#e5e7eb;"><th style="padding:5px; text-align:left;">Nom</th><th style="padding:5px;">PrÃ©nom</th><th style="padding:5px;">Classe</th><th style="padding:5px;">Login</th></tr>
                                    ${created.map(c => `<tr><td style="padding:5px; border-bottom:1px solid #e5e7eb;">${c.nom}</td><td style="padding:5px; border-bottom:1px solid #e5e7eb;">${c.prenom}</td><td style="padding:5px; border-bottom:1px solid #e5e7eb;">${c.classe}</td><td style="padding:5px; border-bottom:1px solid #e5e7eb; font-family:monospace;">${c.login}</td></tr>`).join('')}
                                </table>
                            </div>
                        </details>`;
                    }
                    
                    if (updated.length > 0) {
                        html += `<details style="margin-top:10px;">
                            <summary style="cursor:pointer; color:#2563eb; font-weight:600;">ğŸ”„ ${updated.length} Ã©lÃ¨ves mis Ã  jour</summary>
                            <div style="max-height:150px; overflow-y:auto; margin-top:10px; font-size:12px; background:#f9fafb; padding:10px; border-radius:5px;">
                                <table style="width:100%; border-collapse:collapse;">
                                    <tr style="background:#e5e7eb;"><th style="padding:5px; text-align:left;">Nom</th><th style="padding:5px;">PrÃ©nom</th><th style="padding:5px;">Ancienne classe</th><th style="padding:5px;">Nouvelle classe</th></tr>
                                    ${updated.map(c => `<tr><td style="padding:5px; border-bottom:1px solid #e5e7eb;">${c.nom}</td><td style="padding:5px; border-bottom:1px solid #e5e7eb;">${c.prenom}</td><td style="padding:5px; border-bottom:1px solid #e5e7eb; color:#ef4444;">${c.oldClasse}</td><td style="padding:5px; border-bottom:1px solid #e5e7eb; color:#10b981; font-weight:600;">${c.newClasse}</td></tr>`).join('')}
                                </table>
                            </div>
                        </details>`;
                    }
                    
                    // Afficher les dÃ©sactivÃ©s
                    const deactivated = result.data.details.filter(d => d.action === 'deactivated');
                    if (deactivated.length > 0) {
                        html += `<details style="margin-top:10px;">
                            <summary style="cursor:pointer; color:#dc2626; font-weight:600;">ğŸš« ${deactivated.length} Ã©lÃ¨ves dÃ©sactivÃ©s (ont quittÃ©)</summary>
                            <div style="max-height:150px; overflow-y:auto; margin-top:10px; font-size:12px; background:#fef2f2; padding:10px; border-radius:5px;">
                                <table style="width:100%; border-collapse:collapse;">
                                    <tr style="background:#fecaca;"><th style="padding:5px; text-align:left;">Nom</th><th style="padding:5px;">PrÃ©nom</th><th style="padding:5px;">Ancienne classe</th><th style="padding:5px;">Login</th></tr>
                                    ${deactivated.map(c => `<tr><td style="padding:5px; border-bottom:1px solid #fca5a5;">${c.nom}</td><td style="padding:5px; border-bottom:1px solid #fca5a5;">${c.prenom}</td><td style="padding:5px; border-bottom:1px solid #fca5a5;">${c.classe || '-'}</td><td style="padding:5px; border-bottom:1px solid #fca5a5; font-family:monospace;">${c.login}</td></tr>`).join('')}
                                </table>
                            </div>
                        </details>`;
                    }
                } else if (result.data.created && Array.isArray(result.data.created) && result.data.created.length > 0) {
                    // Ancien format (pour enseignants, ateliers, etc.)
                    html += `<details style="margin-top:10px;">
                        <summary style="cursor:pointer; color:#059669;">Voir les ${result.data.created.length} Ã©lÃ©ments crÃ©Ã©s</summary>
                        <div style="max-height:200px; overflow-y:auto; margin-top:10px; font-size:12px; font-family:monospace;">
                            ${result.data.created.map(c => `<div style="padding:3px 0; border-bottom:1px solid #e5e7eb;">${JSON.stringify(c)}</div>`).join('')}
                        </div>
                    </details>`;
                }
                
                contentDiv.innerHTML = html;
                resultsDiv.style.display = 'block';
                
                showAlert(result.message, 'success');
                
                // RafraÃ®chir les listes si nÃ©cessaire
                if (type === 'eleves') chargerTousEleves();
                
            } catch (error) {
                console.error('Erreur import:', error);
                showAlert('âŒ Erreur lors de l\'import: ' + error.message, 'error');
            }
        }

        async function loadClassesForSelects() {
            try {
                const response = await fetch(`${API_BASE}/classes`, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                ['eleve_classe', 'inscr_classe', 'filtre_classe_eleves'].forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = '<option value="">-- Toutes --</option>';
                        result.data.forEach(c => select.innerHTML += `<option value="${c.id}">${c.nom}</option>`);
                    }
                });
            } catch (e) { console.error(e); }
        }

        async function loadEnseignantsForSelects() {
            try {
                const response = await fetch(`${API_BASE}/enseignants`, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                const select = document.getElementById('piquet_enseignant');
                if (select) {
                    select.innerHTML = '<option value="">-- SÃ©lectionner --</option>';
                    result.data.forEach(e => select.innerHTML += `<option value="${e.id}">${e.prenom} ${e.nom} (${e.acronyme})</option>`);
                }
            } catch (e) { console.error(e); }
        }

        async function loadCreneauxForSelects() {
            try {
                const response = await fetch('/api/planning/creneaux', { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                const select = document.getElementById('piquet_creneau');
                if (select) {
                    select.innerHTML = '<option value="">-- SÃ©lectionner --</option>';
                    result.data.forEach(c => {
                        const jour = c.jour.charAt(0).toUpperCase() + c.jour.slice(1);
                        select.innerHTML += `<option value="${c.id}">${jour} ${c.periode}</option>`;
                    });
                }
            } catch (e) { console.error(e); }
        }

        async function loadPlanningsForSelects() {
            try {
                const response = await fetch(`${API_BASE}/ateliers-planifies`, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                allPlannings = result.data || [];
                updatePlanningSelects(allPlannings);
            } catch (e) { console.error(e); }
        }

        function updatePlanningSelects(plannings) {
            ['inscr_planning_classe', 'inscr_planning_eleves'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">-- SÃ©lectionner --</option>';
                    plannings.forEach(p => {
                        const jour = p.jour.charAt(0).toUpperCase() + p.jour.slice(1);
                        const places = p.nombre_places_max - p.nb_inscrits;
                        select.innerHTML += `<option value="${p.planning_id}">${p.atelier_nom} - ${jour} ${p.periode} (${places} places)</option>`;
                    });
                }
            });
        }

        function filterCreneaux(type) {
            const searchInput = type === 'classe' ? document.getElementById('searchCreneauClasse') : document.getElementById('searchCreneauEleves');
            const term = searchInput.value.toLowerCase().trim();
            if (term.length === 0) { updatePlanningSelects(allPlannings); return; }
            const filtered = allPlannings.filter(p => p.atelier_nom.toLowerCase().includes(term) || p.jour.toLowerCase().includes(term));
            const selectId = type === 'classe' ? 'inscr_planning_classe' : 'inscr_planning_eleves';
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">-- SÃ©lectionner --</option>';
            filtered.forEach(p => {
                const jour = p.jour.charAt(0).toUpperCase() + p.jour.slice(1);
                const places = p.nombre_places_max - p.nb_inscrits;
                select.innerHTML += `<option value="${p.planning_id}">${p.atelier_nom} - ${jour} ${p.periode} (${places} places)</option>`;
            });
        }

        // ========== LISTE Ã‰LÃˆVES AVEC FILTRES MULTI-CLASSES ==========
        let classesDataCache = [];
        let selectedClassesFilter = new Set();
        
        async function showElevesAvecFiltres() {
            // Charger les classes si pas dÃ©jÃ  fait
            if (classesDataCache.length === 0) {
                const resp = await fetch(`${API_BASE}/classes`, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await resp.json();
                classesDataCache = result.data || [];
            }
            
            // Construire l'interface avec filtres
            let html = `
                <div style="background:#f3f4f6; padding:15px; border-radius:10px; margin-bottom:15px;">
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
                        <strong>Filtrer par classes :</strong>
                        <button class="btn btn-sm btn-secondary" onclick="toggleAllClasses(true)">Toutes</button>
                        <button class="btn btn-sm btn-secondary" onclick="toggleAllClasses(false)">Aucune</button>
                    </div>
                    <div id="classesCheckboxes" style="display:flex; flex-wrap:wrap; gap:8px;">
            `;
            
            classesDataCache.forEach(c => {
                const checked = selectedClassesFilter.size === 0 || selectedClassesFilter.has(c.id);
                html += `<label style="display:inline-flex; align-items:center; gap:4px; padding:4px 10px; background:white; border-radius:6px; cursor:pointer; font-size:13px;">
                    <input type="checkbox" value="${c.id}" ${checked ? 'checked' : ''} onchange="updateClassFilter()"> ${c.nom}
                </label>`;
            });
            
            html += `</div></div>
                <div style="margin-bottom:15px;">
                    <button class="btn btn-success" onclick="showAddModal('eleve')">â• Ajouter un Ã©lÃ¨ve</button>
                </div>
                <div id="elevesTableContainer">Chargement...</div>
            `;
            
            document.getElementById('listeContainer').innerHTML = html;
            loadElevesFiltered();
        }
        
        function toggleAllClasses(selectAll) {
            const checkboxes = document.querySelectorAll('#classesCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = selectAll);
            updateClassFilter();
        }
        
        function updateClassFilter() {
            selectedClassesFilter.clear();
            const checkboxes = document.querySelectorAll('#classesCheckboxes input[type="checkbox"]:checked');
            checkboxes.forEach(cb => selectedClassesFilter.add(parseInt(cb.value)));
            loadElevesFiltered();
        }
        
        async function loadElevesFiltered() {
            try {
                let url = `${API_BASE}/eleves-avec-indispos`;
                if (selectedClassesFilter.size > 0) {
                    url += `?classes=${Array.from(selectedClassesFilter).join(',')}`;
                }
                
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                
                let html = '<table><thead><tr><th>Nom</th><th>PrÃ©nom</th><th>Classe</th><th>Login</th><th>Indispos</th><th>Actions</th></tr></thead><tbody>';
                
                result.data.forEach(e => {
                    const nomEsc = (e.nom || '').replace(/'/g, "\\'");
                    const prenomEsc = (e.prenom || '').replace(/'/g, "\\'");
                    const indisposBadge = e.nb_indispos > 0 
                        ? `<span style="background:#fef3c7; color:#92400e; padding:2px 8px; border-radius:10px; font-size:12px; font-weight:600;">${e.nb_indispos} crÃ©neaux</span>`
                        : '<span style="color:#9ca3af;">-</span>';
                    
                    html += `<tr>
                        <td>${e.nom}</td>
                        <td>${e.prenom}</td>
                        <td>${e.classe_nom}</td>
                        <td><code style="background:#f3f4f6;padding:2px 6px;border-radius:4px;">${e.login || '-'}</code></td>
                        <td>${indisposBadge}</td>
                        <td style="white-space:nowrap;">
                            <button class="btn btn-sm" style="background:#667eea; color:white;" onclick="showHoraireEleve(${e.eleve_id}, '${prenomEsc} ${nomEsc}')" title="Voir l'horaire">ğŸ“…</button>
                            <button class="btn btn-sm btn-primary" onclick="editEleve(${e.eleve_id}, '${nomEsc}', '${prenomEsc}', ${e.classe_id})">âœï¸</button>
                            <button class="btn btn-sm" style="background:#f59e0b; color:white;" onclick="showIndisponibilites(${e.eleve_id}, '${prenomEsc} ${nomEsc}')">ğŸš«</button>
                            <button class="btn btn-sm btn-warning" onclick="resetPasswordEleve(${e.eleve_id}, '${prenomEsc} ${nomEsc}')">ğŸ”‘</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEleve(${e.eleve_id}, '${prenomEsc} ${nomEsc}')">ğŸ—‘ï¸</button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-top:15px;"><button class="btn btn-danger" onclick="resetAllPasswords('eleves')">ğŸ”‘ RÃ©initialiser TOUS les MDP Ã©lÃ¨ves</button></div>`;
                html += `<p style="margin-top:10px; color:#6b7280; font-size:13px;">${result.data.length} Ã©lÃ¨ve(s) affichÃ©(s)</p>`;
                
                document.getElementById('elevesTableContainer').innerHTML = html;
                
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('elevesTableContainer').innerHTML = '<p style="color:#ef4444;">Erreur de chargement</p>';
            }
        }
        
        // ========== MODALE INDISPONIBILITÃ‰S ==========
        async function showIndisponibilites(eleveId, eleveNom) {
            // Charger les indisponibilitÃ©s actuelles
            const response = await fetch(`${API_BASE}/eleves/${eleveId}/indisponibilites`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const result = await response.json();
            
            if (!result.success) {
                alert('Erreur: ' + result.message);
                return;
            }
            
            const JOURS = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi'];
            const creneauxParJour = {};
            JOURS.forEach(j => creneauxParJour[j] = []);
            
            result.creneaux.forEach(c => {
                if (creneauxParJour[c.jour]) {
                    creneauxParJour[c.jour].push(c);
                }
            });
            
            let html = `
                <div class="modal-overlay" id="indispoModal" style="display:flex; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
                    <div style="background:white; border-radius:15px; max-width:800px; width:95%; max-height:90vh; overflow-y:auto;">
                        <div style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
                            <h2>ğŸš« IndisponibilitÃ©s de ${eleveNom}</h2>
                            <button onclick="document.getElementById('indispoModal').remove()" style="background:none; border:none; color:white; font-size:28px; cursor:pointer;">&times;</button>
                        </div>
                        <div style="padding:20px;">
                            <p style="margin-bottom:15px; color:#6b7280;">Cocher les crÃ©neaux oÃ¹ l'Ã©lÃ¨ve ne peut <strong>pas</strong> participer (absence prÃ©vue, obligation, etc.)</p>
                            <div style="display:grid; grid-template-columns:repeat(5, 1fr); gap:10px;">
            `;
            
            JOURS.forEach(jour => {
                const jourCap = jour.charAt(0).toUpperCase() + jour.slice(1);
                html += `<div style="text-align:center;">
                    <div style="font-weight:700; margin-bottom:8px; padding:8px; background:#f3f4f6; border-radius:6px;">${jourCap}</div>`;
                
                creneauxParJour[jour].forEach(c => {
                    if (jour === 'mercredi' && c.periode === 'P6-7') {
                        html += `<div style="padding:10px; color:#9ca3af; font-size:12px;">CongÃ©</div>`;
                    } else {
                        const bgColor = c.indisponible ? '#fef2f2' : 'white';
                        const borderColor = c.indisponible ? '#ef4444' : '#e5e7eb';
                        html += `<label style="display:block; padding:10px; margin-bottom:6px; background:${bgColor}; border:2px solid ${borderColor}; border-radius:8px; cursor:pointer; transition:all 0.2s;" 
                            onmouseover="this.style.borderColor='#f59e0b'" onmouseout="this.style.borderColor='${c.indisponible ? '#ef4444' : '#e5e7eb'}'">
                            <input type="checkbox" id="indispo_${c.id}" ${c.indisponible ? 'checked' : ''} 
                                onchange="toggleIndispoStyle(this, ${c.id})"
                                style="margin-right:6px;">
                            <span style="font-size:13px;">${c.periode}</span>
                        </label>`;
                    }
                });
                
                html += '</div>';
            });
            
            html += `</div>
                        <div style="margin-top:20px; padding-top:15px; border-top:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
                            <span style="color:#6b7280; font-size:13px;">Les crÃ©neaux cochÃ©s seront bloquÃ©s pour l'inscription.</span>
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-secondary" onclick="document.getElementById('indispoModal').remove()">Annuler</button>
                                <button class="btn btn-success" onclick="saveIndisponibilites(${eleveId})">ğŸ’¾ Enregistrer</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function toggleIndispoStyle(checkbox, creneauId) {
            const label = checkbox.parentElement;
            if (checkbox.checked) {
                label.style.background = '#fef2f2';
                label.style.borderColor = '#ef4444';
            } else {
                label.style.background = 'white';
                label.style.borderColor = '#e5e7eb';
            }
        }
        
        async function saveIndisponibilites(eleveId) {
            const checkboxes = document.querySelectorAll('#indispoModal input[type="checkbox"]');
            const creneaux = [];
            
            checkboxes.forEach(cb => {
                const creneauId = parseInt(cb.id.replace('indispo_', ''));
                creneaux.push({
                    creneau_id: creneauId,
                    indisponible: cb.checked,
                    raison: '' // On pourrait ajouter un champ raison si besoin
                });
            });
            
            try {
                const response = await fetch(`${API_BASE}/eleves/${eleveId}/indisponibilites`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ creneaux })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('indispoModal').remove();
                    showAlert(result.message, 'success');
                    loadElevesFiltered(); // RafraÃ®chir la liste
                } else {
                    alert('Erreur: ' + result.message);
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        // ========== MODALE HORAIRE Ã‰LÃˆVE ==========
        async function showHoraireEleve(eleveId, eleveNom) {
            try {
                const response = await fetch(`${API_BASE}/eleves/${eleveId}/horaire`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                if (!result.success) {
                    alert('Erreur: ' + result.message);
                    return;
                }
                
                const { eleve, creneaux, creneauxOccupes, indisponibilites, stats } = result;
                const JOURS = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi'];
                const PERIODES = ['P1-2', 'P3-4', 'P6-7'];
                
                // Map crÃ©neaux par jour/pÃ©riode
                const creneauMap = {};
                creneaux.forEach(c => {
                    creneauMap[`${c.jour}-${c.periode}`] = c;
                });
                
                // Calculer si complet
                const isComplet = stats.nb_creneaux_remplis >= stats.nb_creneaux_total - stats.nb_indispos;
                const completBadge = isComplet 
                    ? '<span style="background:#d1fae5; color:#065f46; padding:4px 12px; border-radius:12px; font-weight:600;">âœ… Horaire complet</span>'
                    : `<span style="background:#fef3c7; color:#92400e; padding:4px 12px; border-radius:12px; font-weight:600;">âš ï¸ ${stats.nb_creneaux_total - stats.nb_creneaux_remplis - stats.nb_indispos} crÃ©neau(x) Ã  complÃ©ter</span>`;
                
                let html = `
                    <div class="modal-overlay" id="horaireEleveModal" style="display:flex; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
                        <div style="background:white; border-radius:15px; max-width:900px; width:95%; max-height:90vh; overflow-y:auto;">
                            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <h2 style="margin-bottom:5px;">ğŸ“… Horaire de ${eleve.prenom} ${eleve.nom}</h2>
                                    <span style="opacity:0.9;">${eleve.classe_nom}</span>
                                </div>
                                <button onclick="document.getElementById('horaireEleveModal').remove()" style="background:none; border:none; color:white; font-size:28px; cursor:pointer;">&times;</button>
                            </div>
                            <div style="padding:20px;">
                                <div style="display:flex; gap:15px; margin-bottom:20px; flex-wrap:wrap; align-items:center;">
                                    ${completBadge}
                                    <span style="color:#6b7280;">${stats.nb_inscriptions} atelier(s) inscrit(s)</span>
                                    ${stats.nb_indispos > 0 ? `<span style="color:#f59e0b;">ğŸš« ${stats.nb_indispos} indispo(s)</span>` : ''}
                                    <button class="btn btn-sm btn-secondary" onclick="printHoraireEleve()" style="margin-left:auto;">ğŸ–¨ï¸ Imprimer</button>
                                </div>
                                <div id="horaireEleveContent">
                                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                                        <thead>
                                            <tr style="background:#f3f4f6;">
                                                <th style="padding:10px; border:1px solid #e5e7eb;"></th>
                `;
                
                JOURS.forEach(jour => {
                    const jourCap = jour.charAt(0).toUpperCase() + jour.slice(1);
                    html += `<th style="padding:10px; border:1px solid #e5e7eb; text-align:center;">${jourCap}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                // Set pour tracker les cellules dÃ©jÃ  rendues (pour rowspan)
                const renderedCells = new Set();
                
                PERIODES.forEach(periode => {
                    html += `<tr><td style="padding:10px; border:1px solid #e5e7eb; font-weight:600; background:#f9fafb;">${periode}</td>`;
                    
                    JOURS.forEach(jour => {
                        // Mercredi P6-7 = congÃ©
                        if (jour === 'mercredi' && periode === 'P6-7') {
                            html += '<td style="padding:10px; border:1px solid #e5e7eb; text-align:center; color:#9ca3af; background:#f9fafb;">CongÃ©</td>';
                            return;
                        }
                        
                        const creneau = creneauMap[`${jour}-${periode}`];
                        if (!creneau) {
                            html += '<td style="padding:10px; border:1px solid #e5e7eb;">-</td>';
                            return;
                        }
                        
                        // DÃ©jÃ  rendu par un rowspan ?
                        if (renderedCells.has(creneau.id)) {
                            return;
                        }
                        
                        const atelier = creneauxOccupes[creneau.id];
                        const isIndispo = indisponibilites.includes(creneau.id);
                        
                        if (atelier && atelier.isFirst) {
                            const rowspan = atelier.rowspan > 1 ? ` rowspan="${atelier.rowspan}"` : '';
                            const bgColor = atelier.theme_couleur || '#667eea';
                            
                            // Marquer les crÃ©neaux suivants comme rendus
                            for (let i = 1; i < atelier.rowspan; i++) {
                                renderedCells.add(creneau.id + i);
                            }
                            
                            html += `<td${rowspan} style="padding:8px; border:1px solid #e5e7eb; background:${bgColor}20; vertical-align:top;">
                                <div style="font-weight:600; color:${bgColor}; margin-bottom:4px;">${atelier.atelier_nom}</div>
                                <div style="font-size:11px; color:#6b7280;">ğŸ“ ${atelier.salle_nom || '-'}</div>
                                ${atelier.rowspan > 1 ? `<div style="font-size:10px; color:#9ca3af; margin-top:4px;">â±ï¸ ${atelier.duree || atelier.rowspan*2}p</div>` : ''}
                            </td>`;
                        } else if (atelier) {
                            // Ce crÃ©neau fait partie d'un atelier multi-crÃ©neaux mais n'est pas le premier
                            return;
                        } else if (isIndispo) {
                            html += '<td style="padding:10px; border:1px solid #e5e7eb; text-align:center; background:#fef3c7; color:#92400e;">ğŸš« Indispo</td>';
                        } else {
                            html += '<td style="padding:10px; border:1px solid #e5e7eb; text-align:center; color:#d1d5db;">â€”</td>';
                        }
                    });
                    
                    html += '</tr>';
                });
                
                html += `</tbody></table>
                                </div>
                            </div>
                        </div>
                    </div>`;
                
                document.body.insertAdjacentHTML('beforeend', html);
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur de chargement de l\'horaire');
            }
        }
        
        function printHoraireEleve() {
            const content = document.getElementById('horaireEleveContent');
            const modal = document.getElementById('horaireEleveModal');
            const title = modal.querySelector('h2').textContent;
            const classe = modal.querySelector('span[style*="opacity"]').textContent;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { font-size: 18px; margin-bottom: 5px; }
                        h2 { font-size: 14px; color: #666; margin-bottom: 20px; font-weight: normal; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 11px; }
                        th { background: #f3f4f6; }
                        @media print { body { padding: 0; } }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <h2>${classe}</h2>
                    ${content.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function loadListe(type) {
            try {
                let url = `${API_BASE}/${type}`;
                if (type === 'themes') url = '/api/admin/themes/liste';
                if (type === 'types_salles') url = '/api/admin/types-salles';
                
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                
                // Bouton d'ajout en haut de la liste
                let html = '<div style="margin-bottom:15px;">';
                if (type === 'enseignants') {
                    html += '<button class="btn btn-success" onclick="showAddModal(\'enseignant\')">â• Ajouter un enseignant</button>';
                } else if (type === 'eleves') {
                    html += '<button class="btn btn-success" onclick="showAddModal(\'eleve\')">â• Ajouter un Ã©lÃ¨ve</button>';
                } else if (type === 'classes') {
                    html += '<button class="btn btn-success" onclick="showAddModal(\'classe\')">â• Ajouter une classe</button>';
                } else if (type === 'salles') {
                    html += '<button class="btn btn-success" onclick="showAddModal(\'salle\')">â• Ajouter une salle</button>';
                } else if (type === 'themes') {
                    html += '<button class="btn btn-success" onclick="showAddModal(\'theme\')">â• Ajouter un thÃ¨me</button>';
                } else if (type === 'types_salles') {
                    html += '<button class="btn btn-success" onclick="showAddModal(\'type_salle\')">â• Ajouter un type de salle</button>';
                }
                html += '</div>';
                
                html += '<table><thead><tr>';
                if (type === 'enseignants') {
                    html += '<th>Acronyme</th><th>Nom</th><th>PrÃ©nom</th><th>Email</th><th>Charge</th><th>Ateliers</th><th>Actions</th></tr></thead><tbody>';
                    result.data.forEach(e => {
                        const chargeMax = e.charge_max || 0;
                        const chargeText = chargeMax > 0 ? `${chargeMax}p` : 'illimitÃ©';
                        html += `<tr>
                            <td><strong>${e.acronyme}</strong></td>
                            <td>${e.nom}</td>
                            <td>${e.prenom}</td>
                            <td>${e.email || '-'}</td>
                            <td>${chargeText}</td>
                            <td>${e.nombre_ateliers}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editEnseignant(${e.id}, '${e.acronyme}', '${e.nom}', '${e.prenom}', '${e.email || ''}', ${chargeMax})">âœï¸</button>
                                <button class="btn btn-sm btn-secondary" onclick="voirDisponibilites(${e.id}, '${e.acronyme}')">ğŸ“…</button>
                                <button class="btn btn-sm btn-warning" onclick="resetPasswordEnseignant(${e.id}, '${e.acronyme}')">ğŸ”‘</button>
                            </td>
                        </tr>`;
                    });
                } else if (type === 'eleves') {
                    html += '<th>Nom</th><th>PrÃ©nom</th><th>Classe</th><th>Login</th><th>Actions</th></tr></thead><tbody>';
                    result.data.forEach(e => {
                        const login = e.login || '-';
                        const nomEsc = (e.nom || '').replace(/'/g, "\\'");
                        const prenomEsc = (e.prenom || '').replace(/'/g, "\\'");
                        html += `<tr>
                            <td>${e.nom}</td>
                            <td>${e.prenom}</td>
                            <td>${e.classe_nom}</td>
                            <td><code style="background:#f3f4f6;padding:2px 6px;border-radius:4px;">${login}</code></td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editEleve(${e.id}, '${nomEsc}', '${prenomEsc}', ${e.classe_id})">âœï¸</button>
                                <button class="btn btn-sm btn-warning" onclick="resetPasswordEleve(${e.id}, '${prenomEsc} ${nomEsc}')">ğŸ”‘</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteEleve(${e.id}, '${prenomEsc} ${nomEsc}')">ğŸ—‘ï¸</button>
                            </td>
                        </tr>`;
                    });
                } else if (type === 'classes') {
                    html += '<th>Nom</th><th>Niveau</th><th>Ã‰lÃ¨ves</th><th>Actions</th></tr></thead><tbody>';
                    result.data.forEach(c => {
                        const nomEsc = (c.nom || '').replace(/'/g, "\\'");
                        const niveauEsc = (c.niveau || '').replace(/'/g, "\\'");
                        html += `<tr>
                            <td>${c.nom}</td>
                            <td>${c.niveau || '-'}</td>
                            <td>${c.nombre_eleves}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editClasse(${c.id}, '${nomEsc}', '${niveauEsc}')">âœï¸</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteClasse(${c.id}, '${nomEsc}')">ğŸ—‘ï¸</button>
                            </td>
                        </tr>`;
                    });
                } else if (type === 'salles') {
                    html += '<th>Nom</th><th>CapacitÃ©</th><th>Type</th><th>Dispo</th><th>Actions</th></tr></thead><tbody>';
                    result.data.forEach(s => {
                        const nomEsc = (s.nom || '').replace(/'/g, "\\'");
                        const typeEsc = (s.type_salle || '').replace(/'/g, "\\'");
                        html += `<tr>
                            <td>${s.nom}</td>
                            <td>${s.capacite}</td>
                            <td>${s.type_salle || '-'}</td>
                            <td>${s.disponible ? 'âœ…' : 'âŒ'}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editSalle(${s.id}, '${nomEsc}', ${s.capacite}, '${typeEsc}', ${s.disponible})">âœï¸</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSalle(${s.id}, '${nomEsc}')">ğŸ—‘ï¸</button>
                            </td>
                        </tr>`;
                    });
                } else if (type === 'themes') {
                    html += '<th>IcÃ´ne</th><th>Nom</th><th>Couleur</th><th>Description</th><th>Actions</th></tr></thead><tbody>';
                    result.data.forEach(t => html += `<tr>
                        <td style="font-size:24px;">${t.icone || 'ğŸ¨'}</td>
                        <td><strong>${t.nom}</strong></td>
                        <td><span style="display:inline-block;width:20px;height:20px;background:${t.couleur || '#667eea'};border-radius:4px;vertical-align:middle;"></span> ${t.couleur || '#667eea'}</td>
                        <td>${t.description || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editTheme(${t.id}, '${(t.nom || '').replace(/'/g, "\\'")}', '${t.couleur || '#667eea'}', '${t.icone || 'ğŸ¨'}', '${(t.description || '').replace(/'/g, "\\'")}')">âœï¸</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTheme(${t.id}, '${(t.nom || '').replace(/'/g, "\\'")}')">ğŸ—‘ï¸</button>
                        </td>
                    </tr>`);
                } else if (type === 'types_salles') {
                    html += '<th>Nom</th><th>Description</th><th>Actions</th></tr></thead><tbody>';
                    result.data.forEach(t => html += `<tr>
                        <td><strong>${t.nom}</strong></td>
                        <td>${t.description || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editTypeSalle(${t.id}, '${(t.nom || '').replace(/'/g, "\\'")}', '${(t.description || '').replace(/'/g, "\\'")}')">âœï¸</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTypeSalle(${t.id}, '${(t.nom || '').replace(/'/g, "\\'")}')">ğŸ—‘ï¸</button>
                        </td>
                    </tr>`);
                }
                html += '</tbody></table>';
                
                // Boutons reset global
                if (type === 'enseignants') {
                    html += `<div style="margin-top:15px; display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn btn-danger" onclick="resetAllPasswords('enseignants')">ğŸ”‘ RÃ©initialiser TOUS les MDP</button>
                    </div>`;
                } else if (type === 'eleves') {
                    html += `<div style="margin-top:15px;"><button class="btn btn-danger" onclick="resetAllPasswords('eleves')">ğŸ”‘ RÃ©initialiser TOUS les MDP Ã©lÃ¨ves</button></div>`;
                }
                
                html += '<p style="margin-top:10px;color:#666;"><strong>' + result.data.length + '</strong> enregistrements</p>';
                document.getElementById('listeContainer').innerHTML = html;
            } catch (e) { document.getElementById('listeContainer').innerHTML = '<p style="color:red;">Erreur: ' + e.message + '</p>'; }
        }

        // FORMULAIRES
        document.getElementById('formEnseignant').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = { 
                    acronyme: document.getElementById('ens_acronyme').value.toUpperCase(), 
                    nom: document.getElementById('ens_nom').value, 
                    prenom: document.getElementById('ens_prenom').value, 
                    email: document.getElementById('ens_email').value || null,
                    charge_max: parseInt(document.getElementById('ens_charge_max').value) || 0
                };
                const response = await fetch(`${API_BASE}/enseignants`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                const result = await response.json();
                if (result.success) { showAlert('âœ… Enseignant ajoutÃ© !', 'success'); e.target.reset(); loadEnseignantsForSelects(); }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        });

        document.getElementById('formClasse').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = { nom: document.getElementById('classe_nom').value, niveau: document.getElementById('classe_niveau').value || null };
                const response = await fetch(`${API_BASE}/classes`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                const result = await response.json();
                if (result.success) { showAlert('âœ… Classe ajoutÃ©e !', 'success'); e.target.reset(); loadClassesForSelects(); }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        });

        document.getElementById('formSalle').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = { 
                    nom: document.getElementById('salle_nom').value, 
                    capacite: parseInt(document.getElementById('salle_capacite').value) || 25,
                    type_salle: document.getElementById('salle_type').value || null
                };
                const response = await fetch(`${API_BASE}/salles`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                const result = await response.json();
                if (result.success) { showAlert('âœ… Salle ajoutÃ©e !', 'success'); e.target.reset(); }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        });

        document.getElementById('formEleve').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = { nom: document.getElementById('eleve_nom').value, prenom: document.getElementById('eleve_prenom').value, classe_id: parseInt(document.getElementById('eleve_classe').value) };
                const response = await fetch(`${API_BASE}/eleves`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                const result = await response.json();
                if (result.success) { showAlert('âœ… Ã‰lÃ¨ve ajoutÃ© !', 'success'); e.target.reset(); chargerTousEleves(); }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        });

        // FORMULAIRE THEME
        document.getElementById('formTheme').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = { 
                    nom: document.getElementById('theme_nom').value, 
                    couleur: document.getElementById('theme_couleur').value,
                    icone: document.getElementById('theme_icone').value || 'ğŸ¨',
                    description: document.getElementById('theme_description').value || null
                };
                const response = await fetch('/api/admin/themes', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, 
                    body: JSON.stringify(data) 
                });
                const result = await response.json();
                if (result.success) { 
                    showAlert('âœ… ThÃ¨me ajoutÃ© !', 'success'); 
                    e.target.reset(); 
                    document.getElementById('theme_couleur').value = '#667eea';
                    document.getElementById('theme_icone').value = 'ğŸ¨';
                    loadListe('themes');
                }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        });

        // FORMULAIRE TYPE SALLE
        document.getElementById('formTypeSalle').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = { 
                    nom: document.getElementById('type_salle_nom').value, 
                    description: document.getElementById('type_salle_description').value || null
                };
                const response = await fetch('/api/admin/types-salles', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, 
                    body: JSON.stringify(data) 
                });
                const result = await response.json();
                if (result.success) { 
                    showAlert('âœ… Type de salle ajoutÃ© !', 'success'); 
                    e.target.reset(); 
                    loadListe('types_salles');
                    loadTypesSalles();
                }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        });

        // CRUD ENSEIGNANTS
        async function editEnseignant(id, acronyme, nom, prenom, email, chargeMax) {
            // CrÃ©er un formulaire modal simple
            const newNom = prompt('Nom:', nom);
            if (newNom === null) return;
            const newPrenom = prompt('PrÃ©nom:', prenom);
            if (newPrenom === null) return;
            const newEmail = prompt('Email:', email);
            const newChargeMax = prompt('Charge max (pÃ©riodes, 0 = illimitÃ©):', chargeMax);
            if (newChargeMax === null) return;
            
            try {
                const response = await fetch(`${API_BASE}/enseignant/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ 
                        nom: newNom || nom, 
                        prenom: newPrenom || prenom, 
                        email: newEmail || null,
                        charge_max: parseInt(newChargeMax) || 0
                    })
                });
                const result = await response.json();
                if (result.success) { 
                    showAlert('âœ… Enseignant modifiÃ©', 'success'); 
                    loadListe('enseignants'); 
                }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur: ' + e.message, 'error'); }
        }

        async function voirDisponibilites(enseignantId, acronyme) {
            try {
                // Charger les crÃ©neaux et disponibilitÃ©s
                const [creneauxRes, dispoRes] = await Promise.all([
                    fetch('/api/planning/creneaux', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${API_BASE}/enseignant/${enseignantId}/disponibilites`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);
                
                const creneaux = (await creneauxRes.json()).data || [];
                const disponibilites = (await dispoRes.json()).data || [];
                const dispoSet = new Set(disponibilites.filter(d => d.disponible).map(d => d.creneau_id));
                
                // Organiser par jour
                const jours = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi'];
                let html = `<h3>ğŸ“… DisponibilitÃ©s de ${acronyme}</h3>
                    <p style="color:#666;margin-bottom:15px;">Cliquez sur un crÃ©neau pour basculer sa disponibilitÃ©</p>
                    <table style="width:100%;"><thead><tr><th>Jour</th><th>CrÃ©neaux</th></tr></thead><tbody>`;
                
                jours.forEach(jour => {
                    const creneauxJour = creneaux.filter(c => c.jour === jour);
                    html += `<tr><td><strong>${jour.charAt(0).toUpperCase() + jour.slice(1)}</strong></td><td>`;
                    creneauxJour.forEach(c => {
                        const isDispo = dispoSet.has(c.id);
                        const bgColor = isDispo ? '#d1fae5' : '#fee2e2';
                        const icon = isDispo ? 'âœ…' : 'âŒ';
                        html += `<button onclick="toggleDisponibilite(${enseignantId}, ${c.id}, ${isDispo}, '${acronyme}')" 
                            style="margin:2px;padding:5px 10px;border:none;border-radius:5px;background:${bgColor};cursor:pointer;">
                            ${icon} ${c.periode}
                        </button>`;
                    });
                    html += '</td></tr>';
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-top:15px;">
                    <button class="btn btn-success" onclick="setAllDisponibilites(${enseignantId}, true, '${acronyme}')">âœ… Tout disponible</button>
                    <button class="btn btn-danger" onclick="setAllDisponibilites(${enseignantId}, false, '${acronyme}')">âŒ Tout indisponible</button>
                    <button class="btn btn-secondary" onclick="loadListe('enseignants')">â† Retour</button>
                </div>`;
                
                document.getElementById('listeContainer').innerHTML = html;
            } catch (e) { 
                showAlert('âŒ Erreur: ' + e.message, 'error'); 
            }
        }

        async function toggleDisponibilite(enseignantId, creneauId, currentState, acronyme) {
            try {
                const response = await fetch(`${API_BASE}/enseignant/${enseignantId}/disponibilite`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ creneau_id: creneauId, disponible: !currentState })
                });
                const result = await response.json();
                if (result.success) {
                    voirDisponibilites(enseignantId, acronyme);
                } else {
                    showAlert('âŒ ' + result.message, 'error');
                }
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        }

        async function setAllDisponibilites(enseignantId, disponible, acronyme) {
            try {
                const response = await fetch(`${API_BASE}/enseignant/${enseignantId}/disponibilites/all`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ disponible })
                });
                const result = await response.json();
                if (result.success) {
                    showAlert('âœ… DisponibilitÃ©s mises Ã  jour', 'success');
                    voirDisponibilites(enseignantId, acronyme);
                } else {
                    showAlert('âŒ ' + result.message, 'error');
                }
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        }

        // CRUD THEMES
        async function editTheme(id, nom, couleur, icone, description) {
            const newNom = prompt('Nom du thÃ¨me:', nom);
            if (!newNom) return;
            const newCouleur = prompt('Couleur (hex):', couleur) || couleur;
            const newIcone = prompt('IcÃ´ne:', icone) || icone;
            const newDesc = prompt('Description:', description);
            
            try {
                const response = await fetch(`/api/admin/themes/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ nom: newNom, couleur: newCouleur, icone: newIcone, description: newDesc })
                });
                const result = await response.json();
                if (result.success) { showAlert('âœ… ThÃ¨me modifiÃ©', 'success'); loadListe('themes'); }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        }

        async function deleteTheme(id, nom) {
            if (!confirm(`Supprimer le thÃ¨me "${nom}" ?`)) return;
            try {
                const response = await fetch(`/api/admin/themes/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                if (result.success) { showAlert('âœ… ThÃ¨me supprimÃ©', 'success'); loadListe('themes'); }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        }

        // CRUD TYPES SALLES
        async function editTypeSalle(id, nom, description) {
            const newNom = prompt('Nom du type de salle:', nom);
            if (!newNom) return;
            const newDesc = prompt('Description:', description);
            
            try {
                const response = await fetch(`/api/admin/types-salles/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ nom: newNom, description: newDesc })
                });
                const result = await response.json();
                if (result.success) { showAlert('âœ… Type de salle modifiÃ©', 'success'); loadListe('types_salles'); loadTypesSalles(); }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        }

        async function deleteTypeSalle(id, nom) {
            if (!confirm(`Supprimer le type de salle "${nom}" ?`)) return;
            try {
                const response = await fetch(`/api/admin/types-salles/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                if (result.success) { showAlert('âœ… Type de salle supprimÃ©', 'success'); loadListe('types_salles'); loadTypesSalles(); }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        }

        // CRUD ELEVES
        async function editEleve(id, nom, prenom, classeId) {
            const newNom = prompt('Nom:', nom);
            if (!newNom) return;
            const newPrenom = prompt('PrÃ©nom:', prenom);
            if (!newPrenom) return;
            
            // Charger les classes pour le choix
            const classesResp = await fetch(`${API_BASE}/classes`, { headers: { 'Authorization': `Bearer ${token}` } });
            const classesData = await classesResp.json();
            const classesStr = classesData.data.map(c => `${c.id}: ${c.nom}`).join('\n');
            const newClasseId = prompt(`Classe actuelle: ${classeId}\n\nClasses disponibles:\n${classesStr}\n\nEntrez l'ID de la nouvelle classe:`, classeId);
            if (!newClasseId) return;
            
            try {
                const response = await fetch(`${API_BASE}/eleves/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ nom: newNom, prenom: newPrenom, classe_id: parseInt(newClasseId) })
                });
                const result = await response.json();
                if (result.success) { showAlert('âœ… Ã‰lÃ¨ve modifiÃ©', 'success'); loadListe('eleves'); chargerTousEleves(); }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        }

        async function deleteEleve(id, nom) {
            if (!confirm(`Supprimer l'Ã©lÃ¨ve "${nom}" ?\n\nâš ï¸ Ses inscriptions seront Ã©galement supprimÃ©es.`)) return;
            try {
                const response = await fetch(`${API_BASE}/eleves/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                if (result.success) { showAlert('âœ… Ã‰lÃ¨ve supprimÃ©', 'success'); loadListe('eleves'); chargerTousEleves(); }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        }

        // CRUD CLASSES
        async function editClasse(id, nom, niveau) {
            const newNom = prompt('Nom de la classe:', nom);
            if (!newNom) return;
            const newNiveau = prompt('Niveau (9, 10, 11...):', niveau);
            
            try {
                const response = await fetch(`${API_BASE}/classes/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ nom: newNom, niveau: newNiveau || null })
                });
                const result = await response.json();
                if (result.success) { showAlert('âœ… Classe modifiÃ©e', 'success'); loadListe('classes'); }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        }

        async function deleteClasse(id, nom) {
            if (!confirm(`Supprimer la classe "${nom}" ?\n\nâš ï¸ Les Ã©lÃ¨ves de cette classe seront aussi supprimÃ©s !`)) return;
            if (!confirm(`ATTENTION: Tous les Ã©lÃ¨ves de ${nom} seront DÃ‰FINITIVEMENT supprimÃ©s. Continuer ?`)) return;
            try {
                const response = await fetch(`${API_BASE}/classes/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                if (result.success) { showAlert('âœ… Classe supprimÃ©e', 'success'); loadListe('classes'); }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        }

        // CRUD SALLES
        async function editSalle(id, nom, capacite, typeSalle, disponible) {
            const newNom = prompt('Nom de la salle:', nom);
            if (!newNom) return;
            const newCapacite = prompt('CapacitÃ©:', capacite);
            if (!newCapacite) return;
            
            // Charger les types de salles
            const typesResp = await fetch('/api/admin/types-salles', { headers: { 'Authorization': `Bearer ${token}` } });
            const typesData = await typesResp.json();
            const typesStr = typesData.data.map(t => t.nom).join(', ');
            const newType = prompt(`Type actuel: ${typeSalle || 'aucun'}\n\nTypes disponibles: ${typesStr}\n\nNouveau type (laisser vide pour aucun):`, typeSalle);
            
            const newDispo = confirm('La salle est-elle disponible ?');
            
            try {
                const response = await fetch(`${API_BASE}/salles/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ nom: newNom, capacite: parseInt(newCapacite), type_salle: newType || null, disponible: newDispo })
                });
                const result = await response.json();
                if (result.success) { showAlert('âœ… Salle modifiÃ©e', 'success'); loadListe('salles'); }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        }

        async function deleteSalle(id, nom) {
            if (!confirm(`Supprimer la salle "${nom}" ?`)) return;
            try {
                const response = await fetch(`${API_BASE}/salles/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                if (result.success) { showAlert('âœ… Salle supprimÃ©e', 'success'); loadListe('salles'); }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        }

        // Charger les types de salles pour le select du formulaire salle
        async function loadTypesSalles() {
            try {
                const response = await fetch('/api/admin/types-salles', { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                const select = document.getElementById('salle_type');
                if (select) {
                    select.innerHTML = '<option value="">-- Aucun type --</option>';
                    result.data.forEach(t => {
                        select.innerHTML += `<option value="${t.nom}">${t.nom}</option>`;
                    });
                }
            } catch (e) { console.error('Erreur chargement types salles:', e); }
        }

        // RECHERCHE Ã‰LÃˆVES
        async function chargerTousEleves() {
            try {
                const response = await fetch(`${API_BASE}/eleves`, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                tousLesEleves = result.data || [];
            } catch (e) { console.error(e); }
        }

        function rechercherEleves() {
            const terme = document.getElementById('rechercheEleve').value.toLowerCase().trim();
            const container = document.getElementById('resultatsRecherche');
            if (terme.length < 2) { container.innerHTML = '<p style="padding:10px;color:#666;">Tapez 2+ caractÃ¨res</p>'; return; }
            const resultats = tousLesEleves.filter(e => e.nom.toLowerCase().includes(terme) || e.prenom.toLowerCase().includes(terme)).slice(0, 15);
            if (resultats.length === 0) { container.innerHTML = '<p style="padding:10px;color:#666;">Aucun rÃ©sultat</p>'; return; }
            let html = '';
            resultats.forEach(e => {
                const selected = elevesSelectionnesIds.has(e.id);
                html += `<div style="padding:8px;border-bottom:1px solid #eee;cursor:pointer;${selected ? 'background:#d1fae5;' : ''}" onclick="toggleEleve(${e.id})">${selected ? 'âœ…' : 'â¬œ'} <strong>${e.nom}</strong> ${e.prenom} <small>(${e.classe_nom || '?'})</small></div>`;
            });
            container.innerHTML = html;
        }

        function toggleEleve(id) {
            if (elevesSelectionnesIds.has(id)) elevesSelectionnesIds.delete(id);
            else elevesSelectionnesIds.add(id);
            rechercherEleves();
            afficherElevesSelectionnes();
        }

        function afficherElevesSelectionnes() {
            const container = document.getElementById('elevesSelectionnes');
            if (elevesSelectionnesIds.size === 0) { container.innerHTML = '<p style="color:#666;">Aucun</p>'; return; }
            const selected = tousLesEleves.filter(e => elevesSelectionnesIds.has(e.id));
            let html = '';
            selected.forEach(e => html += `<span style="display:inline-block;background:#667eea;color:white;padding:2px 8px;border-radius:12px;margin:2px;font-size:11px;">${e.prenom} ${e.nom} <span onclick="toggleEleve(${e.id})" style="cursor:pointer;">Ã—</span></span>`);
            container.innerHTML = html;
        }

        // INSCRIPTIONS
        document.getElementById('formInscrireClasse').addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultDiv = document.getElementById('resultatInscrClasse');
            try {
                const data = { planning_id: parseInt(document.getElementById('inscr_planning_classe').value), classe_id: parseInt(document.getElementById('inscr_classe').value) };
                resultDiv.innerHTML = '<p>â³ Inscription...</p>';
                const response = await fetch(`${API_BASE}/inscriptions-classe`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                const result = await response.json();
                if (result.success) { resultDiv.innerHTML = `<div style="padding:10px;background:#d1fae5;border-radius:8px;">âœ… ${result.message}</div>`; loadPlanningsForSelects(); }
                else resultDiv.innerHTML = `<div style="padding:10px;background:#fee2e2;border-radius:8px;">âŒ ${result.message}</div>`;
            } catch (e) { resultDiv.innerHTML = '<div style="padding:10px;background:#fee2e2;border-radius:8px;">âŒ Erreur</div>'; }
        });

        document.getElementById('formInscrireEleves').addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultDiv = document.getElementById('resultatInscrEleves');
            if (elevesSelectionnesIds.size === 0) { resultDiv.innerHTML = '<div style="padding:10px;background:#fef3c7;border-radius:8px;">âš ï¸ SÃ©lectionnez des Ã©lÃ¨ves</div>'; return; }
            try {
                const data = { planning_id: parseInt(document.getElementById('inscr_planning_eleves').value), eleve_ids: Array.from(elevesSelectionnesIds) };
                resultDiv.innerHTML = '<p>â³ Inscription...</p>';
                const response = await fetch(`${API_BASE}/inscriptions-eleves`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                const result = await response.json();
                if (result.success) {
                    let msg = `âœ… ${result.message}`;
                    if (result.data.conflits && result.data.conflits.length > 0) {
                        msg += `<br><small style="color:#92400e;">âš ï¸ ${result.data.conflits.length} conflits</small>`;
                    }
                    resultDiv.innerHTML = `<div style="padding:10px;background:#d1fae5;border-radius:8px;">${msg}</div>`;
                    elevesSelectionnesIds.clear(); afficherElevesSelectionnes();
                    document.getElementById('rechercheEleve').value = '';
                    document.getElementById('resultatsRecherche').innerHTML = '';
                    loadPlanningsForSelects();
                } else resultDiv.innerHTML = `<div style="padding:10px;background:#fee2e2;border-radius:8px;">âŒ ${result.message}</div>`;
            } catch (e) { resultDiv.innerHTML = '<div style="padding:10px;background:#fee2e2;border-radius:8px;">âŒ Erreur</div>'; }
        });

        // PIQUET
        document.getElementById('formPiquet').addEventListener('submit', async (e) => {
            e.preventDefault();
            const utilisateur_id = document.getElementById('piquet_enseignant').value;
            const creneau_id = document.getElementById('piquet_creneau').value;
            if (!utilisateur_id || !creneau_id) { showAlert('âŒ Enseignant et crÃ©neau requis', 'error'); return; }
            try {
                const data = { utilisateur_id: parseInt(utilisateur_id), creneau_id: parseInt(creneau_id), type: document.getElementById('piquet_type').value, commentaire: document.getElementById('piquet_commentaire').value || null };
                const response = await fetch(`${API_BASE}/piquet`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                const result = await response.json();
                if (result.success) { showAlert('âœ… ' + result.message, 'success'); e.target.reset(); loadPiquetListe(); }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        });

        async function loadPiquetListe() {
            try {
                const response = await fetch(`${API_BASE}/piquet`, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                if (result.data.length === 0) { document.getElementById('piquetListe').innerHTML = '<p style="color:#666;">Aucun</p>'; return; }
                let html = '<table><thead><tr><th>Enseignant</th><th>CrÃ©neau</th><th>Type</th><th>Commentaire</th><th></th></tr></thead><tbody>';
                result.data.forEach(p => {
                    const jour = p.jour.charAt(0).toUpperCase() + p.jour.slice(1);
                    const typeLabel = p.type === 'degagement' ? '<span class="badge badge-blue">DÃ©gagement</span>' : '<span class="badge badge-yellow">Piquet</span>';
                    html += `<tr><td>${p.enseignant_prenom} ${p.enseignant_nom}</td><td>${jour} ${p.periode}</td><td>${typeLabel}</td><td>${p.commentaire || '-'}</td><td><button class="btn btn-danger btn-sm" onclick="deletePiquet(${p.id})">ğŸ—‘ï¸</button></td></tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('piquetListe').innerHTML = html;
            } catch (e) { document.getElementById('piquetListe').innerHTML = '<p style="color:red;">Erreur</p>'; }
        }

        async function deletePiquet(id) {
            if (!confirm('Supprimer ?')) return;
            try {
                const response = await fetch(`${API_BASE}/piquet/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                if (result.success) { showAlert('âœ… SupprimÃ©', 'success'); loadPiquetListe(); }
                else showAlert('âŒ ' + result.message, 'error');
            } catch (e) { showAlert('âŒ Erreur', 'error'); }
        }

        // Ã‰LÃˆVES PAR CRÃ‰NEAU
        async function loadElevesCreneaux() {
            const container = document.getElementById('elevesCreneauxContainer');
            const jour = document.getElementById('filtre_jour').value;
            const classeId = document.getElementById('filtre_classe_eleves').value;
            try {
                let url = `${API_BASE}/tous-eleves-creneaux?`;
                if (jour) url += `jour=${jour}&`;
                if (classeId) url += `classe_id=${classeId}&`;
                container.innerHTML = '<p>â³ Chargement...</p>';
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                if (result.data.length === 0) { container.innerHTML = '<p style="color:#666;">Aucune inscription</p>'; return; }
                const parCreneau = {};
                result.data.forEach(i => {
                    const key = `${i.jour}_${i.periode}`;
                    if (!parCreneau[key]) parCreneau[key] = { jour: i.jour, periode: i.periode, eleves: [] };
                    parCreneau[key].eleves.push(i);
                });
                let html = '';
                Object.values(parCreneau).forEach(creneau => {
                    const jour = creneau.jour.charAt(0).toUpperCase() + creneau.jour.slice(1);
                    html += `<div style="margin-bottom:20px;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;"><div style="background:#667eea;color:white;padding:10px 15px;font-weight:600;">${jour} ${creneau.periode} - ${creneau.eleves.length} Ã©lÃ¨ves</div><table style="margin:0;"><thead><tr><th>Ã‰lÃ¨ve</th><th>Classe</th><th>Atelier</th><th>Salle</th></tr></thead><tbody>`;
                    creneau.eleves.forEach(e => html += `<tr><td>${e.eleve_nom} ${e.eleve_prenom}</td><td>${e.classe_nom}</td><td>${e.atelier_nom}</td><td>${e.salle_nom || '-'}</td></tr>`);
                    html += '</tbody></table></div>';
                });
                container.innerHTML = html;
            } catch (e) { container.innerHTML = '<p style="color:red;">Erreur</p>'; }
        }

        // CRÃ‰NEAUX FAIBLES
        async function loadCreneauxFaibles() {
            const container = document.getElementById('creneauxFaiblesContainer');
            const seuil = document.getElementById('seuil_faibles').value || 5;
            try {
                container.innerHTML = '<p>â³ Chargement...</p>';
                const response = await fetch(`${API_BASE}/creneaux-faibles?seuil=${seuil}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                if (result.data.length === 0) { container.innerHTML = `<p style="color:#10b981;">âœ… Aucun crÃ©neau avec moins de ${seuil} inscriptions</p>`; return; }
                let html = `<p style="margin-bottom:15px;"><strong>${result.data.length}</strong> crÃ©neaux</p><table><thead><tr><th>Atelier</th><th>Jour</th><th>PÃ©riode</th><th>Inscrits</th><th>Dispo</th></tr></thead><tbody>`;
                result.data.forEach(c => {
                    const jour = c.jour.charAt(0).toUpperCase() + c.jour.slice(1);
                    const badge = c.nb_inscrits === 0 ? '<span class="badge badge-red">0</span>' : `<span class="badge badge-yellow">${c.nb_inscrits}</span>`;
                    html += `<tr><td><strong>${c.atelier_nom}</strong></td><td>${jour}</td><td>${c.periode}</td><td>${badge}</td><td>${c.places_restantes}</td></tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (e) { container.innerHTML = '<p style="color:red;">Erreur</p>'; }
        }

        // ========== GESTION INSCRIPTIONS Ã‰LÃˆVES ==========
        let currentEleveId = null;
        let allPlanningsAdmin = [];
        
        async function rechercherEleveAdmin() {
            const terme = document.getElementById('searchEleve').value.trim();
            const container = document.getElementById('resultatsRechercheEleve');
            
            if (terme.length < 2) {
                container.innerHTML = '<p style="padding:10px;color:#666;">Tapez au moins 2 caractÃ¨res</p>';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/recherche-eleve?q=${encodeURIComponent(terme)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                if (result.data.length === 0) {
                    container.innerHTML = '<p style="padding:10px;color:#666;">Aucun Ã©lÃ¨ve trouvÃ©</p>';
                    return;
                }
                
                let html = '';
                result.data.forEach(e => {
                    const valideBadge = e.inscriptions_validees 
                        ? '<span class="badge badge-green" style="margin-left:5px;">âœ“ ValidÃ©</span>' 
                        : '<span class="badge badge-yellow" style="margin-left:5px;">Non validÃ©</span>';
                    html += `<div style="padding:10px;border-bottom:1px solid #eee;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="chargerInscriptionsEleve(${e.eleve_id})">
                        <span><strong>${e.nom} ${e.prenom}</strong> <small>(${e.classe_nom})</small></span>
                        ${valideBadge}
                    </div>`;
                });
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = '<p style="padding:10px;color:red;">Erreur</p>';
            }
        }
        
        async function chargerInscriptionsEleve(eleveId) {
            currentEleveId = eleveId;
            
            try {
                const response = await fetch(`${API_BASE}/eleve/${eleveId}/inscriptions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                if (!result.success) {
                    showAlert('âŒ ' + result.message, 'error');
                    return;
                }
                
                const { eleve, inscriptions } = result.data;
                
                // Header
                const valideBadge = eleve.inscriptions_validees 
                    ? '<span class="badge badge-green">âœ“ Inscriptions validÃ©es</span>' 
                    : '<span class="badge badge-yellow">Non validÃ©es</span>';
                document.getElementById('eleveInfoHeader').innerHTML = `
                    <h3>${eleve.prenom} ${eleve.nom}</h3>
                    <p>Classe: <strong>${eleve.classe_nom}</strong> ${valideBadge}</p>
                    ${eleve.date_validation ? `<p style="font-size:12px;color:#666;">ValidÃ© le: ${new Date(eleve.date_validation).toLocaleDateString('fr-CH')}</p>` : ''}
                `;
                
                // Bouton dÃ©-valider
                document.getElementById('btnDevalider').style.display = eleve.inscriptions_validees ? 'inline-block' : 'none';
                
                // Liste inscriptions
                if (inscriptions.length === 0) {
                    document.getElementById('eleveInscriptionsListe').innerHTML = '<p style="color:#666;">Aucune inscription</p>';
                } else {
                    let html = '<table><thead><tr><th>Atelier</th><th>Jour</th><th>PÃ©riode</th><th>Salle</th><th></th></tr></thead><tbody>';
                    inscriptions.forEach(i => {
                        const jour = i.jour.charAt(0).toUpperCase() + i.jour.slice(1);
                        const manuelBadge = i.inscription_manuelle ? ' <span class="badge badge-blue">Admin</span>' : '';
                        html += `<tr>
                            <td><strong>${i.atelier_nom}</strong>${manuelBadge}</td>
                            <td>${jour}</td>
                            <td>${i.periode}</td>
                            <td>${i.salle_nom || '-'}</td>
                            <td><button class="btn btn-danger btn-sm" onclick="supprimerInscription(${i.inscription_id}, '${i.atelier_nom.replace(/'/g, "\\'")}')">ğŸ—‘ï¸</button></td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    document.getElementById('eleveInscriptionsListe').innerHTML = html;
                }
                
                document.getElementById('eleveInscriptionsContainer').style.display = 'block';
                
                // Charger les crÃ©neaux pour modal
                await loadPlanningsAdmin();
            } catch (e) {
                showAlert('âŒ Erreur', 'error');
            }
        }
        
        async function loadPlanningsAdmin() {
            try {
                const response = await fetch(`${API_BASE}/ateliers-planifies`, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                allPlanningsAdmin = result.data || [];
                updatePlanningsAdminSelect(allPlanningsAdmin);
            } catch (e) { console.error(e); }
        }
        
        function updatePlanningsAdminSelect(plannings) {
            const select = document.getElementById('adminInscriptionCreneau');
            select.innerHTML = '<option value="">-- SÃ©lectionner --</option>';
            plannings.forEach(p => {
                const jour = p.jour.charAt(0).toUpperCase() + p.jour.slice(1);
                const places = p.nombre_places_max - p.nb_inscrits;
                select.innerHTML += `<option value="${p.planning_id}">${p.atelier_nom} - ${jour} ${p.periode} (${places} places)</option>`;
            });
        }
        
        function filterCreneauxAdmin() {
            const term = document.getElementById('searchCreneauAdmin').value.toLowerCase().trim();
            if (term.length === 0) {
                updatePlanningsAdminSelect(allPlanningsAdmin);
                return;
            }
            const filtered = allPlanningsAdmin.filter(p => p.atelier_nom.toLowerCase().includes(term));
            updatePlanningsAdminSelect(filtered);
        }
        
        function showAjouterInscription() {
            document.getElementById('modalAjouterInscr').style.display = 'flex';
        }
        
        function hideAjouterInscription() {
            document.getElementById('modalAjouterInscr').style.display = 'none';
        }
        
        async function ajouterInscriptionAdmin() {
            const planningId = document.getElementById('adminInscriptionCreneau').value;
            const notifier = document.getElementById('adminNotifier').checked;
            
            if (!planningId) {
                showAlert('âŒ SÃ©lectionnez un crÃ©neau', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/eleve/${currentEleveId}/inscription`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ planning_id: parseInt(planningId), notifier })
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert('âœ… ' + result.message, 'success');
                    hideAjouterInscription();
                    chargerInscriptionsEleve(currentEleveId);
                } else {
                    showAlert('âŒ ' + result.message, 'error');
                }
            } catch (e) {
                showAlert('âŒ Erreur', 'error');
            }
        }
        
        async function supprimerInscription(inscriptionId, atelierNom) {
            if (!confirm(`Supprimer l'inscription Ã  "${atelierNom}" ?\nL'Ã©lÃ¨ve sera notifiÃ©.`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/inscription/${inscriptionId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ notifier: true })
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert('âœ… Inscription supprimÃ©e', 'success');
                    chargerInscriptionsEleve(currentEleveId);
                } else {
                    showAlert('âŒ ' + result.message, 'error');
                }
            } catch (e) {
                showAlert('âŒ Erreur', 'error');
            }
        }
        
        async function devaliderEleve() {
            if (!confirm('DÃ©-valider les inscriptions de cet Ã©lÃ¨ve ?\nIl pourra Ã  nouveau modifier ses inscriptions.')) return;
            
            try {
                const response = await fetch(`${API_BASE}/eleve/${currentEleveId}/devalider`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ notifier: true })
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert('âœ… Inscriptions dÃ©-validÃ©es', 'success');
                    chargerInscriptionsEleve(currentEleveId);
                } else {
                    showAlert('âŒ ' + result.message, 'error');
                }
            } catch (e) {
                showAlert('âŒ Erreur', 'error');
            }
        }

        // ========== RESET MOT DE PASSE ==========
        async function resetPasswordEnseignant(id, acronyme) {
            if (!confirm(`RÃ©initialiser le mot de passe de ${acronyme} ?\n\nNouveau mot de passe: ${acronyme.toLowerCase()}`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/enseignant/${id}/reset-password`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`âœ… ${result.message}\nNouveau mot de passe: ${result.new_password}`, 'success');
                } else {
                    showAlert('âŒ ' + result.message, 'error');
                }
            } catch (e) {
                showAlert('âŒ Erreur', 'error');
            }
        }

        async function resetPasswordEleve(eleveId, nom) {
            if (!confirm(`RÃ©initialiser le mot de passe de ${nom} ?\n\nNouveau mot de passe: eleve2026`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/eleve/${eleveId}/reset-password`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`âœ… ${result.message}\nNouveau mot de passe: ${result.new_password}`, 'success');
                } else {
                    showAlert('âŒ ' + result.message, 'error');
                }
            } catch (e) {
                showAlert('âŒ Erreur', 'error');
            }
        }

        async function resetAllPasswords(type) {
            const typeLabel = type === 'enseignants' ? 'enseignants (acronyme en minuscules)' : 'Ã©lÃ¨ves (eleve2026)';
            if (!confirm(`âš ï¸ ATTENTION: RÃ©initialiser TOUS les mots de passe des ${typeLabel} ?`)) return;
            if (!confirm('ÃŠtes-vous vraiment sÃ»r ?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/reset-all-passwords`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ type })
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`âœ… ${result.message}`, 'success');
                } else {
                    showAlert('âŒ ' + result.message, 'error');
                }
            } catch (e) {
                showAlert('âŒ Erreur', 'error');
            }
        }

        // ========== MODAL AJOUT ==========
        let currentAddType = '';
        
        function showAddModal(type) {
            currentAddType = type;
            let title = '', content = '';
            
            if (type === 'enseignant') {
                title = 'ğŸ‘¨â€ğŸ« Ajouter un enseignant';
                content = `
                    <div class="form-group"><label>Acronyme *</label><input type="text" id="modal_acronyme" required></div>
                    <div class="form-group"><label>Nom *</label><input type="text" id="modal_nom" required></div>
                    <div class="form-group"><label>PrÃ©nom *</label><input type="text" id="modal_prenom" required></div>
                    <div class="form-group"><label>Email</label><input type="email" id="modal_email"></div>
                    <div class="form-group"><label>Charge max (pÃ©riodes)</label><input type="number" id="modal_charge" min="0" value="0"></div>
                `;
            } else if (type === 'eleve') {
                title = 'ğŸ“ Ajouter un Ã©lÃ¨ve';
                content = `
                    <div class="form-group"><label>Nom *</label><input type="text" id="modal_nom" required></div>
                    <div class="form-group"><label>PrÃ©nom *</label><input type="text" id="modal_prenom" required></div>
                    <div class="form-group"><label>Classe *</label><select id="modal_classe" required></select></div>
                `;
                // Charger les classes
                setTimeout(async () => {
                    const resp = await fetch(`${API_BASE}/classes`, { headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await resp.json();
                    const sel = document.getElementById('modal_classe');
                    sel.innerHTML = '<option value="">-- Choisir --</option>' + data.data.map(c => `<option value="${c.id}">${c.nom}</option>`).join('');
                }, 100);
            } else if (type === 'classe') {
                title = 'ğŸ« Ajouter une classe';
                content = `
                    <div class="form-group"><label>Nom *</label><input type="text" id="modal_nom" required placeholder="ex: 9VP1"></div>
                    <div class="form-group"><label>Niveau</label><select id="modal_niveau"><option value="">--</option><option>9VP</option><option>9VG</option><option>10VP</option><option>10VG</option></select></div>
                `;
            } else if (type === 'salle') {
                title = 'ğŸšª Ajouter une salle';
                content = `
                    <div class="form-group"><label>Nom *</label><input type="text" id="modal_nom" required></div>
                    <div class="form-group"><label>CapacitÃ©</label><input type="number" id="modal_capacite" min="1" value="25"></div>
                    <div class="form-group"><label>Type de salle</label><select id="modal_type_salle"></select></div>
                `;
                setTimeout(async () => {
                    const resp = await fetch('/api/admin/types-salles', { headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await resp.json();
                    const sel = document.getElementById('modal_type_salle');
                    sel.innerHTML = '<option value="">-- Aucun --</option>' + data.data.map(t => `<option value="${t.nom}">${t.nom}</option>`).join('');
                }, 100);
            } else if (type === 'theme') {
                title = 'ğŸ¨ Ajouter un thÃ¨me';
                content = `
                    <div class="form-group"><label>Nom *</label><input type="text" id="modal_nom" required></div>
                    <div class="form-group"><label>IcÃ´ne</label><input type="text" id="modal_icone" placeholder="ğŸ¨"></div>
                    <div class="form-group"><label>Couleur</label><input type="color" id="modal_couleur" value="#667eea"></div>
                    <div class="form-group"><label>Description</label><textarea id="modal_description" rows="2"></textarea></div>
                `;
            } else if (type === 'type_salle') {
                title = 'ğŸ·ï¸ Ajouter un type de salle';
                content = `
                    <div class="form-group"><label>Nom *</label><input type="text" id="modal_nom" required></div>
                    <div class="form-group"><label>Description</label><textarea id="modal_description" rows="2"></textarea></div>
                `;
            }
            
            document.getElementById('addModalTitle').textContent = title;
            document.getElementById('addModalBody').innerHTML = content;
            document.getElementById('addModal').style.display = 'flex';
        }
        
        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
        }
        
        async function submitAddModal() {
            try {
                let url = '', data = {};
                
                if (currentAddType === 'enseignant') {
                    url = `${API_BASE}/enseignants`;
                    data = {
                        acronyme: document.getElementById('modal_acronyme').value.toUpperCase(),
                        nom: document.getElementById('modal_nom').value,
                        prenom: document.getElementById('modal_prenom').value,
                        email: document.getElementById('modal_email').value || null,
                        charge_max: parseInt(document.getElementById('modal_charge').value) || 0
                    };
                } else if (currentAddType === 'eleve') {
                    url = `${API_BASE}/eleves`;
                    data = {
                        nom: document.getElementById('modal_nom').value,
                        prenom: document.getElementById('modal_prenom').value,
                        classe_id: document.getElementById('modal_classe').value
                    };
                } else if (currentAddType === 'classe') {
                    url = `${API_BASE}/classes`;
                    data = {
                        nom: document.getElementById('modal_nom').value,
                        niveau: document.getElementById('modal_niveau').value || null
                    };
                } else if (currentAddType === 'salle') {
                    url = `${API_BASE}/salles`;
                    data = {
                        nom: document.getElementById('modal_nom').value,
                        capacite: parseInt(document.getElementById('modal_capacite').value) || 25,
                        type_salle: document.getElementById('modal_type_salle').value || null
                    };
                } else if (currentAddType === 'theme') {
                    url = '/api/admin/themes';
                    data = {
                        nom: document.getElementById('modal_nom').value,
                        icone: document.getElementById('modal_icone').value || null,
                        couleur: document.getElementById('modal_couleur').value,
                        description: document.getElementById('modal_description').value || null
                    };
                } else if (currentAddType === 'type_salle') {
                    url = '/api/admin/types-salles';
                    data = {
                        nom: document.getElementById('modal_nom').value,
                        description: document.getElementById('modal_description').value || null
                    };
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    closeAddModal();
                    showAlert('âœ… AjoutÃ© avec succÃ¨s', 'success');
                    // Recharger la liste correspondante
                    const typeMap = { 'enseignant': 'enseignants', 'eleve': 'eleves', 'classe': 'classes', 'salle': 'salles', 'theme': 'themes', 'type_salle': 'types_salles' };
                    loadListe(typeMap[currentAddType]);
                } else {
                    showAlert('âŒ ' + result.message, 'error');
                }
            } catch (e) {
                showAlert('âŒ Erreur: ' + e.message, 'error');
            }
        }

        // ========== CONFIGURATION SEMAINE ==========
        async function loadConfigSemaine() {
            try {
                const response = await fetch('/api/admin/parametres', { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await response.json();
                if (data.success) {
                    const params = data.data || [];
                    
                    // Dates
                    const dateDebut = params.find(p => p.cle === 'semaine_date_debut');
                    const dateFin = params.find(p => p.cle === 'semaine_date_fin');
                    const joursActifs = params.find(p => p.cle === 'semaine_jours_actifs');
                    
                    if (dateDebut) document.getElementById('semaineDebut').value = dateDebut.valeur;
                    if (dateFin) document.getElementById('semaineFin').value = dateFin.valeur;
                    
                    // Jours actifs
                    const jours = joursActifs ? joursActifs.valeur.split(',') : ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi'];
                    document.getElementById('jourLundi').checked = jours.includes('lundi');
                    document.getElementById('jourMardi').checked = jours.includes('mardi');
                    document.getElementById('jourMercredi').checked = jours.includes('mercredi');
                    document.getElementById('jourJeudi').checked = jours.includes('jeudi');
                    document.getElementById('jourVendredi').checked = jours.includes('vendredi');
                }
            } catch (e) {
                console.error('Erreur chargement config semaine:', e);
            }
        }
        
        async function sauvegarderConfigSemaine() {
            try {
                const dateDebut = document.getElementById('semaineDebut').value;
                const dateFin = document.getElementById('semaineFin').value;
                
                const joursActifs = [];
                if (document.getElementById('jourLundi').checked) joursActifs.push('lundi');
                if (document.getElementById('jourMardi').checked) joursActifs.push('mardi');
                if (document.getElementById('jourMercredi').checked) joursActifs.push('mercredi');
                if (document.getElementById('jourJeudi').checked) joursActifs.push('jeudi');
                if (document.getElementById('jourVendredi').checked) joursActifs.push('vendredi');
                
                if (joursActifs.length === 0) {
                    showAlert('âŒ Vous devez sÃ©lectionner au moins un jour', 'error');
                    return;
                }
                
                const response = await fetch('/api/gestion/config-semaine', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        date_debut: dateDebut,
                        date_fin: dateFin,
                        jours_actifs: joursActifs.join(',')
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('âœ… Configuration enregistrÃ©e', 'success');
                } else {
                    showAlert('âŒ ' + result.message, 'error');
                }
            } catch (e) {
                showAlert('âŒ Erreur: ' + e.message, 'error');
            }
        }

        // ========== QUOTAS ==========
        async function loadQuota() {
            try {
                const response = await fetch('/api/admin/configuration', { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await response.json();
                if (data.success) {
                    const quotaConfig = data.data.find(c => c.cle === 'quota_places_pourcent');
                    const quota = quotaConfig ? parseFloat(quotaConfig.valeur) : 100;
                    document.getElementById('quotaSlider').value = quota;
                    updateQuotaDisplay();
                }
            } catch (e) {
                console.error('Erreur chargement quota:', e);
            }
        }
        
        function updateQuotaDisplay() {
            const val = document.getElementById('quotaSlider').value;
            document.getElementById('quotaValue').textContent = val + '%';
        }
        
        async function saveQuota() {
            const quota = parseInt(document.getElementById('quotaSlider').value);
            try {
                const response = await fetch('/api/admin/configuration/quota', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ quota })
                });
                const data = await response.json();
                if (data.success) {
                    document.getElementById('quotaStatus').innerHTML = '<p style="color:#10b981;">âœ… Quota enregistrÃ©: ' + quota + '%</p>';
                } else {
                    document.getElementById('quotaStatus').innerHTML = '<p style="color:#ef4444;">âŒ ' + data.message + '</p>';
                }
            } catch (e) {
                document.getElementById('quotaStatus').innerHTML = '<p style="color:#ef4444;">âŒ Erreur</p>';
            }
        }

        // ========== INSCRIPTIONS CLASSES ==========
        async function loadClassesInscriptions() {
            try {
                const response = await fetch(`${API_BASE}/classes`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await response.json();
                
                let html = '<table><thead><tr><th>Classe</th><th>Niveau</th><th>Ã‰lÃ¨ves</th><th>Inscriptions</th><th>Action</th></tr></thead><tbody>';
                data.data.forEach(c => {
                    const ouvert = c.inscriptions_ouvertes;
                    const statusBadge = ouvert 
                        ? '<span class="badge" style="background:#d1fae5;color:#065f46;">Ouvertes</span>'
                        : '<span class="badge" style="background:#fee2e2;color:#991b1b;">FermÃ©es</span>';
                    const btnAction = ouvert
                        ? `<button class="btn btn-sm btn-danger" onclick="toggleInscriptionClasse(${c.id}, false)">ğŸ”’ Fermer</button>`
                        : `<button class="btn btn-sm btn-success" onclick="toggleInscriptionClasse(${c.id}, true)">ğŸ”“ Ouvrir</button>`;
                    
                    html += `<tr>
                        <td><strong>${c.nom}</strong></td>
                        <td>${c.niveau || '-'}</td>
                        <td>${c.nombre_eleves}</td>
                        <td>${statusBadge}</td>
                        <td>${btnAction}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('classesInscriptionsContainer').innerHTML = html;
            } catch (e) {
                document.getElementById('classesInscriptionsContainer').innerHTML = '<p style="color:red;">Erreur</p>';
            }
        }
        
        async function toggleInscriptionClasse(classeId, ouvrir) {
            try {
                const response = await fetch(`${API_BASE}/classes/${classeId}/inscriptions`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ ouvertes: ouvrir })
                });
                const data = await response.json();
                if (data.success) {
                    loadClassesInscriptions();
                } else {
                    showAlert('âŒ ' + data.message, 'error');
                }
            } catch (e) {
                showAlert('âŒ Erreur', 'error');
            }
        }
        
        async function ouvrirToutesClasses() {
            if (!confirm('Ouvrir les inscriptions pour TOUTES les classes ?')) return;
            try {
                const response = await fetch(`${API_BASE}/classes/inscriptions/toutes`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ ouvertes: true })
                });
                loadClassesInscriptions();
                showAlert('âœ… Inscriptions ouvertes pour toutes les classes', 'success');
            } catch (e) {
                showAlert('âŒ Erreur', 'error');
            }
        }
        
        async function fermerToutesClasses() {
            if (!confirm('Fermer les inscriptions pour TOUTES les classes ?')) return;
            try {
                const response = await fetch(`${API_BASE}/classes/inscriptions/toutes`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ ouvertes: false })
                });
                loadClassesInscriptions();
                showAlert('âœ… Inscriptions fermÃ©es pour toutes les classes', 'success');
            } catch (e) {
                showAlert('âŒ Erreur', 'error');
            }
        }

        // Charger les donnÃ©es au switch d'onglet
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab(tabName);
            if (tabName === 'quotas') loadQuota();
            if (tabName === 'inscriptions-classes') loadClassesInscriptions();
            if (tabName === 'evaluations') loadEvaluationsAdmin();
            if (tabName === 'config-semaine') loadConfigSemaine();
            if (tabName === 'cloturer') initCloturer();
        };

        // ========== EVALUATIONS ==========
        async function loadEvaluationsAdmin() {
            // Charger le statut global
            try {
                const paramResp = await fetch('/api/admin/parametres', { headers: { 'Authorization': `Bearer ${token}` } });
                if (paramResp.ok) {
                    const paramData = await paramResp.json();
                    const evalOuvertes = paramData.data?.find(p => p.cle === 'evaluations_ouvertes')?.valeur === 'true';
                    updateEvalStatus(evalOuvertes);
                } else {
                    console.error('Erreur API parametres:', paramResp.status);
                    document.getElementById('evalStatus').textContent = 'âš ï¸ Erreur chargement';
                    document.getElementById('evalStatus').style.color = '#f59e0b';
                }
            } catch (e) {
                console.error('Erreur paramÃ¨tres:', e);
                document.getElementById('evalStatus').textContent = 'âš ï¸ Erreur connexion';
                document.getElementById('evalStatus').style.color = '#f59e0b';
            }
            
            // Charger les stats
            try {
                const statsResp = await fetch('/api/evaluations/admin/stats', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!statsResp.ok) {
                    throw new Error('Erreur API stats: ' + statsResp.status);
                }
                const statsData = await statsResp.json();
                
                if (statsData.success) {
                    const s = statsData.data.stats || {};
                    document.getElementById('evalStatsContainer').innerHTML = `
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <div><strong>${s.total_evaluations || 0}</strong> Ã©valuations</div>
                            <div><strong>${s.nb_eleves_evaluateurs || 0}</strong> Ã©lÃ¨ves</div>
                            <div><strong>${s.nb_ateliers_evalues || 0}</strong> ateliers</div>
                            <div>Moyenne: <strong>${s.moyenne_generale ? parseFloat(s.moyenne_generale).toFixed(1) : '-'}/6</strong></div>
                        </div>
                    `;
                    
                    // Top ateliers
                    const top = statsData.data.topAteliers || [];
                    if (top.length > 0) {
                        document.getElementById('evalTopContainer').innerHTML = top.map((a, i) => `
                            <div style="padding:5px 0; border-bottom:1px solid #e5e7eb;">
                                <span style="color:#667eea; font-weight:bold;">#${i+1}</span> ${a.nom} 
                                <span style="float:right; color:#f59e0b;">${parseFloat(a.moyenne).toFixed(1)}/6 (${a.nb})</span>
                            </div>
                        `).join('');
                    } else {
                        document.getElementById('evalTopContainer').innerHTML = '<p style="color:#9ca3af;">Pas encore d\'Ã©valuations</p>';
                    }
                } else {
                    throw new Error(statsData.message);
                }
            } catch (e) {
                console.error('Erreur stats:', e);
                document.getElementById('evalStatsContainer').innerHTML = '<p style="color:#ef4444;">Erreur: ' + e.message + '</p>';
                document.getElementById('evalTopContainer').innerHTML = '<p style="color:#ef4444;">Erreur chargement</p>';
            }
            
            // Charger les derniÃ¨res Ã©valuations
            try {
                const evalResp = await fetch('/api/evaluations/admin/toutes', { headers: { 'Authorization': `Bearer ${token}` } });
                const evalData = await evalResp.json();
                
                if (evalData.success && evalData.data.length > 0) {
                    let html = '<table><thead><tr><th>Ã‰lÃ¨ve</th><th>Atelier</th><th>Note</th><th>Commentaire</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
                    evalData.data.slice(0, 50).forEach(e => {
                        const stars = 'â˜…'.repeat(e.note) + 'â˜†'.repeat(6 - e.note);
                        const visibleBadge = e.visible ? '' : '<span class="badge badge-red">MasquÃ©</span>';
                        html += `<tr>
                            <td>${e.eleve_prenom} ${e.eleve_nom}</td>
                            <td>${e.atelier_nom || 'ArchivÃ©'}</td>
                            <td style="color:#f59e0b;">${stars}</td>
                            <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${e.commentaire || '-'}</td>
                            <td>${e.date_formatee} ${visibleBadge}</td>
                            <td>
                                <button class="btn btn-sm ${e.visible ? 'btn-secondary' : 'btn-success'}" onclick="modererEvaluation(${e.id}, ${!e.visible})">${e.visible ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}</button>
                                <button class="btn btn-sm btn-danger" onclick="supprimerEvaluation(${e.id})">ğŸ—‘ï¸</button>
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    document.getElementById('evalListContainer').innerHTML = html;
                } else {
                    document.getElementById('evalListContainer').innerHTML = '<p style="color:#9ca3af;">Aucune Ã©valuation</p>';
                }
            } catch (e) {
                console.error('Erreur liste:', e);
            }
        }
        
        function updateEvalStatus(ouvertes) {
            document.getElementById('evalStatus').textContent = ouvertes ? 'ğŸŸ¢ Ouvertes' : 'ğŸ”´ FermÃ©es';
            document.getElementById('evalStatus').style.color = ouvertes ? '#10b981' : '#ef4444';
        }
        
        async function toggleEvaluationsGlobal(ouvrir) {
            try {
                const response = await fetch('/api/evaluations/admin/parametres', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ evaluations_ouvertes: ouvrir })
                });
                const data = await response.json();
                if (data.success) {
                    updateEvalStatus(ouvrir);
                    showAlert(data.message, 'success');
                } else {
                    showAlert('Erreur: ' + (data.message || 'Impossible de modifier'), 'error');
                    console.error('Erreur toggle evaluations:', data);
                }
            } catch (e) {
                showAlert('Erreur de connexion: ' + e.message, 'error');
                console.error('Erreur toggle evaluations:', e);
            }
        }
        
        async function modererEvaluation(id, visible) {
            try {
                await fetch(`/api/evaluations/admin/${id}/moderer`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ visible })
                });
                loadEvaluationsAdmin();
            } catch (e) {
                showAlert('Erreur', 'error');
            }
        }
        
        async function supprimerEvaluation(id) {
            if (!confirm('Supprimer cette Ã©valuation ?')) return;
            try {
                await fetch(`/api/evaluations/admin/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadEvaluationsAdmin();
            } catch (e) {
                showAlert('Erreur', 'error');
            }
        }

        // ========== CLOTURER ==========
        function initCloturer() {
            const year = new Date().getFullYear();
            document.getElementById('clotureAnnee').value = year;
            document.getElementById('clotureNom').placeholder = `Semaine SpÃ©ciale ${year}`;
        }
        
        async function cloturerSemaine() {
            const annee = parseInt(document.getElementById('clotureAnnee').value);
            const nom = document.getElementById('clotureNom').value || `Semaine SpÃ©ciale ${annee}`;
            const commentaire = document.getElementById('clotureNotes').value;
            const reset = document.getElementById('clotureReset').checked;
            const nouvelleAnnee = reset ? annee + 1 : null;
            
            if (!confirm(`ÃŠtes-vous sÃ»r de vouloir clÃ´turer la semaine spÃ©ciale ${annee} ?\n\nNom: ${nom}\nReset pour ${annee + 1}: ${reset ? 'Oui' : 'Non'}`)) return;
            if (!confirm('âš ï¸ Cette action est IRRÃ‰VERSIBLE. Confirmer ?')) return;
            
            try {
                const response = await fetch('/api/archives/cloturer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ annee, nom, commentaire, nouvelleAnnee })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… ' + data.message + '\n\nVous pouvez voir l\'archive dans la page Archives.');
                    window.location.href = 'archives.html';
                } else {
                    showAlert('âŒ ' + data.message, 'error');
                }
            } catch (e) {
                showAlert('âŒ Erreur: ' + e.message, 'error');
            }
        }
    </script>

    <!-- Modal Ajout -->
    <div id="addModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:white; padding:30px; border-radius:15px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 id="addModalTitle" style="margin:0; color:#667eea;"></h2>
                <button onclick="closeAddModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div id="addModalBody"></div>
            <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="closeAddModal()">Annuler</button>
                <button class="btn btn-success" onclick="submitAddModal()">Ajouter</button>
            </div>
        </div>
    </div>
<script>if("serviceWorker" in navigator){navigator.serviceWorker.register("/sw.js").catch(e=>console.log("SW:",e));}</script>
</body>
</html>
