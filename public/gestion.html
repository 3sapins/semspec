<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion | Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { color: #667eea; font-size: 28px; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
        }
        .tab {
            padding: 12px 24px;
            border: none;
            background: #f3f4f6;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .tab.active {
            background: #667eea;
            color: white;
        }
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .tab-content.active { display: block; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        tr:hover { background: #f9fafb; }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Gestion</h1>
            <a href="index.html" class="btn btn-secondary">‚Üê Retour</a>
        </div>

        <div id="alert" class="alert" style="display: none;"></div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('listes')">üìã Listes</button>
            <button class="tab" onclick="switchTab('ajouter')">‚ûï Ajouter</button>
            <button class="tab" onclick="switchTab('import')">üì• Import CSV</button>
            <button class="tab" onclick="switchTab('inscrire')">‚úçÔ∏è Inscrire</button>
            <button class="tab" onclick="switchTab('piquet')">üëÆ Piquet</button>
            <button class="tab" onclick="switchTab('placement')">üìç Placement Manuel</button>
        </div>

        <!-- ONGLET LISTES -->
        <div id="listes" class="tab-content active">
            <h2 style="margin-bottom: 20px;">üìã Listes</h2>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="loadListe('enseignants')">üë®‚Äçüè´ Enseignants</button>
                <button class="btn btn-primary" onclick="loadListe('eleves')">üéì √âl√®ves</button>
                <button class="btn btn-primary" onclick="loadListe('classes')">üè´ Classes</button>
                <button class="btn btn-primary" onclick="loadListe('salles')">üö™ Salles</button>
            </div>

            <div id="listeContainer"></div>
        </div>

        <!-- ONGLET AJOUTER -->
        <div id="ajouter" class="tab-content">
            <h2 style="margin-bottom: 20px;">‚ûï Ajouter</h2>
            
            <div class="grid">
                <!-- Ajouter Enseignant -->
                <div>
                    <h3 style="margin-bottom: 15px;">üë®‚Äçüè´ Nouvel Enseignant</h3>
                    <form id="formEnseignant">
                        <div class="form-group">
                            <label>Acronyme *</label>
                            <input type="text" id="ens_acronyme" required maxlength="10">
                        </div>
                        <div class="form-group">
                            <label>Nom *</label>
                            <input type="text" id="ens_nom" required>
                        </div>
                        <div class="form-group">
                            <label>Pr√©nom *</label>
                            <input type="text" id="ens_prenom" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="ens_email">
                        </div>
                        <div class="form-group">
                            <label>Charge Max (p√©riodes) <small style="color: #6b7280;">P√©riodes enseign√©es habituellement</small></label>
                            <input type="number" id="ens_charge_max" min="0" max="30" value="0">
                        </div>
                        <button type="submit" class="btn btn-success" style="width: 100%;">
                            Ajouter l'enseignant
                        </button>
                    </form>
                </div>

                <!-- Ajouter Salle -->
                <div>
                    <h3 style="margin-bottom: 15px;">üö™ Nouvelle Salle</h3>
                    <form id="formSalle">
                        <div class="form-group">
                            <label>Nom *</label>
                            <input type="text" id="salle_nom" required>
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="salle_type">
                                <option value="Classe standard">Classe standard</option>
                                <option value="Salle informatique">Salle informatique</option>
                                <option value="Atelier">Atelier</option>
                                <option value="Laboratoire">Laboratoire</option>
                                <option value="Salle de sport">Salle de sport</option>
                                <option value="Ext√©rieur">Ext√©rieur</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Capacit√© *</label>
                            <input type="number" id="salle_capacite" required min="1">
                        </div>
                        <button type="submit" class="btn btn-success" style="width: 100%;">
                            Ajouter la salle
                        </button>
                    </form>
                </div>
            </div>

            <!-- Ajouter √âl√®ve -->
            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px;">üéì Nouvel √âl√®ve</h3>
                <form id="formEleve" class="grid">
                    <div class="form-group">
                        <label>Nom *</label>
                        <input type="text" id="eleve_nom" required>
                    </div>
                    <div class="form-group">
                        <label>Pr√©nom *</label>
                        <input type="text" id="eleve_prenom" required>
                    </div>
                    <div class="form-group">
                        <label>Classe *</label>
                        <select id="eleve_classe" required></select>
                    </div>
                    <div class="form-group">
                        <label>Num√©ro √©l√®ve</label>
                        <input type="text" id="eleve_numero">
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <button type="submit" class="btn btn-success" style="width: 100%;">
                            Ajouter l'√©l√®ve
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ONGLET IMPORT CSV -->
        <div id="import" class="tab-content">
            <h2 style="margin-bottom: 20px;">üì• Import CSV en Masse</h2>
            
            <div class="alert" id="importAlert" style="display: none;"></div>

            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
                <!-- Import Enseignants -->
                <div style="background: #f9fafb; padding: 25px; border-radius: 10px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">üë®‚Äçüè´ Import Enseignants</h3>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #667eea;">
                        <p style="margin-bottom: 10px; font-weight: 600;">Format CSV :</p>
                        <code style="display: block; background: #f3f4f6; padding: 10px; border-radius: 5px; font-size: 12px;">
                            acronyme,nom,prenom,email,charge_max<br>
                            DUP,Dupuis,Jean,jean.dupuis@ecole.ch,20<br>
                            MAR,Martin,Sophie,sophie.martin@ecole.ch,18
                        </code>
                        <p style="margin-top: 8px; font-size: 11px; color: #6b7280;">
                            charge_max = p√©riodes enseign√©es habituellement (optionnel)
                        </p>
                    </div>

                    <input type="file" id="csvEnseignants" accept=".csv" style="margin-bottom: 15px; width: 100%; padding: 10px; border: 2px dashed #667eea; border-radius: 8px;">
                    
                    <button class="btn btn-primary" onclick="importCSV('enseignants')" style="width: 100%;">
                        üì§ Importer Enseignants
                    </button>
                    
                    <div id="resultEnseignants" style="margin-top: 15px;"></div>
                </div>

                <!-- Import √âl√®ves -->
                <div style="background: #f9fafb; padding: 25px; border-radius: 10px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">üéì Import √âl√®ves</h3>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #667eea;">
                        <p style="margin-bottom: 10px; font-weight: 600;">Format CSV :</p>
                        <code style="display: block; background: #f3f4f6; padding: 10px; border-radius: 5px; font-size: 12px;">
                            nom,prenom,classe,numero<br>
                            Dupont,Paul,9VP1,12345<br>
                            Martin,Marie,9VP2,12346
                        </code>
                    </div>

                    <input type="file" id="csvEleves" accept=".csv" style="margin-bottom: 15px; width: 100%; padding: 10px; border: 2px dashed #667eea; border-radius: 8px;">
                    
                    <button class="btn btn-primary" onclick="importCSV('eleves')" style="width: 100%;">
                        üì§ Importer √âl√®ves
                    </button>
                    
                    <div id="resultEleves" style="margin-top: 15px;"></div>
                </div>

                <!-- Import Salles -->
                <div style="background: #f9fafb; padding: 25px; border-radius: 10px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">üö™ Import Salles</h3>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #667eea;">
                        <p style="margin-bottom: 10px; font-weight: 600;">Format CSV :</p>
                        <code style="display: block; background: #f3f4f6; padding: 10px; border-radius: 5px; font-size: 12px;">
                            nom,type,capacite<br>
                            C001,classe,25<br>
                            Gymnase,sport,40
                        </code>
                        <p style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                            Types: classe, informatique, labo, art, sport, polyvalente
                        </p>
                    </div>

                    <input type="file" id="csvSalles" accept=".csv" style="margin-bottom: 15px; width: 100%; padding: 10px; border: 2px dashed #667eea; border-radius: 8px;">
                    
                    <button class="btn btn-primary" onclick="importCSV('salles')" style="width: 100%;">
                        üì§ Importer Salles
                    </button>
                    
                    <div id="resultSalles" style="margin-top: 15px;"></div>
                </div>
            </div>

            <div style="margin-top: 30px; padding: 20px; background: #dbeafe; border-radius: 10px; border-left: 4px solid #3b82f6;">
                <h4 style="color: #1e40af; margin-bottom: 10px;">üí° Conseils</h4>
                <ul style="margin-left: 20px; color: #1e3a8a; line-height: 1.8;">
                    <li>Utilisez un tableur (Excel, LibreOffice) pour pr√©parer vos CSV</li>
                    <li>Encodage : UTF-8 (pour les accents)</li>
                    <li>S√©parateur : virgule (,)</li>
                    <li>Premi√®re ligne = en-t√™tes obligatoires</li>
                    <li>Les doublons (m√™me acronyme/num√©ro) seront ignor√©s</li>
                </ul>
            </div>
        </div>

        <!-- ONGLET INSCRIRE -->
        <div id="inscrire" class="tab-content">
            <h2 style="margin-bottom: 20px;">‚úçÔ∏è Inscriptions Manuelles</h2>
            
            <div class="grid">
                <!-- Inscrire une classe -->
                <div>
                    <h3 style="margin-bottom: 15px;">üè´ Inscrire une Classe</h3>
                    <form id="formInscrireClasse">
                        <div class="form-group">
                            <label>Classe *</label>
                            <select id="inscr_classe" required></select>
                        </div>
                        <div class="form-group">
                            <label>Atelier *</label>
                            <select id="inscr_atelier_classe" required></select>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            Inscrire toute la classe
                        </button>
                    </form>
                </div>

                <!-- Inscrire des √©l√®ves -->
                <div>
                    <h3 style="margin-bottom: 15px;">üéì Inscrire des √âl√®ves</h3>
                    <div class="form-group">
                        <label>Classe</label>
                        <select id="select_classe_eleves" onchange="loadElevesClasse()">
                            <option value="">-- S√©lectionner --</option>
                        </select>
                    </div>
                    <div id="elevesContainer"></div>
                </div>
            </div>
        </div>

        <!-- ONGLET PIQUET -->
        <div id="piquet" class="tab-content">
            <h2 style="margin-bottom: 20px;">üëÆ Enseignants de Piquet</h2>
            
            <div class="grid">
                <div>
                    <h3 style="margin-bottom: 15px;">Ajouter un Piquet</h3>
                    <form id="formPiquet">
                        <div class="form-group">
                            <label>Enseignant *</label>
                            <select id="piquet_enseignant" required></select>
                        </div>
                        <div class="form-group">
                            <label>Cr√©neau *</label>
                            <select id="piquet_creneau" required></select>
                        </div>
                        <div class="form-group">
                            <label>Type *</label>
                            <select id="piquet_type">
                                <option value="piquet">Piquet</option>
                                <option value="degagement">D√©gagement</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Salle (si d√©gagement)</label>
                            <select id="piquet_salle">
                                <option value="">-- Aucune --</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success" style="width: 100%;">
                            Ajouter
                        </button>
                    </form>
                </div>

                <div>
                    <h3 style="margin-bottom: 15px;">Liste des Piquets</h3>
                    <div id="piquetListe"></div>
                </div>
            </div>
        </div>

        <!-- ONGLET PLACEMENT MANUEL -->
        <div id="placement" class="tab-content">
            <h2 style="margin-bottom: 20px;">üìç Placement Manuel</h2>
            
            <form id="formPlacement" class="grid">
                <div class="form-group">
                    <label>Atelier *</label>
                    <select id="place_atelier" required></select>
                </div>
                <div class="form-group">
                    <label>Salle *</label>
                    <select id="place_salle" required></select>
                </div>
                <div class="form-group">
                    <label>Cr√©neau de d√©but *</label>
                    <select id="place_creneau" required></select>
                </div>
                <div style="grid-column: 1 / -1;">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Placer l'atelier
                    </button>
                </div>
            </form>

            <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px;">
                <strong>üí° Astuce :</strong> Assurez-vous que la salle et l'enseignant sont disponibles sur le cr√©neau choisi.
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/gestion';
        const token = localStorage.getItem('token');

        if (!token) {
            window.location.href = 'login.html';
        }

        // Charger au d√©marrage
        document.addEventListener('DOMContentLoaded', () => {
            loadClassesForSelects();
            loadAteliersForSelects();
            loadEnseignantsForSelects();
            loadSallesForSelects();
            loadCreneauxForSelects();
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'piquet') loadPiquetListe();
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        // === LISTES ===
        async function loadListe(type) {
            try {
                const response = await fetch(`${API_BASE}/${type}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                let html = `<h3>${type.charAt(0).toUpperCase() + type.slice(1)}</h3>`;
                html += '<table><thead><tr>';
                
                if (type === 'enseignants') {
                    html += '<th>Acronyme</th><th>Nom</th><th>Pr√©nom</th><th>Email</th><th>Actions</th>';
                    html += '</tr></thead><tbody>';
                    result.data.forEach(item => {
                        html += `<tr>
                            <td>${item.acronyme}</td>
                            <td>${item.nom}</td>
                            <td>${item.prenom}</td>
                            <td>${item.email || '-'}</td>
                            <td>
                                <button class="btn btn-primary" style="padding:5px 10px;font-size:12px;margin-right:5px;" onclick="openDisponibilites('${item.acronyme}', '${item.nom} ${item.prenom}')">üìÖ Dispos</button>
                                <button class="btn btn-secondary" style="padding:5px 10px;font-size:12px;" onclick="resetPassword(${item.id}, '${item.acronyme}')">üîë Reset MDP</button>
                            </td>
                        </tr>`;
                    });
                } else if (type === 'eleves') {
                    html += '<th>Nom</th><th>Pr√©nom</th><th>Classe</th><th>Actions</th>';
                    html += '</tr></thead><tbody>';
                    result.data.forEach(item => {
                        html += `<tr>
                            <td>${item.nom}</td>
                            <td>${item.prenom}</td>
                            <td>${item.classe_nom}</td>
                            <td><button class="btn btn-secondary" style="padding:5px 10px;font-size:12px;" onclick="resetPassword(${item.utilisateur_id}, '${item.prenom} ${item.nom}')">üîë Reset MDP</button></td>
                        </tr>`;
                    });
                } else if (type === 'classes') {
                    html += '<th>Nom</th><th>Niveau</th><th>Voie</th><th>√âl√®ves</th>';
                    html += '</tr></thead><tbody>';
                    result.data.forEach(item => {
                        html += `<tr><td>${item.nom}</td><td>${item.niveau}</td><td>${item.voie}</td><td>${item.nombre_eleves}</td></tr>`;
                    });
                } else if (type === 'salles') {
                    html += '<th>Nom</th><th>Type</th><th>Capacit√©</th><th>Disponible</th>';
                    html += '</tr></thead><tbody>';
                    result.data.forEach(item => {
                        html += `<tr><td>${item.nom}</td><td>${item.type_salle || '-'}</td><td>${item.capacite}</td><td>${item.disponible ? '‚úÖ' : '‚ùå'}</td></tr>`;
                    });
                }
                
                html += '</tbody></table>';
                document.getElementById('listeContainer').innerHTML = html;
                
            } catch (error) {
                showAlert('Erreur de chargement', 'error');
            }
        }

        // === AJOUTER ===
        document.getElementById('formEnseignant').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = {
                    acronyme: document.getElementById('ens_acronyme').value,
                    nom: document.getElementById('ens_nom').value,
                    prenom: document.getElementById('ens_prenom').value,
                    email: document.getElementById('ens_email').value || null,
                    charge_max: parseInt(document.getElementById('ens_charge_max').value) || 0
                };
                
                const response = await fetch(`${API_BASE}/enseignants`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('‚úÖ Enseignant ajout√© ! Mot de passe: ' + (result.default_password || 'SemaineSpeciale2026'), 'success');
                    e.target.reset();
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Erreur', 'error');
            }
        });

        document.getElementById('formSalle').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = {
                    nom: document.getElementById('salle_nom').value,
                    type_salle: document.getElementById('salle_type').value,
                    capacite: parseInt(document.getElementById('salle_capacite').value)
                };
                
                const response = await fetch(`${API_BASE}/salles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('‚úÖ Salle ajout√©e !', 'success');
                    e.target.reset();
                    loadSallesForSelects();
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Erreur', 'error');
            }
        });

        document.getElementById('formEleve').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = {
                    nom: document.getElementById('eleve_nom').value,
                    prenom: document.getElementById('eleve_prenom').value,
                    classe_id: parseInt(document.getElementById('eleve_classe').value),
                    numero_eleve: document.getElementById('eleve_numero').value || null
                };
                
                const response = await fetch(`${API_BASE}/eleves`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('‚úÖ √âl√®ve ajout√© !', 'success');
                    e.target.reset();
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Erreur', 'error');
            }
        });

        // === INSCRIRE ===
        document.getElementById('formInscrireClasse').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = {
                    classe_id: parseInt(document.getElementById('inscr_classe').value),
                    atelier_id: parseInt(document.getElementById('inscr_atelier_classe').value)
                };
                
                const response = await fetch(`${API_BASE}/inscriptions-classe`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert(`‚úÖ ${result.count} √©l√®ves inscrits !`, 'success');
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Erreur', 'error');
            }
        });

        // === PIQUET ===
        document.getElementById('formPiquet').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = {
                    enseignant_acronyme: document.getElementById('piquet_enseignant').value,
                    creneau_id: parseInt(document.getElementById('piquet_creneau').value),
                    type: document.getElementById('piquet_type').value,
                    salle_id: document.getElementById('piquet_salle').value || null
                };
                
                const response = await fetch(`${API_BASE}/piquet`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('‚úÖ Piquet ajout√© !', 'success');
                    e.target.reset();
                    loadPiquetListe();
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Erreur', 'error');
            }
        });

        async function loadPiquetListe() {
            try {
                const response = await fetch(`${API_BASE}/piquet`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                let html = '<table><thead><tr><th>Enseignant</th><th>Cr√©neau</th><th>Type</th><th>Salle</th><th>Action</th></tr></thead><tbody>';
                result.data.forEach(p => {
                    html += `<tr>
                        <td>${p.enseignant_prenom} ${p.enseignant_nom}</td>
                        <td>${p.jour} ${p.periode}</td>
                        <td>${p.type}</td>
                        <td>${p.salle_nom || '-'}</td>
                        <td><button class="btn btn-danger" onclick="deletePiquet(${p.id})">üóëÔ∏è</button></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('piquetListe').innerHTML = html;
            } catch (error) {
                console.error(error);
            }
        }

        async function deletePiquet(id) {
            if (!confirm('Supprimer ce piquet ?')) return;
            try {
                await fetch(`${API_BASE}/piquet/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                showAlert('‚úÖ Piquet supprim√©', 'success');
                loadPiquetListe();
            } catch (error) {
                showAlert('‚ùå Erreur', 'error');
            }
        }

        // === PLACEMENT MANUEL ===
        document.getElementById('formPlacement').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = {
                    atelier_id: parseInt(document.getElementById('place_atelier').value),
                    salle_id: parseInt(document.getElementById('place_salle').value),
                    creneau_id: parseInt(document.getElementById('place_creneau').value)
                };
                
                console.log('Donn√©es envoy√©es:', data);
                
                const response = await fetch('/api/planning/placer-manuel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('‚úÖ Atelier plac√© !', 'success');
                    e.target.reset();
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('‚ùå Erreur', 'error');
            }
        });

        // === CHARGEMENT SELECTS ===
        async function loadClassesForSelects() {
            try {
                const response = await fetch(`${API_BASE}/classes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                const selects = ['eleve_classe', 'inscr_classe', 'select_classe_eleves'];
                selects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = '<option value="">-- S√©lectionner --</option>';
                        result.data.forEach(c => {
                            select.innerHTML += `<option value="${c.id}">${c.nom}</option>`;
                        });
                    }
                });
            } catch (error) {
                console.error(error);
            }
        }

        async function loadAteliersForSelects() {
            try {
                const response = await fetch('/api/admin/ateliers?statut=valide', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                const selects = ['inscr_atelier_classe', 'place_atelier'];
                selects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = '<option value="">-- S√©lectionner --</option>';
                        result.data.forEach(a => {
                            select.innerHTML += `<option value="${a.id}">${a.nom} (${a.enseignant_acronyme})</option>`;
                        });
                    }
                });
            } catch (error) {
                console.error(error);
            }
        }

        async function loadEnseignantsForSelects() {
            try {
                const response = await fetch('/api/admin/enseignants/liste', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                const select = document.getElementById('piquet_enseignant');
                if (select) {
                    select.innerHTML = '<option value="">-- S√©lectionner --</option>';
                    result.data.forEach(e => {
                        select.innerHTML += `<option value="${e.acronyme}">${e.nom} ${e.prenom}</option>`;
                    });
                }
            } catch (error) {
                console.error(error);
            }
        }

        async function loadSallesForSelects() {
            try {
                const response = await fetch(`${API_BASE}/salles`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                const selects = ['piquet_salle', 'place_salle'];
                selects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = '<option value="">-- S√©lectionner --</option>';
                        result.data.forEach(s => {
                            select.innerHTML += `<option value="${s.id}">${s.nom}</option>`;
                        });
                    }
                });
            } catch (error) {
                console.error(error);
            }
        }

        async function loadCreneauxForSelects() {
            try {
                const response = await fetch('/api/planning/creneaux', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                const selects = ['piquet_creneau', 'place_creneau'];
                selects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = '<option value="">-- S√©lectionner --</option>';
                        result.data.forEach(c => {
                            select.innerHTML += `<option value="${c.id}">${c.jour} ${c.periode} (${c.heure_debut}-${c.heure_fin})</option>`;
                        });
                    }
                });
            } catch (error) {
                console.error(error);
            }
        }

        // Import CSV
        async function importCSV(type) {
            const fileInput = document.getElementById(`csv${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const resultDiv = document.getElementById(`result${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const file = fileInput.files[0];

            if (!file) {
                showAlert('Veuillez s√©lectionner un fichier CSV', 'error');
                return;
            }

            resultDiv.innerHTML = '<p style="color: #667eea;">üì§ Import en cours...</p>';

            try {
                const text = await file.text();
                const lines = text.split('\n').filter(l => l.trim());
                
                if (lines.length < 2) {
                    throw new Error('Fichier vide ou mal format√©');
                }

                const headers = lines[0].split(',').map(h => h.trim());
                const rows = lines.slice(1);

                let successes = 0;
                let errors = [];

                for (let i = 0; i < rows.length; i++) {
                    const values = rows[i].split(',').map(v => v.trim());
                    if (values.length === 0 || !values[0]) continue;

                    const data = {};
                    headers.forEach((header, index) => {
                        data[header] = values[index] || '';
                    });

                    try {
                        const response = await fetch(`/api/gestion/${type}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();
                        if (result.success) {
                            successes++;
                        } else {
                            errors.push(`Ligne ${i + 2}: ${result.message}`);
                        }
                    } catch (err) {
                        errors.push(`Ligne ${i + 2}: Erreur r√©seau`);
                    }
                }

                // Afficher r√©sultats
                let html = `<div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">`;
                html += `<p style="color: #10b981; font-weight: 600;">‚úÖ ${successes} import√©(s) avec succ√®s</p>`;
                
                if (errors.length > 0) {
                    html += `<p style="color: #ef4444; font-weight: 600; margin-top: 10px;">‚ùå ${errors.length} erreur(s) :</p>`;
                    html += `<ul style="margin-left: 20px; margin-top: 5px; color: #991b1b; font-size: 12px;">`;
                    errors.slice(0, 10).forEach(err => {
                        html += `<li>${err}</li>`;
                    });
                    if (errors.length > 10) {
                        html += `<li>... et ${errors.length - 10} autre(s)</li>`;
                    }
                    html += `</ul>`;
                }
                html += `</div>`;
                
                resultDiv.innerHTML = html;
                
                if (successes > 0) {
                    showAlert(`‚úÖ ${successes} ${type} import√©(s) !`, 'success');
                }

                // R√©initialiser input
                fileInput.value = '';

            } catch (error) {
                console.error('Erreur import:', error);
                resultDiv.innerHTML = `<p style="color: #ef4444;">‚ùå Erreur : ${error.message}</p>`;
                showAlert('Erreur lors de l\'import CSV', 'error');
            }
        }

        // === R√âINITIALISATION MOT DE PASSE ===
        async function resetPassword(userId, userName) {
            if (!confirm(`R√©initialiser le mot de passe de ${userName} ?\n\nLe nouveau mot de passe sera :\n- Pour un enseignant : son acronyme\n- Pour un √©l√®ve : pr√©nomnom`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/utilisateurs/${userId}/reset-password`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`‚úÖ Mot de passe r√©initialis√© !\nNouveau mot de passe : ${result.nouveau_mot_de_passe}`, 'success');
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Erreur reset password:', error);
                showAlert('‚ùå Erreur lors de la r√©initialisation', 'error');
            }
        }

        // === GESTION DES DISPONIBILIT√âS ===
        let currentEnseignantAcronyme = '';
        let creneauxData = [];
        let disponibilitesData = {};

        async function openDisponibilites(acronyme, nomComplet) {
            currentEnseignantAcronyme = acronyme;
            document.getElementById('dispoEnseignantNom').textContent = `${nomComplet} (${acronyme})`;
            
            // Charger les cr√©neaux
            try {
                const response = await fetch('/api/planning/creneaux', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                creneauxData = result.data || [];
                
                // Charger les disponibilit√©s existantes
                const dispoResponse = await fetch(`/api/admin/enseignants/${acronyme}/disponibilites`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const dispoResult = await dispoResponse.json();
                
                // Cr√©er map des indisponibilit√©s
                disponibilitesData = {};
                (dispoResult.data || []).forEach(d => {
                    disponibilitesData[d.creneau_id] = d.disponible;
                });
                
                renderDisponibilitesGrid();
                document.getElementById('modalDisponibilites').style.display = 'flex';
            } catch (error) {
                console.error('Erreur chargement disponibilit√©s:', error);
                showAlert('‚ùå Erreur de chargement', 'error');
            }
        }

        function renderDisponibilitesGrid() {
            const jours = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi'];
            const periodes = ['P1-2', 'P3-4', 'P6-7'];
            
            let html = '<table style="width:100%;"><thead><tr><th></th>';
            jours.forEach(j => html += `<th>${j.charAt(0).toUpperCase() + j.slice(1)}</th>`);
            html += '</tr></thead><tbody>';
            
            periodes.forEach(periode => {
                html += `<tr><td><strong>${periode}</strong></td>`;
                jours.forEach(jour => {
                    // Pas de P6-7 le mercredi
                    if (jour === 'mercredi' && periode === 'P6-7') {
                        html += '<td style="background:#eee;">-</td>';
                        return;
                    }
                    
                    const creneau = creneauxData.find(c => c.jour === jour && c.periode === periode);
                    if (creneau) {
                        // Par d√©faut disponible (true), sauf si explicitement false
                        const estDisponible = disponibilitesData[creneau.id] !== false;
                        const bgColor = estDisponible ? '#d1fae5' : '#fee2e2';
                        const icon = estDisponible ? '‚úÖ' : '‚ùå';
                        html += `<td style="background:${bgColor};cursor:pointer;text-align:center;padding:10px;" onclick="toggleDispo(${creneau.id})">${icon}</td>`;
                    } else {
                        html += '<td>-</td>';
                    }
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            html += '<p style="margin-top:15px;color:#666;font-size:12px;">‚úÖ = Disponible | ‚ùå = Indisponible<br>Cliquez sur une case pour changer.</p>';
            
            document.getElementById('dispoGrid').innerHTML = html;
        }

        function toggleDispo(creneauId) {
            // Par d√©faut disponible (undefined ou true), toggle vers false ou true
            const actuel = disponibilitesData[creneauId];
            disponibilitesData[creneauId] = (actuel === false) ? true : false;
            renderDisponibilitesGrid();
        }

        async function saveDisponibilites() {
            try {
                // Envoyer uniquement les indisponibilit√©s
                const indisponibilites = Object.entries(disponibilitesData)
                    .filter(([id, dispo]) => dispo === false)
                    .map(([id, dispo]) => parseInt(id));
                
                const response = await fetch(`/api/admin/enseignants/${currentEnseignantAcronyme}/disponibilites`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ indisponibilites })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('‚úÖ Disponibilit√©s enregistr√©es', 'success');
                    closeModalDisponibilites();
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                showAlert('‚ùå Erreur lors de la sauvegarde', 'error');
            }
        }

        function closeModalDisponibilites() {
            document.getElementById('modalDisponibilites').style.display = 'none';
        }
    </script>

    <!-- Modale Disponibilit√©s -->
    <div id="modalDisponibilites" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
        <div style="background:white;padding:30px;border-radius:15px;max-width:700px;width:90%;max-height:90vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2>üìÖ Disponibilit√©s</h2>
                <button onclick="closeModalDisponibilites()" style="background:none;border:none;font-size:24px;cursor:pointer;">√ó</button>
            </div>
            <p style="margin-bottom:15px;"><strong>Enseignant :</strong> <span id="dispoEnseignantNom"></span></p>
            <div id="dispoGrid"></div>
            <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="closeModalDisponibilites()">Annuler</button>
                <button class="btn btn-primary" onclick="saveDisponibilites()">üíæ Enregistrer</button>
            </div>
        </div>
    </div>
</body>
</html>
