<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion | Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 25px 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        h1 { color: #667eea; font-size: 28px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 15px; border-radius: 12px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; border: none; background: #f3f4f6; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .tab.active { background: #667eea; color: white; }
        .tab-content { display: none; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; }
        input, select, textarea { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; }
        tr:hover { background: #f9fafb; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .alert-success { background: #d1fae5; color: #065f46; }
        .alert-error { background: #fee2e2; color: #991b1b; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
        .card { background: #f9fafb; padding: 20px; border-radius: 10px; margin-bottom: 15px; }
        .badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        .badge-red { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Gestion</h1>
            <a href="index.html" class="btn btn-secondary">‚Üê Retour Admin</a>
        </div>
        <div id="alert" class="alert"></div>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('listes')">üìã Listes</button>
            <button class="tab" onclick="switchTab('ajouter')">‚ûï Ajouter</button>
            <button class="tab" onclick="switchTab('inscrire')">‚úçÔ∏è Inscrire</button>
            <button class="tab" onclick="switchTab('inscriptions-eleves')">üéì Inscr. √âl√®ves</button>
            <button class="tab" onclick="switchTab('piquet')">üëÆ Piquet</button>
            <button class="tab" onclick="switchTab('eleves-creneaux')">üëÅÔ∏è √âl√®ves/Cr√©neaux</button>
            <button class="tab" onclick="switchTab('creneaux-faibles')">‚ö†Ô∏è Faibles</button>
        </div>

        <!-- LISTES -->
        <div id="listes" class="tab-content active">
            <h2 style="margin-bottom: 20px;">üìã Listes</h2>
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="loadListe('enseignants')">üë®‚Äçüè´ Enseignants</button>
                <button class="btn btn-primary" onclick="loadListe('eleves')">üéì √âl√®ves</button>
                <button class="btn btn-primary" onclick="loadListe('classes')">üè´ Classes</button>
                <button class="btn btn-primary" onclick="loadListe('salles')">üö™ Salles</button>
                <button class="btn btn-warning" onclick="loadListe('themes')">üé® Th√®mes</button>
                <button class="btn btn-warning" onclick="loadListe('types_salles')">üè∑Ô∏è Types de Salles</button>
            </div>
            <div id="listeContainer"></div>
        </div>

        <!-- AJOUTER -->
        <div id="ajouter" class="tab-content">
            <h2 style="margin-bottom: 20px;">‚ûï Ajouter</h2>
            <div class="grid">
                <div class="card">
                    <h3>üë®‚Äçüè´ Enseignant</h3>
                    <form id="formEnseignant">
                        <div class="form-group"><label>Acronyme *</label><input type="text" id="ens_acronyme" required></div>
                        <div class="form-group"><label>Nom *</label><input type="text" id="ens_nom" required></div>
                        <div class="form-group"><label>Pr√©nom *</label><input type="text" id="ens_prenom" required></div>
                        <div class="form-group"><label>Email</label><input type="email" id="ens_email"></div>
                        <button type="submit" class="btn btn-success">Ajouter</button>
                    </form>
                </div>
                <div class="card">
                    <h3>üè´ Classe</h3>
                    <form id="formClasse">
                        <div class="form-group"><label>Nom *</label><input type="text" id="classe_nom" required placeholder="ex: 9VP1"></div>
                        <div class="form-group"><label>Niveau</label><select id="classe_niveau"><option value="">--</option><option>9VP</option><option>9VG</option><option>10VP</option><option>10VG</option></select></div>
                        <button type="submit" class="btn btn-success">Ajouter</button>
                    </form>
                </div>
                <div class="card">
                    <h3>üö™ Salle</h3>
                    <form id="formSalle">
                        <div class="form-group"><label>Nom *</label><input type="text" id="salle_nom" required></div>
                        <div class="form-group"><label>Capacit√©</label><input type="number" id="salle_capacite" value="25"></div>
                        <div class="form-group"><label>Type</label><select id="salle_type"></select></div>
                        <button type="submit" class="btn btn-success">Ajouter</button>
                    </form>
                </div>
                <div class="card">
                    <h3>üéì √âl√®ve</h3>
                    <form id="formEleve">
                        <div class="form-group"><label>Nom *</label><input type="text" id="eleve_nom" required></div>
                        <div class="form-group"><label>Pr√©nom *</label><input type="text" id="eleve_prenom" required></div>
                        <div class="form-group"><label>Classe *</label><select id="eleve_classe" required></select></div>
                        <button type="submit" class="btn btn-success">Ajouter</button>
                    </form>
                </div>
                <div class="card">
                    <h3>üé® Th√®me</h3>
                    <form id="formTheme">
                        <div class="form-group"><label>Nom *</label><input type="text" id="theme_nom" required></div>
                        <div class="form-group"><label>Couleur</label><input type="color" id="theme_couleur" value="#667eea"></div>
                        <div class="form-group"><label>Ic√¥ne</label><input type="text" id="theme_icone" value="üé®" maxlength="5"></div>
                        <div class="form-group"><label>Description</label><input type="text" id="theme_description"></div>
                        <button type="submit" class="btn btn-success">Ajouter</button>
                    </form>
                </div>
                <div class="card">
                    <h3>üè∑Ô∏è Type de Salle</h3>
                    <form id="formTypeSalle">
                        <div class="form-group"><label>Nom *</label><input type="text" id="type_salle_nom" required placeholder="ex: Salle informatique"></div>
                        <div class="form-group"><label>Description</label><input type="text" id="type_salle_description"></div>
                        <button type="submit" class="btn btn-success">Ajouter</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- INSCRIRE -->
        <div id="inscrire" class="tab-content">
            <h2 style="margin-bottom: 20px;">‚úçÔ∏è Inscrire √† un cr√©neau</h2>
            <div class="grid">
                <div class="card">
                    <h3>üìã Inscrire une classe</h3>
                    <form id="formInscrireClasse">
                        <div class="form-group">
                            <label>üîç Rechercher un cr√©neau</label>
                            <input type="text" id="searchCreneauClasse" placeholder="Tapez le nom de l'atelier..." oninput="filterCreneaux('classe')">
                        </div>
                        <div class="form-group"><label>Cr√©neau *</label><select id="inscr_planning_classe" required></select></div>
                        <div class="form-group"><label>Classe *</label><select id="inscr_classe" required></select></div>
                        <button type="submit" class="btn btn-success" style="width:100%;">üì• Inscrire</button>
                    </form>
                    <div id="resultatInscrClasse" style="margin-top: 15px;"></div>
                </div>
                <div class="card">
                    <h3>üéØ Inscrire des √©l√®ves</h3>
                    <form id="formInscrireEleves">
                        <div class="form-group">
                            <label>üîç Rechercher un cr√©neau</label>
                            <input type="text" id="searchCreneauEleves" placeholder="Tapez le nom de l'atelier..." oninput="filterCreneaux('eleves')">
                        </div>
                        <div class="form-group"><label>Cr√©neau *</label><select id="inscr_planning_eleves" required></select></div>
                        <div class="form-group"><label>Rechercher √©l√®ve</label><input type="text" id="rechercheEleve" placeholder="Nom ou pr√©nom..." oninput="rechercherEleves()"></div>
                        <div id="resultatsRecherche" style="max-height:150px;overflow-y:auto;border:1px solid #eee;border-radius:8px;margin-bottom:10px;"></div>
                        <div class="form-group"><label>S√©lectionn√©s</label><div id="elevesSelectionnes" style="min-height:40px;padding:10px;background:#f3f4f6;border-radius:8px;"></div></div>
                        <button type="submit" class="btn btn-success" style="width:100%;">üì• Inscrire</button>
                    </form>
                    <div id="resultatInscrEleves" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>

        <!-- PIQUET -->
        <div id="piquet" class="tab-content">

        <!-- INSCRIPTIONS √âL√àVES -->
        <div id="inscriptions-eleves" class="tab-content">
            <h2 style="margin-bottom: 20px;">üéì Gestion Inscriptions √âl√®ves</h2>
            <div class="card">
                <div class="form-group">
                    <label>üîç Rechercher un √©l√®ve</label>
                    <input type="text" id="searchEleve" placeholder="Nom ou pr√©nom..." oninput="rechercherEleveAdmin()">
                </div>
                <div id="resultatsRechercheEleve" style="max-height:200px;overflow-y:auto;border:1px solid #eee;border-radius:8px;margin-bottom:20px;"></div>
            </div>
            <div id="eleveInscriptionsContainer" style="display:none;">
                <div class="card">
                    <div id="eleveInfoHeader" style="margin-bottom:20px;"></div>
                    <div style="display:flex;gap:10px;margin-bottom:20px;">
                        <button class="btn btn-danger" id="btnDevalider" onclick="devaliderEleve()">üîì D√©-valider</button>
                        <button class="btn btn-primary" onclick="showAjouterInscription()">‚ûï Ajouter inscription</button>
                    </div>
                    <h3 style="margin-bottom:15px;">Inscriptions actuelles</h3>
                    <div id="eleveInscriptionsListe"></div>
                </div>
            </div>
            <!-- Modal ajouter inscription -->
            <div id="modalAjouterInscr" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
                <div style="background:white;padding:30px;border-radius:15px;max-width:500px;width:90%;">
                    <h3 style="color:#667eea;margin-bottom:20px;">‚ûï Ajouter une inscription</h3>
                    <div class="form-group">
                        <label>üîç Rechercher cr√©neau</label>
                        <input type="text" id="searchCreneauAdmin" placeholder="Nom atelier..." oninput="filterCreneauxAdmin()">
                    </div>
                    <div class="form-group">
                        <label>Cr√©neau</label>
                        <select id="adminInscriptionCreneau"></select>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="adminNotifier" checked> Notifier l'√©l√®ve</label>
                    </div>
                    <div style="display:flex;gap:10px;justify-content:flex-end;">
                        <button class="btn btn-secondary" onclick="hideAjouterInscription()">Annuler</button>
                        <button class="btn btn-success" onclick="ajouterInscriptionAdmin()">Ajouter</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PIQUET (ancien) -->
            <h2 style="margin-bottom: 20px;">üëÆ Piquet / D√©gagement</h2>
            <div class="grid">
                <div class="card">
                    <h3>Ajouter</h3>
                    <form id="formPiquet">
                        <div class="form-group"><label>Enseignant *</label><select id="piquet_enseignant" required></select></div>
                        <div class="form-group"><label>Cr√©neau *</label><select id="piquet_creneau" required></select></div>
                        <div class="form-group"><label>Type *</label><select id="piquet_type"><option value="piquet">Piquet</option><option value="degagement">D√©gagement</option></select></div>
                        <div class="form-group"><label>Commentaire</label><input type="text" id="piquet_commentaire" placeholder="Optionnel"></div>
                        <button type="submit" class="btn btn-success" style="width:100%;">‚úÖ Ajouter</button>
                    </form>
                </div>
                <div><h3 style="margin-bottom: 15px;">Liste</h3><div id="piquetListe"></div></div>
            </div>
        </div>

        <!-- √âL√àVES PAR CR√âNEAU -->
        <div id="eleves-creneaux" class="tab-content">
            <h2 style="margin-bottom: 20px;">üëÅÔ∏è √âl√®ves par cr√©neau</h2>
            <div class="card">
                <div style="display:flex;gap:15px;flex-wrap:wrap;margin-bottom:20px;">
                    <div class="form-group" style="flex:1;min-width:150px;"><label>Jour</label><select id="filtre_jour" onchange="loadElevesCreneaux()"><option value="">Tous</option><option value="lundi">Lundi</option><option value="mardi">Mardi</option><option value="mercredi">Mercredi</option><option value="jeudi">Jeudi</option><option value="vendredi">Vendredi</option></select></div>
                    <div class="form-group" style="flex:1;min-width:150px;"><label>Classe</label><select id="filtre_classe_eleves" onchange="loadElevesCreneaux()"></select></div>
                </div>
                <div id="elevesCreneauxContainer"></div>
            </div>
        </div>

        <!-- CR√âNEAUX FAIBLES -->
        <div id="creneaux-faibles" class="tab-content">
            <h2 style="margin-bottom: 20px;">‚ö†Ô∏è Cr√©neaux faibles</h2>
            <div class="card">
                <div class="form-group" style="max-width:150px;"><label>Seuil</label><input type="number" id="seuil_faibles" value="5" min="1" onchange="loadCreneauxFaibles()"></div>
                <div id="creneauxFaiblesContainer"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/gestion';
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'index.html';

        let allPlannings = [];
        let tousLesEleves = [];
        let elevesSelectionnesIds = new Set();

        document.addEventListener('DOMContentLoaded', () => {
            loadClassesForSelects();
            loadEnseignantsForSelects();
            loadCreneauxForSelects();
            loadPlanningsForSelects();
            chargerTousEleves();
            loadTypesSalles();
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'piquet') loadPiquetListe();
            if (tabName === 'eleves-creneaux') loadElevesCreneaux();
            if (tabName === 'creneaux-faibles') loadCreneauxFaibles();
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        async function loadClassesForSelects() {
            try {
                const response = await fetch(`${API_BASE}/classes`, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                ['eleve_classe', 'inscr_classe', 'filtre_classe_eleves'].forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = '<option value="">-- Toutes --</option>';
                        result.data.forEach(c => select.innerHTML += `<option value="${c.id}">${c.nom}</option>`);
                    }
                });
            } catch (e) { console.error(e); }
        }

        async function loadEnseignantsForSelects() {
            try {
                const response = await fetch(`${API_BASE}/enseignants`, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                const select = document.getElementById('piquet_enseignant');
                if (select) {
                    select.innerHTML = '<option value="">-- S√©lectionner --</option>';
                    result.data.forEach(e => select.innerHTML += `<option value="${e.id}">${e.prenom} ${e.nom} (${e.acronyme})</option>`);
                }
            } catch (e) { console.error(e); }
        }

        async function loadCreneauxForSelects() {
            try {
                const response = await fetch('/api/planning/creneaux', { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                const select = document.getElementById('piquet_creneau');
                if (select) {
                    select.innerHTML = '<option value="">-- S√©lectionner --</option>';
                    result.data.forEach(c => {
                        const jour = c.jour.charAt(0).toUpperCase() + c.jour.slice(1);
                        select.innerHTML += `<option value="${c.id}">${jour} ${c.periode}</option>`;
                    });
                }
            } catch (e) { console.error(e); }
        }

        async function loadPlanningsForSelects() {
            try {
                const response = await fetch(`${API_BASE}/ateliers-planifies`, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                allPlannings = result.data || [];
                updatePlanningSelects(allPlannings);
            } catch (e) { console.error(e); }
        }

        function updatePlanningSelects(plannings) {
            ['inscr_planning_classe', 'inscr_planning_eleves'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">-- S√©lectionner --</option>';
                    plannings.forEach(p => {
                        const jour = p.jour.charAt(0).toUpperCase() + p.jour.slice(1);
                        const places = p.nombre_places_max - p.nb_inscrits;
                        select.innerHTML += `<option value="${p.planning_id}">${p.atelier_nom} - ${jour} ${p.periode} (${places} places)</option>`;
                    });
                }
            });
        }

        function filterCreneaux(type) {
            const searchInput = type === 'classe' ? document.getElementById('searchCreneauClasse') : document.getElementById('searchCreneauEleves');
            const term = searchInput.value.toLowerCase().trim();
            if (term.length === 0) { updatePlanningSelects(allPlannings); return; }
            const filtered = allPlannings.filter(p => p.atelier_nom.toLowerCase().includes(term) || p.jour.toLowerCase().includes(term));
            const selectId = type === 'classe' ? 'inscr_planning_classe' : 'inscr_planning_eleves';
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">-- S√©lectionner --</option>';
            filtered.forEach(p => {
                const jour = p.jour.charAt(0).toUpperCase() + p.jour.slice(1);
                const places = p.nombre_places_max - p.nb_inscrits;
                select.innerHTML += `<option value="${p.planning_id}">${p.atelier_nom} - ${jour} ${p.periode} (${places} places)</option>`;
            });
        }

        async function loadListe(type) {
            try {
                let url = `${API_BASE}/${type}`;
                if (type === 'themes') url = '/api/admin/themes/liste';
                if (type === 'types_salles') url = '/api/admin/types-salles';
                
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                let html = '<table><thead><tr>';
                if (type === 'enseignants') {
                    html += '<th>Acronyme</th><th>Nom</th><th>Pr√©nom</th><th>Email</th><th>Ateliers</th><th>Actions</th></tr></thead><tbody>';
                    result.data.forEach(e => html += `<tr><td>${e.acronyme}</td><td>${e.nom}</td><td>${e.prenom}</td><td>${e.email || '-'}</td><td>${e.nombre_ateliers}</td><td><button class="btn btn-sm btn-secondary" onclick="resetPasswordEnseignant(${e.id}, '${e.acronyme}')">üîë Reset MDP</button></td></tr>`);
                } else if (type === 'eleves') {
                    html += '<th>Nom</th><th>Pr√©nom</th><th>Classe</th><th>Actions</th></tr></thead><tbody>';
                    result.data.forEach(e => html += `<tr><td>${e.nom}</td><td>${e.prenom}</td><td>${e.classe_nom}</td><td><button class="btn btn-sm btn-secondary" onclick="resetPasswordEleve(${e.id}, '${e.prenom} ${e.nom}')">üîë Reset MDP</button></td></tr>`);
                } else if (type === 'classes') {
                    html += '<th>Nom</th><th>Niveau</th><th>√âl√®ves</th></tr></thead><tbody>';
                    result.data.forEach(c => html += `<tr><td>${c.nom}</td><td>${c.niveau || '-'}</td><td>${c.nombre_eleves}</td></tr>`);
                } else if (type === 'salles') {
                    html += '<th>Nom</th><th>Capacit√©</th><th>Type</th><th>Dispo</th></tr></thead><tbody>';
                    result.data.forEach(s => html += `<tr><td>${s.nom}</td><td>${s.capacite}</td><td>${s.type_salle || '-'}</td><td>${s.disponible ? '‚úÖ' : '‚ùå'}</td></tr>`);
                } else if (type === 'themes') {
                    html += '<th>Ic√¥ne</th><th>Nom</th><th>Couleur</th><th>Description</th><th>Actions</th></tr></thead><tbody>';
                    result.data.forEach(t => html += `<tr>
                        <td style="font-size:24px;">${t.icone || 'üé®'}</td>
                        <td><strong>${t.nom}</strong></td>
                        <td><span style="display:inline-block;width:20px;height:20px;background:${t.couleur || '#667eea'};border-radius:4px;vertical-align:middle;"></span> ${t.couleur || '#667eea'}</td>
                        <td>${t.description || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editTheme(${t.id}, '${t.nom}', '${t.couleur || '#667eea'}', '${t.icone || 'üé®'}', '${t.description || ''}')">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTheme(${t.id}, '${t.nom}')">üóëÔ∏è</button>
                        </td>
                    </tr>`);
                } else if (type === 'types_salles') {
                    html += '<th>Nom</th><th>Description</th><th>Actions</th></tr></thead><tbody>';
                    result.data.forEach(t => html += `<tr>
                        <td><strong>${t.nom}</strong></td>
                        <td>${t.description || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editTypeSalle(${t.id}, '${t.nom}', '${t.description || ''}')">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTypeSalle(${t.id}, '${t.nom}')">üóëÔ∏è</button>
                        </td>
                    </tr>`);
                }
                html += '</tbody></table>';
                // Ajouter boutons reset global pour enseignants et √©l√®ves
                if (type === 'enseignants') {
                    html += `<div style="margin-top:15px;"><button class="btn btn-danger" onclick="resetAllPasswords('enseignants')">üîë R√©initialiser TOUS les MDP enseignants</button></div>`;
                } else if (type === 'eleves') {
                    html += `<div style="margin-top:15px;"><button class="btn btn-danger" onclick="resetAllPasswords('eleves')">üîë R√©initialiser TOUS les MDP √©l√®ves</button></div>`;
                }
                html += '<p style="margin-top:10px;color:#666;"><strong>' + result.data.length + '</strong> enregistrements</p>';
                document.getElementById('listeContainer').innerHTML = html;
            } catch (e) { document.getElementById('listeContainer').innerHTML = '<p style="color:red;">Erreur: ' + e.message + '</p>'; }
        }

        // FORMULAIRES
        document.getElementById('formEnseignant').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = { acronyme: document.getElementById('ens_acronyme').value.toUpperCase(), nom: document.getElementById('ens_nom').value, prenom: document.getElementById('ens_prenom').value, email: document.getElementById('ens_email').value || null };
                const response = await fetch(`${API_BASE}/enseignants`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                const result = await response.json();
                if (result.success) { showAlert('‚úÖ Enseignant ajout√© !', 'success'); e.target.reset(); loadEnseignantsForSelects(); }
                else showAlert('‚ùå ' + result.message, 'error');
            } catch (e) { showAlert('‚ùå Erreur', 'error'); }
        });

        document.getElementById('formClasse').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = { nom: document.getElementById('classe_nom').value, niveau: document.getElementById('classe_niveau').value || null };
                const response = await fetch(`${API_BASE}/classes`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                const result = await response.json();
                if (result.success) { showAlert('‚úÖ Classe ajout√©e !', 'success'); e.target.reset(); loadClassesForSelects(); }
                else showAlert('‚ùå ' + result.message, 'error');
            } catch (e) { showAlert('‚ùå Erreur', 'error'); }
        });

        document.getElementById('formSalle').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = { 
                    nom: document.getElementById('salle_nom').value, 
                    capacite: parseInt(document.getElementById('salle_capacite').value) || 25,
                    type_salle: document.getElementById('salle_type').value || null
                };
                const response = await fetch(`${API_BASE}/salles`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                const result = await response.json();
                if (result.success) { showAlert('‚úÖ Salle ajout√©e !', 'success'); e.target.reset(); }
                else showAlert('‚ùå ' + result.message, 'error');
            } catch (e) { showAlert('‚ùå Erreur', 'error'); }
        });

        document.getElementById('formEleve').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = { nom: document.getElementById('eleve_nom').value, prenom: document.getElementById('eleve_prenom').value, classe_id: parseInt(document.getElementById('eleve_classe').value) };
                const response = await fetch(`${API_BASE}/eleves`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                const result = await response.json();
                if (result.success) { showAlert('‚úÖ √âl√®ve ajout√© !', 'success'); e.target.reset(); chargerTousEleves(); }
                else showAlert('‚ùå ' + result.message, 'error');
            } catch (e) { showAlert('‚ùå Erreur', 'error'); }
        });

        // FORMULAIRE THEME
        document.getElementById('formTheme').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = { 
                    nom: document.getElementById('theme_nom').value, 
                    couleur: document.getElementById('theme_couleur').value,
                    icone: document.getElementById('theme_icone').value || 'üé®',
                    description: document.getElementById('theme_description').value || null
                };
                const response = await fetch('/api/admin/themes', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, 
                    body: JSON.stringify(data) 
                });
                const result = await response.json();
                if (result.success) { 
                    showAlert('‚úÖ Th√®me ajout√© !', 'success'); 
                    e.target.reset(); 
                    document.getElementById('theme_couleur').value = '#667eea';
                    document.getElementById('theme_icone').value = 'üé®';
                    loadListe('themes');
                }
                else showAlert('‚ùå ' + result.message, 'error');
            } catch (e) { showAlert('‚ùå Erreur', 'error'); }
        });

        // FORMULAIRE TYPE SALLE
        document.getElementById('formTypeSalle').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = { 
                    nom: document.getElementById('type_salle_nom').value, 
                    description: document.getElementById('type_salle_description').value || null
                };
                const response = await fetch('/api/admin/types-salles', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, 
                    body: JSON.stringify(data) 
                });
                const result = await response.json();
                if (result.success) { 
                    showAlert('‚úÖ Type de salle ajout√© !', 'success'); 
                    e.target.reset(); 
                    loadListe('types_salles');
                    loadTypesSalles();
                }
                else showAlert('‚ùå ' + result.message, 'error');
            } catch (e) { showAlert('‚ùå Erreur', 'error'); }
        });

        // CRUD THEMES
        async function editTheme(id, nom, couleur, icone, description) {
            const newNom = prompt('Nom du th√®me:', nom);
            if (!newNom) return;
            const newCouleur = prompt('Couleur (hex):', couleur) || couleur;
            const newIcone = prompt('Ic√¥ne:', icone) || icone;
            const newDesc = prompt('Description:', description);
            
            try {
                const response = await fetch(`/api/admin/themes/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ nom: newNom, couleur: newCouleur, icone: newIcone, description: newDesc })
                });
                const result = await response.json();
                if (result.success) { showAlert('‚úÖ Th√®me modifi√©', 'success'); loadListe('themes'); }
                else showAlert('‚ùå ' + result.message, 'error');
            } catch (e) { showAlert('‚ùå Erreur', 'error'); }
        }

        async function deleteTheme(id, nom) {
            if (!confirm(`Supprimer le th√®me "${nom}" ?`)) return;
            try {
                const response = await fetch(`/api/admin/themes/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                if (result.success) { showAlert('‚úÖ Th√®me supprim√©', 'success'); loadListe('themes'); }
                else showAlert('‚ùå ' + result.message, 'error');
            } catch (e) { showAlert('‚ùå Erreur', 'error'); }
        }

        // CRUD TYPES SALLES
        async function editTypeSalle(id, nom, description) {
            const newNom = prompt('Nom du type de salle:', nom);
            if (!newNom) return;
            const newDesc = prompt('Description:', description);
            
            try {
                const response = await fetch(`/api/admin/types-salles/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ nom: newNom, description: newDesc })
                });
                const result = await response.json();
                if (result.success) { showAlert('‚úÖ Type de salle modifi√©', 'success'); loadListe('types_salles'); loadTypesSalles(); }
                else showAlert('‚ùå ' + result.message, 'error');
            } catch (e) { showAlert('‚ùå Erreur', 'error'); }
        }

        async function deleteTypeSalle(id, nom) {
            if (!confirm(`Supprimer le type de salle "${nom}" ?`)) return;
            try {
                const response = await fetch(`/api/admin/types-salles/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                if (result.success) { showAlert('‚úÖ Type de salle supprim√©', 'success'); loadListe('types_salles'); loadTypesSalles(); }
                else showAlert('‚ùå ' + result.message, 'error');
            } catch (e) { showAlert('‚ùå Erreur', 'error'); }
        }

        // Charger les types de salles pour le select du formulaire salle
        async function loadTypesSalles() {
            try {
                const response = await fetch('/api/admin/types-salles', { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                const select = document.getElementById('salle_type');
                if (select) {
                    select.innerHTML = '<option value="">-- Aucun type --</option>';
                    result.data.forEach(t => {
                        select.innerHTML += `<option value="${t.nom}">${t.nom}</option>`;
                    });
                }
            } catch (e) { console.error('Erreur chargement types salles:', e); }
        }

        // RECHERCHE √âL√àVES
        async function chargerTousEleves() {
            try {
                const response = await fetch(`${API_BASE}/eleves`, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                tousLesEleves = result.data || [];
            } catch (e) { console.error(e); }
        }

        function rechercherEleves() {
            const terme = document.getElementById('rechercheEleve').value.toLowerCase().trim();
            const container = document.getElementById('resultatsRecherche');
            if (terme.length < 2) { container.innerHTML = '<p style="padding:10px;color:#666;">Tapez 2+ caract√®res</p>'; return; }
            const resultats = tousLesEleves.filter(e => e.nom.toLowerCase().includes(terme) || e.prenom.toLowerCase().includes(terme)).slice(0, 15);
            if (resultats.length === 0) { container.innerHTML = '<p style="padding:10px;color:#666;">Aucun r√©sultat</p>'; return; }
            let html = '';
            resultats.forEach(e => {
                const selected = elevesSelectionnesIds.has(e.id);
                html += `<div style="padding:8px;border-bottom:1px solid #eee;cursor:pointer;${selected ? 'background:#d1fae5;' : ''}" onclick="toggleEleve(${e.id})">${selected ? '‚úÖ' : '‚¨ú'} <strong>${e.nom}</strong> ${e.prenom} <small>(${e.classe_nom || '?'})</small></div>`;
            });
            container.innerHTML = html;
        }

        function toggleEleve(id) {
            if (elevesSelectionnesIds.has(id)) elevesSelectionnesIds.delete(id);
            else elevesSelectionnesIds.add(id);
            rechercherEleves();
            afficherElevesSelectionnes();
        }

        function afficherElevesSelectionnes() {
            const container = document.getElementById('elevesSelectionnes');
            if (elevesSelectionnesIds.size === 0) { container.innerHTML = '<p style="color:#666;">Aucun</p>'; return; }
            const selected = tousLesEleves.filter(e => elevesSelectionnesIds.has(e.id));
            let html = '';
            selected.forEach(e => html += `<span style="display:inline-block;background:#667eea;color:white;padding:2px 8px;border-radius:12px;margin:2px;font-size:11px;">${e.prenom} ${e.nom} <span onclick="toggleEleve(${e.id})" style="cursor:pointer;">√ó</span></span>`);
            container.innerHTML = html;
        }

        // INSCRIPTIONS
        document.getElementById('formInscrireClasse').addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultDiv = document.getElementById('resultatInscrClasse');
            try {
                const data = { planning_id: parseInt(document.getElementById('inscr_planning_classe').value), classe_id: parseInt(document.getElementById('inscr_classe').value) };
                resultDiv.innerHTML = '<p>‚è≥ Inscription...</p>';
                const response = await fetch(`${API_BASE}/inscriptions-classe`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                const result = await response.json();
                if (result.success) { resultDiv.innerHTML = `<div style="padding:10px;background:#d1fae5;border-radius:8px;">‚úÖ ${result.message}</div>`; loadPlanningsForSelects(); }
                else resultDiv.innerHTML = `<div style="padding:10px;background:#fee2e2;border-radius:8px;">‚ùå ${result.message}</div>`;
            } catch (e) { resultDiv.innerHTML = '<div style="padding:10px;background:#fee2e2;border-radius:8px;">‚ùå Erreur</div>'; }
        });

        document.getElementById('formInscrireEleves').addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultDiv = document.getElementById('resultatInscrEleves');
            if (elevesSelectionnesIds.size === 0) { resultDiv.innerHTML = '<div style="padding:10px;background:#fef3c7;border-radius:8px;">‚ö†Ô∏è S√©lectionnez des √©l√®ves</div>'; return; }
            try {
                const data = { planning_id: parseInt(document.getElementById('inscr_planning_eleves').value), eleve_ids: Array.from(elevesSelectionnesIds) };
                resultDiv.innerHTML = '<p>‚è≥ Inscription...</p>';
                const response = await fetch(`${API_BASE}/inscriptions-eleves`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                const result = await response.json();
                if (result.success) {
                    let msg = `‚úÖ ${result.message}`;
                    if (result.data.conflits && result.data.conflits.length > 0) {
                        msg += `<br><small style="color:#92400e;">‚ö†Ô∏è ${result.data.conflits.length} conflits</small>`;
                    }
                    resultDiv.innerHTML = `<div style="padding:10px;background:#d1fae5;border-radius:8px;">${msg}</div>`;
                    elevesSelectionnesIds.clear(); afficherElevesSelectionnes();
                    document.getElementById('rechercheEleve').value = '';
                    document.getElementById('resultatsRecherche').innerHTML = '';
                    loadPlanningsForSelects();
                } else resultDiv.innerHTML = `<div style="padding:10px;background:#fee2e2;border-radius:8px;">‚ùå ${result.message}</div>`;
            } catch (e) { resultDiv.innerHTML = '<div style="padding:10px;background:#fee2e2;border-radius:8px;">‚ùå Erreur</div>'; }
        });

        // PIQUET
        document.getElementById('formPiquet').addEventListener('submit', async (e) => {
            e.preventDefault();
            const utilisateur_id = document.getElementById('piquet_enseignant').value;
            const creneau_id = document.getElementById('piquet_creneau').value;
            if (!utilisateur_id || !creneau_id) { showAlert('‚ùå Enseignant et cr√©neau requis', 'error'); return; }
            try {
                const data = { utilisateur_id: parseInt(utilisateur_id), creneau_id: parseInt(creneau_id), type: document.getElementById('piquet_type').value, commentaire: document.getElementById('piquet_commentaire').value || null };
                const response = await fetch(`${API_BASE}/piquet`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                const result = await response.json();
                if (result.success) { showAlert('‚úÖ ' + result.message, 'success'); e.target.reset(); loadPiquetListe(); }
                else showAlert('‚ùå ' + result.message, 'error');
            } catch (e) { showAlert('‚ùå Erreur', 'error'); }
        });

        async function loadPiquetListe() {
            try {
                const response = await fetch(`${API_BASE}/piquet`, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                if (result.data.length === 0) { document.getElementById('piquetListe').innerHTML = '<p style="color:#666;">Aucun</p>'; return; }
                let html = '<table><thead><tr><th>Enseignant</th><th>Cr√©neau</th><th>Type</th><th>Commentaire</th><th></th></tr></thead><tbody>';
                result.data.forEach(p => {
                    const jour = p.jour.charAt(0).toUpperCase() + p.jour.slice(1);
                    const typeLabel = p.type === 'degagement' ? '<span class="badge badge-blue">D√©gagement</span>' : '<span class="badge badge-yellow">Piquet</span>';
                    html += `<tr><td>${p.enseignant_prenom} ${p.enseignant_nom}</td><td>${jour} ${p.periode}</td><td>${typeLabel}</td><td>${p.commentaire || '-'}</td><td><button class="btn btn-danger btn-sm" onclick="deletePiquet(${p.id})">üóëÔ∏è</button></td></tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('piquetListe').innerHTML = html;
            } catch (e) { document.getElementById('piquetListe').innerHTML = '<p style="color:red;">Erreur</p>'; }
        }

        async function deletePiquet(id) {
            if (!confirm('Supprimer ?')) return;
            try {
                const response = await fetch(`${API_BASE}/piquet/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                if (result.success) { showAlert('‚úÖ Supprim√©', 'success'); loadPiquetListe(); }
                else showAlert('‚ùå ' + result.message, 'error');
            } catch (e) { showAlert('‚ùå Erreur', 'error'); }
        }

        // √âL√àVES PAR CR√âNEAU
        async function loadElevesCreneaux() {
            const container = document.getElementById('elevesCreneauxContainer');
            const jour = document.getElementById('filtre_jour').value;
            const classeId = document.getElementById('filtre_classe_eleves').value;
            try {
                let url = `${API_BASE}/tous-eleves-creneaux?`;
                if (jour) url += `jour=${jour}&`;
                if (classeId) url += `classe_id=${classeId}&`;
                container.innerHTML = '<p>‚è≥ Chargement...</p>';
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                if (result.data.length === 0) { container.innerHTML = '<p style="color:#666;">Aucune inscription</p>'; return; }
                const parCreneau = {};
                result.data.forEach(i => {
                    const key = `${i.jour}_${i.periode}`;
                    if (!parCreneau[key]) parCreneau[key] = { jour: i.jour, periode: i.periode, eleves: [] };
                    parCreneau[key].eleves.push(i);
                });
                let html = '';
                Object.values(parCreneau).forEach(creneau => {
                    const jour = creneau.jour.charAt(0).toUpperCase() + creneau.jour.slice(1);
                    html += `<div style="margin-bottom:20px;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;"><div style="background:#667eea;color:white;padding:10px 15px;font-weight:600;">${jour} ${creneau.periode} - ${creneau.eleves.length} √©l√®ves</div><table style="margin:0;"><thead><tr><th>√âl√®ve</th><th>Classe</th><th>Atelier</th><th>Salle</th></tr></thead><tbody>`;
                    creneau.eleves.forEach(e => html += `<tr><td>${e.eleve_nom} ${e.eleve_prenom}</td><td>${e.classe_nom}</td><td>${e.atelier_nom}</td><td>${e.salle_nom || '-'}</td></tr>`);
                    html += '</tbody></table></div>';
                });
                container.innerHTML = html;
            } catch (e) { container.innerHTML = '<p style="color:red;">Erreur</p>'; }
        }

        // CR√âNEAUX FAIBLES
        async function loadCreneauxFaibles() {
            const container = document.getElementById('creneauxFaiblesContainer');
            const seuil = document.getElementById('seuil_faibles').value || 5;
            try {
                container.innerHTML = '<p>‚è≥ Chargement...</p>';
                const response = await fetch(`${API_BASE}/creneaux-faibles?seuil=${seuil}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                if (result.data.length === 0) { container.innerHTML = `<p style="color:#10b981;">‚úÖ Aucun cr√©neau avec moins de ${seuil} inscriptions</p>`; return; }
                let html = `<p style="margin-bottom:15px;"><strong>${result.data.length}</strong> cr√©neaux</p><table><thead><tr><th>Atelier</th><th>Jour</th><th>P√©riode</th><th>Inscrits</th><th>Dispo</th></tr></thead><tbody>`;
                result.data.forEach(c => {
                    const jour = c.jour.charAt(0).toUpperCase() + c.jour.slice(1);
                    const badge = c.nb_inscrits === 0 ? '<span class="badge badge-red">0</span>' : `<span class="badge badge-yellow">${c.nb_inscrits}</span>`;
                    html += `<tr><td><strong>${c.atelier_nom}</strong></td><td>${jour}</td><td>${c.periode}</td><td>${badge}</td><td>${c.places_restantes}</td></tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (e) { container.innerHTML = '<p style="color:red;">Erreur</p>'; }
        }

        // ========== GESTION INSCRIPTIONS √âL√àVES ==========
        let currentEleveId = null;
        let allPlanningsAdmin = [];
        
        async function rechercherEleveAdmin() {
            const terme = document.getElementById('searchEleve').value.trim();
            const container = document.getElementById('resultatsRechercheEleve');
            
            if (terme.length < 2) {
                container.innerHTML = '<p style="padding:10px;color:#666;">Tapez au moins 2 caract√®res</p>';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/recherche-eleve?q=${encodeURIComponent(terme)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                if (result.data.length === 0) {
                    container.innerHTML = '<p style="padding:10px;color:#666;">Aucun √©l√®ve trouv√©</p>';
                    return;
                }
                
                let html = '';
                result.data.forEach(e => {
                    const valideBadge = e.inscriptions_validees 
                        ? '<span class="badge badge-green" style="margin-left:5px;">‚úì Valid√©</span>' 
                        : '<span class="badge badge-yellow" style="margin-left:5px;">Non valid√©</span>';
                    html += `<div style="padding:10px;border-bottom:1px solid #eee;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="chargerInscriptionsEleve(${e.eleve_id})">
                        <span><strong>${e.nom} ${e.prenom}</strong> <small>(${e.classe_nom})</small></span>
                        ${valideBadge}
                    </div>`;
                });
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = '<p style="padding:10px;color:red;">Erreur</p>';
            }
        }
        
        async function chargerInscriptionsEleve(eleveId) {
            currentEleveId = eleveId;
            
            try {
                const response = await fetch(`${API_BASE}/eleve/${eleveId}/inscriptions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                if (!result.success) {
                    showAlert('‚ùå ' + result.message, 'error');
                    return;
                }
                
                const { eleve, inscriptions } = result.data;
                
                // Header
                const valideBadge = eleve.inscriptions_validees 
                    ? '<span class="badge badge-green">‚úì Inscriptions valid√©es</span>' 
                    : '<span class="badge badge-yellow">Non valid√©es</span>';
                document.getElementById('eleveInfoHeader').innerHTML = `
                    <h3>${eleve.prenom} ${eleve.nom}</h3>
                    <p>Classe: <strong>${eleve.classe_nom}</strong> ${valideBadge}</p>
                    ${eleve.date_validation ? `<p style="font-size:12px;color:#666;">Valid√© le: ${new Date(eleve.date_validation).toLocaleDateString('fr-CH')}</p>` : ''}
                `;
                
                // Bouton d√©-valider
                document.getElementById('btnDevalider').style.display = eleve.inscriptions_validees ? 'inline-block' : 'none';
                
                // Liste inscriptions
                if (inscriptions.length === 0) {
                    document.getElementById('eleveInscriptionsListe').innerHTML = '<p style="color:#666;">Aucune inscription</p>';
                } else {
                    let html = '<table><thead><tr><th>Atelier</th><th>Jour</th><th>P√©riode</th><th>Salle</th><th></th></tr></thead><tbody>';
                    inscriptions.forEach(i => {
                        const jour = i.jour.charAt(0).toUpperCase() + i.jour.slice(1);
                        const manuelBadge = i.inscription_manuelle ? ' <span class="badge badge-blue">Admin</span>' : '';
                        html += `<tr>
                            <td><strong>${i.atelier_nom}</strong>${manuelBadge}</td>
                            <td>${jour}</td>
                            <td>${i.periode}</td>
                            <td>${i.salle_nom || '-'}</td>
                            <td><button class="btn btn-danger btn-sm" onclick="supprimerInscription(${i.inscription_id}, '${i.atelier_nom.replace(/'/g, "\\'")}')">üóëÔ∏è</button></td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    document.getElementById('eleveInscriptionsListe').innerHTML = html;
                }
                
                document.getElementById('eleveInscriptionsContainer').style.display = 'block';
                
                // Charger les cr√©neaux pour modal
                await loadPlanningsAdmin();
            } catch (e) {
                showAlert('‚ùå Erreur', 'error');
            }
        }
        
        async function loadPlanningsAdmin() {
            try {
                const response = await fetch(`${API_BASE}/ateliers-planifies`, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                allPlanningsAdmin = result.data || [];
                updatePlanningsAdminSelect(allPlanningsAdmin);
            } catch (e) { console.error(e); }
        }
        
        function updatePlanningsAdminSelect(plannings) {
            const select = document.getElementById('adminInscriptionCreneau');
            select.innerHTML = '<option value="">-- S√©lectionner --</option>';
            plannings.forEach(p => {
                const jour = p.jour.charAt(0).toUpperCase() + p.jour.slice(1);
                const places = p.nombre_places_max - p.nb_inscrits;
                select.innerHTML += `<option value="${p.planning_id}">${p.atelier_nom} - ${jour} ${p.periode} (${places} places)</option>`;
            });
        }
        
        function filterCreneauxAdmin() {
            const term = document.getElementById('searchCreneauAdmin').value.toLowerCase().trim();
            if (term.length === 0) {
                updatePlanningsAdminSelect(allPlanningsAdmin);
                return;
            }
            const filtered = allPlanningsAdmin.filter(p => p.atelier_nom.toLowerCase().includes(term));
            updatePlanningsAdminSelect(filtered);
        }
        
        function showAjouterInscription() {
            document.getElementById('modalAjouterInscr').style.display = 'flex';
        }
        
        function hideAjouterInscription() {
            document.getElementById('modalAjouterInscr').style.display = 'none';
        }
        
        async function ajouterInscriptionAdmin() {
            const planningId = document.getElementById('adminInscriptionCreneau').value;
            const notifier = document.getElementById('adminNotifier').checked;
            
            if (!planningId) {
                showAlert('‚ùå S√©lectionnez un cr√©neau', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/eleve/${currentEleveId}/inscription`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ planning_id: parseInt(planningId), notifier })
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ ' + result.message, 'success');
                    hideAjouterInscription();
                    chargerInscriptionsEleve(currentEleveId);
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Erreur', 'error');
            }
        }
        
        async function supprimerInscription(inscriptionId, atelierNom) {
            if (!confirm(`Supprimer l'inscription √† "${atelierNom}" ?\nL'√©l√®ve sera notifi√©.`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/inscription/${inscriptionId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ notifier: true })
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ Inscription supprim√©e', 'success');
                    chargerInscriptionsEleve(currentEleveId);
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Erreur', 'error');
            }
        }
        
        async function devaliderEleve() {
            if (!confirm('D√©-valider les inscriptions de cet √©l√®ve ?\nIl pourra √† nouveau modifier ses inscriptions.')) return;
            
            try {
                const response = await fetch(`${API_BASE}/eleve/${currentEleveId}/devalider`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ notifier: true })
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert('‚úÖ Inscriptions d√©-valid√©es', 'success');
                    chargerInscriptionsEleve(currentEleveId);
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Erreur', 'error');
            }
        }

        // ========== RESET MOT DE PASSE ==========
        async function resetPasswordEnseignant(id, acronyme) {
            if (!confirm(`R√©initialiser le mot de passe de ${acronyme} ?\n\nNouveau mot de passe: ${acronyme.toLowerCase()}`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/enseignant/${id}/reset-password`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`‚úÖ ${result.message}\nNouveau mot de passe: ${result.new_password}`, 'success');
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Erreur', 'error');
            }
        }

        async function resetPasswordEleve(eleveId, nom) {
            if (!confirm(`R√©initialiser le mot de passe de ${nom} ?\n\nNouveau mot de passe: eleve2026`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/eleve/${eleveId}/reset-password`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`‚úÖ ${result.message}\nNouveau mot de passe: ${result.new_password}`, 'success');
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Erreur', 'error');
            }
        }

        async function resetAllPasswords(type) {
            const typeLabel = type === 'enseignants' ? 'enseignants (acronyme en minuscules)' : '√©l√®ves (eleve2026)';
            if (!confirm(`‚ö†Ô∏è ATTENTION: R√©initialiser TOUS les mots de passe des ${typeLabel} ?`)) return;
            if (!confirm('√ätes-vous vraiment s√ªr ?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/reset-all-passwords`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ type })
                });
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`‚úÖ ${result.message}`, 'success');
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (e) {
                showAlert('‚ùå Erreur', 'error');
            }
        }
    </script>
</body>
</html>
