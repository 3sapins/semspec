<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Enseignants | Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1800px; margin: 0 auto; }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 { color: #667eea; font-size: 24px; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a67d8; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }

        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }

        .legend-bar {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-atelier { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .legend-piquet { background: #f59e0b; }
        .legend-degagement { background: #10b981; }
        .legend-surcharge { background: #ef4444; }

        .planning-grid {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }

        th, td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
            min-width: 100px;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th:first-child, th:nth-child(2), th:nth-child(3) {
            position: sticky;
            left: 0;
            z-index: 20;
        }

        th:nth-child(2) { left: 80px; }
        th:nth-child(3) { left: 180px; }

        td:first-child, td:nth-child(2), td:nth-child(3) {
            background: #f9fafb;
            font-weight: 600;
            position: sticky;
            left: 0;
            z-index: 5;
        }

        td:nth-child(2) { left: 80px; background: #f3f4f6; }
        td:nth-child(3) { left: 180px; background: #f9fafb; }

        .enseignant-cell {
            min-width: 80px;
            font-weight: 600;
            font-size: 13px;
        }

        .charge-cell {
            font-size: 12px;
            color: #6b7280;
        }

        .charge-ok { color: #10b981; font-weight: 600; }
        .charge-warning { color: #f59e0b; font-weight: 600; }
        .charge-danger { color: #ef4444; font-weight: 600; }

        .total-cell {
            background: #f3f4f6 !important;
            font-weight: 700;
        }

        .atelier-mini {
            color: white;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 11px;
            margin: 2px;
            display: inline-block;
            max-width: 90px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }

        .atelier-mini:hover {
            transform: scale(1.05);
        }

        .atelier-mini.suite {
            opacity: 0.7;
        }

        .piquet-badge {
            background: #f59e0b;
            color: white;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: 600;
        }

        .degagement-badge {
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: 600;
        }

        .empty-cell {
            color: #d1d5db;
            font-size: 12px;
        }

        .row-surcharge {
            background: #fef2f2 !important;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: white;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-summary {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë®‚Äçüè´ Planning par Enseignant</h1>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="location.reload()">
                    ‚Üª Actualiser
                </button>
                <a href="planning.html" class="btn btn-secondary">üìÖ Planning Salles</a>
                <a href="index.html" class="btn btn-secondary">‚Üê Retour</a>
            </div>
        </div>

        <div class="legend-bar">
            <span style="font-weight: 600;">L√©gende :</span>
            <div class="legend-item">
                <div class="legend-box legend-atelier"></div>
                <span>Atelier</span>
            </div>
            <div class="legend-item">
                <div class="legend-box legend-piquet"></div>
                <span>Piquet</span>
            </div>
            <div class="legend-item">
                <div class="legend-box legend-degagement"></div>
                <span>D√©gagement</span>
            </div>
            <div class="legend-item">
                <div class="legend-box legend-surcharge"></div>
                <span>Surcharge (> charge max)</span>
            </div>
        </div>

        <div class="stats-summary">
            <div class="stat-box">
                <div class="stat-value" id="statEnseignants">-</div>
                <div class="stat-label">Enseignants</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="statOccupes">-</div>
                <div class="stat-label">Avec Ateliers</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="statPiquet">-</div>
                <div class="stat-label">En Piquet</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="statSurcharge" style="color: #ef4444;">-</div>
                <div class="stat-label">En Surcharge</div>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Chargement du planning enseignants...</p>
        </div>

        <div id="planningContainer" class="planning-grid" style="display: none;">
            <table id="planningTable">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Modal Modifier/Supprimer -->
        <div id="modalModifier" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
            <div style="background:white; padding:30px; border-radius:15px; max-width:500px; width:90%; max-height:90vh; overflow-y:auto;">
                <h3 style="margin-bottom:20px; color:#667eea;">üìù Modifier le placement</h3>
                <div id="modalInfo" style="background:#f3f4f6; padding:15px; border-radius:8px; margin-bottom:20px;"></div>
                
                <div style="margin-bottom:15px;">
                    <label style="font-weight:600; display:block; margin-bottom:5px;">Nouvelle salle :</label>
                    <select id="modalSalle" style="width:100%; padding:10px; border:2px solid #e5e7eb; border-radius:8px;">
                        <option value="">-- Ne pas changer --</option>
                    </select>
                </div>
                
                <div style="margin-bottom:20px;">
                    <label style="font-weight:600; display:block; margin-bottom:5px;">Nouveau cr√©neau :</label>
                    <select id="modalCreneau" style="width:100%; padding:10px; border:2px solid #e5e7eb; border-radius:8px;">
                        <option value="">-- Ne pas changer --</option>
                    </select>
                </div>
                
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button onclick="saveModification()" class="btn btn-primary">üíæ Enregistrer</button>
                    <button onclick="confirmSupprimer()" class="btn" style="background:#ef4444; color:white;">üóëÔ∏è Supprimer</button>
                    <button onclick="closeModal()" class="btn btn-secondary">Annuler</button>
                </div>
            </div>
        </div>

        <!-- Alert -->
        <div id="alertBox" style="display:none; position:fixed; top:20px; right:20px; padding:15px 25px; border-radius:10px; z-index:1001; font-weight:600;"></div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'login.html';

        let themesMap = {};
        let sallesList = [];
        let creneauxList = [];
        let currentPlanningId = null;
        const DEFAULT_COLOR = '#667eea';

        document.addEventListener('DOMContentLoaded', async () => {
            await loadThemes();
            await loadSallesEtCreneaux();
            await loadPlanningEnseignants();
        });

        async function loadSallesEtCreneaux() {
            try {
                const [sallesResp, creneauxResp] = await Promise.all([
                    fetch('/api/admin/salles', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/planning/creneaux', { headers: { 'Authorization': `Bearer ${token}` } })
                ]);
                const sallesData = await sallesResp.json();
                const creneauxData = await creneauxResp.json();
                sallesList = sallesData.data || [];
                creneauxList = creneauxData.data || [];
                
                // Remplir les selects du modal
                const salleSelect = document.getElementById('modalSalle');
                const creneauSelect = document.getElementById('modalCreneau');
                
                salleSelect.innerHTML = '<option value="">-- Ne pas changer --</option>';
                sallesList.forEach(s => salleSelect.innerHTML += `<option value="${s.id}">${s.nom}</option>`);
                
                creneauSelect.innerHTML = '<option value="">-- Ne pas changer --</option>';
                creneauxList.forEach(c => {
                    const jourCap = c.jour.charAt(0).toUpperCase() + c.jour.slice(1);
                    creneauSelect.innerHTML += `<option value="${c.id}">${jourCap} ${c.periode}</option>`;
                });
            } catch (e) { console.error('Erreur chargement salles/cr√©neaux:', e); }
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alertBox');
            alert.textContent = message;
            alert.style.background = type === 'success' ? '#d1fae5' : '#fee2e2';
            alert.style.color = type === 'success' ? '#065f46' : '#991b1b';
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 3000);
        }

        function openModifier(planningId, atelierNom, salle, jour, periode) {
            currentPlanningId = planningId;
            const jourCap = jour.charAt(0).toUpperCase() + jour.slice(1);
            document.getElementById('modalInfo').innerHTML = `
                <p><strong>Atelier:</strong> ${atelierNom}</p>
                <p><strong>Position:</strong> ${salle} - ${jourCap} ${periode}</p>
            `;
            document.getElementById('modalModifier').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modalModifier').style.display = 'none';
            currentPlanningId = null;
        }

        async function saveModification() {
            const salleId = document.getElementById('modalSalle').value;
            const creneauId = document.getElementById('modalCreneau').value;
            if (!salleId && !creneauId) { 
                showAlert('S√©lectionnez une salle ou un cr√©neau', 'error'); 
                return; 
            }
            try {
                const response = await fetch(`/api/planning/${currentPlanningId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ 
                        salle_id: salleId || undefined, 
                        creneau_id: creneauId || undefined 
                    })
                });
                const result = await response.json();
                if (result.success) { 
                    showAlert('‚úÖ Modifi√©', 'success'); 
                    closeModal(); 
                    loadPlanningEnseignants(); 
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (e) { showAlert('‚ùå Erreur', 'error'); }
        }

        async function confirmSupprimer() {
            if (!confirm('Supprimer ce placement ?')) return;
            try {
                const response = await fetch(`/api/planning/${currentPlanningId}`, { 
                    method: 'DELETE', 
                    headers: { 'Authorization': `Bearer ${token}` } 
                });
                const result = await response.json();
                if (result.success) { 
                    showAlert('‚úÖ Supprim√©', 'success'); 
                    closeModal(); 
                    loadPlanningEnseignants(); 
                } else {
                    showAlert('‚ùå ' + result.message, 'error');
                }
            } catch (e) { showAlert('‚ùå Erreur', 'error'); }
        }

        async function loadThemes() {
            try {
                const response = await fetch('/api/admin/themes', { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await response.json();
                if (result.success) {
                    result.data.forEach(t => { 
                        themesMap[t.id] = { nom: t.nom, couleur: t.couleur || DEFAULT_COLOR, icone: t.icone }; 
                    });
                }
            } catch (e) { console.log('Th√®mes non charg√©s'); }
        }

        function getAtelierColor(atelier) {
            if (atelier.theme_couleur) return atelier.theme_couleur;
            if (atelier.theme_id && themesMap[atelier.theme_id]) return themesMap[atelier.theme_id].couleur;
            return DEFAULT_COLOR;
        }

        function adjustColor(hex, amount) {
            if (!hex || hex.length < 7) return hex || DEFAULT_COLOR;
            let r = parseInt(hex.slice(1, 3), 16);
            let g = parseInt(hex.slice(3, 5), 16);
            let b = parseInt(hex.slice(5, 7), 16);
            r = Math.max(0, Math.min(255, r + amount));
            g = Math.max(0, Math.min(255, g + amount));
            b = Math.max(0, Math.min(255, b + amount));
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }

        async function loadPlanningEnseignants() {
            try {
                // Charger les enseignants
                const ensResponse = await fetch('/api/gestion/enseignants', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const ensResult = await ensResponse.json();
                const enseignants = ensResult.data || [];

                // Charger le planning
                const planResponse = await fetch('/api/planning/grid', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const planResult = await planResponse.json();
                const planning = planResult.data || {};

                // Charger les piquets
                const piquetResponse = await fetch('/api/gestion/piquet', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const piquetResult = await piquetResponse.json();
                const piquets = piquetResult.data || [];

                // Charger les cr√©neaux
                const creneauxResponse = await fetch('/api/planning/creneaux', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const creneauxResult = await creneauxResponse.json();
                const creneaux = creneauxResult.data || [];

                // Organiser les donn√©es
                displayPlanningEnseignants(enseignants, planning, piquets, creneaux);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('planningContainer').style.display = 'block';

            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loading').innerHTML = 
                    '<p style="color: #fee2e2;">‚ùå Erreur de chargement</p>';
            }
        }

        function displayPlanningEnseignants(enseignants, planning, piquets, creneaux) {
            const jours = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi'];
            const periodes = ['P1-2', 'P3-4', 'P6-7'];

            // Cr√©er map des piquets par enseignant et cr√©neau
            const piquetMap = {};
            piquets.forEach(p => {
                const key = `${p.acronyme}_${p.jour}_${p.periode}`;
                piquetMap[key] = p;
            });

            // Cr√©er map des ateliers par enseignant et cr√©neau
            const atelierMap = {};
            Object.entries(planning).forEach(([jour, jourData]) => {
                Object.entries(jourData).forEach(([periode, periodeData]) => {
                    Object.entries(periodeData).forEach(([salle, atelier]) => {
                        if (atelier) {
                            // Enseignant principal
                            const key1 = `${atelier.enseignant_acronyme}_${jour}_${periode}`;
                            if (!atelierMap[key1]) atelierMap[key1] = [];
                            atelierMap[key1].push({...atelier, salle});

                            // Enseignants suppl√©mentaires
                            if (atelier.enseignant2_acronyme) {
                                const key2 = `${atelier.enseignant2_acronyme}_${jour}_${periode}`;
                                if (!atelierMap[key2]) atelierMap[key2] = [];
                                atelierMap[key2].push({...atelier, salle});
                            }
                            if (atelier.enseignant3_acronyme) {
                                const key3 = `${atelier.enseignant3_acronyme}_${jour}_${periode}`;
                                if (!atelierMap[key3]) atelierMap[key3] = [];
                                atelierMap[key3].push({...atelier, salle});
                            }
                        }
                    });
                });
            });

            // Header
            let headerHtml = '<tr><th style="min-width:80px;">Acronyme</th><th style="min-width:100px;">Nom</th><th style="min-width:80px;">Charge</th>';
            jours.forEach(jour => {
                periodes.forEach(periode => {
                    if (jour === 'mercredi' && periode === 'P6-7') return;
                    const jourCap = jour.charAt(0).toUpperCase() + jour.slice(1);
                    headerHtml += `<th>${jourCap}<br>${periode}</th>`;
                });
            });
            headerHtml += '<th>Total</th></tr>';
            document.querySelector('#planningTable thead').innerHTML = headerHtml;

            // Stats
            let enseignantsOccupes = 0;
            let enseignantsEnPiquet = new Set();
            let enseignantsEnSurcharge = 0;

            // Body
            let bodyHtml = '';
            
            // Trier enseignants par nom
            enseignants.sort((a, b) => a.nom.localeCompare(b.nom));

            enseignants.forEach(ens => {
                let totalPeriodes = 0;
                let hasAtelier = false;
                let rowClass = '';

                let rowHtml = `<tr>`;
                rowHtml += `<td class="enseignant-cell">${ens.acronyme}</td>`;
                rowHtml += `<td>${ens.nom}</td>`;
                
                // Charge max
                const chargeMax = ens.charge_max || 0;
                rowHtml += `<td class="charge-cell">${chargeMax > 0 ? chargeMax + 'p' : '-'}</td>`;

                jours.forEach(jour => {
                    periodes.forEach(periode => {
                        if (jour === 'mercredi' && periode === 'P6-7') return;

                        const key = `${ens.acronyme}_${jour}_${periode}`;
                        const ateliers = atelierMap[key] || [];
                        const piquet = piquetMap[key];

                        let cellContent = '';

                        if (ateliers.length > 0) {
                            hasAtelier = true;
                            ateliers.forEach(a => {
                                const isSuite = a.suite_atelier;
                                const color = getAtelierColor(a);
                                let bgStyle = `background: ${color};`;
                                if (isSuite) {
                                    bgStyle = `background: repeating-linear-gradient(45deg, ${color}, ${color} 5px, ${adjustColor(color, -20)} 5px, ${adjustColor(color, -20)} 10px);`;
                                }
                                const atelierNomEscaped = (a.atelier_nom || '').replace(/'/g, "\\'");
                                const clickable = a.planning_id && !isSuite ? `onclick="openModifier(${a.planning_id}, '${atelierNomEscaped}', '${a.salle}', '${jour}', '${periode}')" style="${bgStyle} cursor:pointer;"` : `style="${bgStyle}"`;
                                cellContent += `<div class="atelier-mini ${isSuite ? 'suite' : ''}" ${clickable} title="${a.atelier_nom} - ${a.salle}${a.planning_id && !isSuite ? ' (cliquer pour modifier)' : ''}">${isSuite ? '‚Üì' : ''} ${a.atelier_nom}</div>`;
                                if (!isSuite) {
                                    totalPeriodes += a.duree || 2;
                                }
                            });
                        } else if (piquet) {
                            enseignantsEnPiquet.add(ens.acronyme);
                            if (piquet.type === 'piquet') {
                                cellContent = `<span class="piquet-badge">PIQUET</span>`;
                            } else {
                                cellContent = `<span class="degagement-badge">D√âGAG.</span>`;
                            }
                        } else {
                            cellContent = `<span class="empty-cell">‚Äî</span>`;
                        }

                        rowHtml += `<td>${cellContent}</td>`;
                    });
                });

                // Total et v√©rification surcharge
                let totalClass = '';
                if (chargeMax > 0) {
                    if (totalPeriodes > chargeMax) {
                        totalClass = 'charge-danger';
                        enseignantsEnSurcharge++;
                        rowClass = 'row-surcharge';
                    } else if (totalPeriodes >= chargeMax * 0.9) {
                        totalClass = 'charge-warning';
                    } else {
                        totalClass = 'charge-ok';
                    }
                }

                rowHtml += `<td class="total-cell ${totalClass}">${totalPeriodes}p</td>`;
                rowHtml += '</tr>';

                if (hasAtelier) enseignantsOccupes++;

                // Appliquer classe de ligne si surcharge
                if (rowClass) {
                    rowHtml = rowHtml.replace('<tr>', `<tr class="${rowClass}">`);
                }

                bodyHtml += rowHtml;
            });

            document.querySelector('#planningTable tbody').innerHTML = bodyHtml;

            // Mettre √† jour stats
            document.getElementById('statEnseignants').textContent = enseignants.length;
            document.getElementById('statOccupes').textContent = enseignantsOccupes;
            document.getElementById('statPiquet').textContent = enseignantsEnPiquet.size;
            document.getElementById('statSurcharge').textContent = enseignantsEnSurcharge;
        }
    </script>
</body>
</html>
