<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <title>Inscriptions incompl√®tes | Semaine Sp√©ciale</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header { background: white; padding: 25px 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        h1 { color: #667eea; font-size: 24px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; text-decoration: none; display: inline-block; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background: #d1d5db; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        /* Stats cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); text-align: center; }
        .stat-value { font-size: 36px; font-weight: 800; margin-bottom: 5px; }
        .stat-label { font-size: 13px; color: #6b7280; }
        .stat-green .stat-value { color: #10b981; }
        .stat-orange .stat-value { color: #f59e0b; }
        .stat-red .stat-value { color: #ef4444; }
        .stat-blue .stat-value { color: #667eea; }
        
        /* Filtres */
        .filters { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .filters label { font-weight: 600; color: #374151; font-size: 14px; }
        .filters select, .filters input { padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; }
        .filters select:focus, .filters input:focus { outline: none; border-color: #667eea; }
        
        /* Tableau */
        .table-card { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .table-header { padding: 20px 25px; border-bottom: 2px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; }
        .table-header h2 { color: #374151; font-size: 18px; }
        .table-count { background: #fef3c7; color: #92400e; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; }
        
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f9fafb; padding: 12px 15px; text-align: left; font-size: 13px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e5e7eb; white-space: nowrap; }
        td { padding: 12px 15px; border-bottom: 1px solid #f3f4f6; font-size: 14px; color: #374151; }
        tr:hover { background: #f9fafb; }
        
        .eleve-name { font-weight: 600; }
        .classe-badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #ede9fe; color: #5b21b6; }
        
        /* Barre de progression */
        .progress-bar { width: 120px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; display: inline-block; vertical-align: middle; margin-right: 8px; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .progress-green { background: #10b981; }
        .progress-yellow { background: #f59e0b; }
        .progress-red { background: #ef4444; }
        .progress-text { font-size: 12px; font-weight: 600; }
        
        /* Cr√©neaux manquants */
        .creneaux-list { display: flex; flex-wrap: wrap; gap: 4px; }
        .creneau-tag { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; background: #fee2e2; color: #991b1b; white-space: nowrap; }
        .creneau-lundi { background: #dbeafe; color: #1e40af; }
        .creneau-mardi { background: #fce7f3; color: #9d174d; }
        .creneau-mercredi { background: #d1fae5; color: #065f46; }
        .creneau-jeudi { background: #fef3c7; color: #92400e; }
        .creneau-vendredi { background: #ede9fe; color: #5b21b6; }
        
        /* Statut */
        .status-none { color: #ef4444; font-weight: 700; }
        .status-partial { color: #f59e0b; font-weight: 600; }
        
        .empty-state { text-align: center; padding: 60px; color: #6b7280; }
        .empty-state .icon { font-size: 64px; margin-bottom: 15px; }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { flex-direction: column; align-items: stretch; text-align: center; padding: 15px; }
            h1 { font-size: 20px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .stat-card { padding: 15px; }
            .stat-value { font-size: 28px; }
            .filters { flex-direction: column; }
            .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            table { min-width: 800px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö†Ô∏è Inscriptions incompl√®tes</h1>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="exportCSV()">üì• Export CSV</button>
                <a href="/gestion.html" class="btn btn-secondary">‚Üê Gestion</a>
            </div>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card"><div class="stat-value">-</div><div class="stat-label">Chargement...</div></div>
        </div>
        
        <div class="filters">
            <label>üîç Filtrer :</label>
            <select id="filterClasse" onchange="applyFilters()">
                <option value="">Toutes les classes</option>
            </select>
            <select id="filterStatut" onchange="applyFilters()">
                <option value="">Tous les statuts</option>
                <option value="none">‚ùå Aucune inscription</option>
                <option value="partial">‚ö†Ô∏è Inscription partielle</option>
            </select>
            <input type="text" id="filterSearch" placeholder="Rechercher un √©l√®ve..." oninput="applyFilters()">
            <span id="filterCount" style="color: #6b7280; font-size: 13px;"></span>
        </div>
        
        <div class="table-card">
            <div class="table-header">
                <h2>√âl√®ves √† compl√©ter</h2>
                <span class="table-count" id="tableCount">-</span>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>√âl√®ve</th>
                            <th>Classe</th>
                            <th>Ateliers</th>
                            <th>Progression</th>
                            <th>Cr√©neaux manquants</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="5" class="loading">‚è≥ Chargement des donn√©es...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';
        
        async function loadData() {
            try {
                const resp = await fetch('/api/gestion/inscriptions-incompletes', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await resp.json();
                
                if (!result.success) throw new Error(result.message);
                
                allData = result.eleves;
                renderStats(result.stats);
                populateClassFilter();
                applyFilters();
                
            } catch (err) {
                console.error(err);
                document.getElementById('tableBody').innerHTML = 
                    `<tr><td colspan="5" class="loading">‚ùå Erreur : ${err.message}</td></tr>`;
            }
        }
        
        function renderStats(stats) {
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card stat-blue">
                    <div class="stat-value">${stats.total_eleves}</div>
                    <div class="stat-label">√âl√®ves total</div>
                </div>
                <div class="stat-card stat-green">
                    <div class="stat-value">${stats.complets}</div>
                    <div class="stat-label">‚úÖ Complets (${stats.taux_completion}%)</div>
                </div>
                <div class="stat-card stat-orange">
                    <div class="stat-value">${stats.incomplets}</div>
                    <div class="stat-label">‚ö†Ô∏è Partiels</div>
                </div>
                <div class="stat-card stat-red">
                    <div class="stat-value">${stats.sans_inscription}</div>
                    <div class="stat-label">‚ùå Sans inscription</div>
                </div>
            `;
        }
        
        function populateClassFilter() {
            const classes = [...new Set(allData.map(e => e.classe))].sort();
            const select = document.getElementById('filterClasse');
            classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                select.appendChild(opt);
            });
        }
        
        function applyFilters() {
            const classe = document.getElementById('filterClasse').value;
            const statut = document.getElementById('filterStatut').value;
            const search = document.getElementById('filterSearch').value.toLowerCase();
            
            filteredData = allData.filter(e => {
                if (classe && e.classe !== classe) return false;
                if (statut === 'none' && e.nb_ateliers > 0) return false;
                if (statut === 'partial' && e.nb_ateliers === 0) return false;
                if (search && !`${e.prenom} ${e.nom}`.toLowerCase().includes(search) && !e.classe.toLowerCase().includes(search)) return false;
                return true;
            });
            
            renderTable();
            document.getElementById('tableCount').textContent = `${filteredData.length} √©l√®ve(s)`;
            document.getElementById('filterCount').textContent = 
                filteredData.length !== allData.length ? `${filteredData.length} / ${allData.length}` : '';
        }
        
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="5">
                        <div class="empty-state">
                            <div class="icon">üéâ</div>
                            <p>Tous les √©l√®ves ont une inscription compl√®te !</p>
                        </div>
                    </td></tr>`;
                return;
            }
            
            let html = '';
            for (const e of filteredData) {
                const pct = e.pourcentage;
                let progressClass = 'progress-red';
                if (pct >= 70) progressClass = 'progress-yellow';
                if (pct >= 90) progressClass = 'progress-green';
                
                const statusClass = e.nb_ateliers === 0 ? 'status-none' : 'status-partial';
                const statusText = e.nb_ateliers === 0 ? '‚ùå Aucune' : `${e.nb_ateliers} atelier(s)`;
                
                // Cr√©neaux manquants group√©s par jour
                const creneauxHtml = e.creneaux_manquants.map(c => {
                    const jour = c.jour.charAt(0).toUpperCase() + c.jour.slice(1, 3);
                    return `<span class="creneau-tag creneau-${c.jour}">${jour} ${c.periode}</span>`;
                }).join('');
                
                html += `
                    <tr>
                        <td><span class="eleve-name">${e.prenom} ${e.nom}</span></td>
                        <td><span class="classe-badge">${e.classe}</span></td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                        <td>
                            <div class="progress-bar"><div class="progress-fill ${progressClass}" style="width: ${pct}%"></div></div>
                            <span class="progress-text">${e.nb_creneaux_occupes}/${e.nb_creneaux_total}</span>
                        </td>
                        <td><div class="creneaux-list">${creneauxHtml}</div></td>
                    </tr>`;
            }
            
            tbody.innerHTML = html;
        }
        
        function exportCSV() {
            if (filteredData.length === 0) return alert('Aucune donn√©e √† exporter');
            
            let csv = 'Pr√©nom;Nom;Classe;Nb ateliers;Cr√©neaux occup√©s;Cr√©neaux total;Cr√©neaux manquants\n';
            
            for (const e of filteredData) {
                const manquants = e.creneaux_manquants.map(c => 
                    `${c.jour} ${c.periode}`
                ).join(', ');
                
                csv += `${e.prenom};${e.nom};${e.classe};${e.nb_ateliers};${e.nb_creneaux_occupes};${e.nb_creneaux_total};"${manquants}"\n`;
            }
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'inscriptions_incompletes.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        loadData();
    </script>
<script>if("serviceWorker" in navigator){navigator.serviceWorker.register("/sw.js").catch(e=>console.log("SW:",e));}</script>
</body>
</html>
