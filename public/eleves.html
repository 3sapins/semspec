<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscriptions - Semaine Sp√©ciale | Coll√®ge des Trois-Sapins</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        .header {
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 { color: #667eea; font-size: 24px; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
        }

        .card-body { padding: 20px; }

        /* Tableau horaire */
        .horaire-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .horaire-table th {
            background: #f3f4f6;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #e5e7eb;
        }

        .horaire-table td {
            padding: 10px;
            border: 1px solid #e5e7eb;
            vertical-align: top;
            min-width: 150px;
            height: 80px;
        }

        .horaire-table .periode-label {
            background: #f9fafb;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
        }

        .creneau-vide {
            background: #fef2f2;
            cursor: pointer;
            transition: all 0.3s;
        }

        .creneau-vide:hover {
            background: #fee2e2;
        }

        .creneau-rempli {
            background: #d1fae5;
        }

        .creneau-multi {
            background: #dbeafe;
        }

        .creneau-mercredi-pm {
            background: #f3f4f6;
            color: #9ca3af;
        }

        .atelier-mini {
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 13px;
        }

        .atelier-mini .nom {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .atelier-mini .salle {
            font-size: 11px;
            color: #6b7280;
        }

        .atelier-mini .btn-remove {
            background: #ef4444;
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-top: 5px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 { color: #667eea; }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        /* Liste ateliers dans modal */
        .atelier-option {
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .atelier-option:hover {
            border-color: #667eea;
            background: #f5f3ff;
        }

        .atelier-option.complet {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .atelier-option .nom {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .atelier-option .details {
            font-size: 13px;
            color: #6b7280;
        }

        .atelier-option .places {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-top: 5px;
        }

        .atelier-option .places.dispo { background: #d1fae5; color: #065f46; }
        .atelier-option .places.peu { background: #fef3c7; color: #92400e; }
        .atelier-option .places.complet { background: #fee2e2; color: #991b1b; }

        /* Validation */
        .validation-box {
            background: #f0fdf4;
            border: 2px solid #22c55e;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
        }

        .validation-box.error {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .validation-box h3 {
            margin-bottom: 10px;
        }

        /* Login */
        #loginPage, #dashboardPage { display: none; }

        .login-box {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .login-box h2 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }

        .alert-success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }

        .alert-error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        @media (max-width: 900px) {
            .horaire-table { font-size: 12px; }
            .horaire-table td { min-width: 100px; padding: 5px; }
        }
    </style>
</head>
<body>
    <!-- PAGE DE CONNEXION -->
    <div id="loginPage">
        <div class="login-box">
            <h2>üë®‚Äçüéì Inscriptions</h2>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">Semaine Sp√©ciale - Coll√®ge des Trois-Sapins</p>
            <form id="loginForm">
                <div class="form-group">
                    <label>Identifiant</label>
                    <input type="text" id="acronyme" placeholder="Ton identifiant" required>
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Se connecter</button>
            </form>
            <div id="loginError" style="display: none; margin-top: 15px;" class="alert alert-error"></div>
        </div>
    </div>

    <!-- DASHBOARD √âL√àVE -->
    <div id="dashboardPage">
        <div class="container">
            <div class="header">
                <div>
                    <h1>üéì Semaine Sp√©ciale</h1>
                    <p style="color: #666; margin-top: 5px;">Inscriptions aux ateliers</p>
                </div>
                <div style="text-align: right;">
                    <p><strong id="userName"></strong> - Classe: <strong id="userClasse"></strong></p>
                    <div style="margin-top: 10px;">
                        <a href="catalogue.html" class="btn btn-secondary">üìö Catalogue</a>
                        <button class="btn btn-secondary" onclick="showChangePassword()">üîë</button>
                        <button class="btn btn-danger" onclick="logout()">D√©connexion</button>
                    </div>
                </div>
            </div>

            <div id="alertsBanner"></div>

            <!-- MON HORAIRE (VUE TABLEAU) -->
            <div class="card">
                <div class="card-header">üìÖ Mon Horaire de la Semaine Sp√©ciale</div>
                <div class="card-body">
                    <p style="margin-bottom: 15px; color: #6b7280;">
                        Clique sur une case <span style="background:#fef2f2;padding:2px 8px;border-radius:4px;">rouge</span> pour choisir un atelier. 
                        Les cases <span style="background:#d1fae5;padding:2px 8px;border-radius:4px;">vertes</span> sont d√©j√† remplies.
                    </p>
                    
                    <div id="horaireContainer">
                        <div class="loading">Chargement de ton horaire...</div>
                    </div>

                    <div id="validationBox"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CHOIX ATELIER -->
    <div id="modalChoixAtelier" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üé® Choisir un atelier</h2>
                <button class="close-modal" onclick="closeModal()">√ó</button>
            </div>
            <p id="modalCreneauInfo" style="margin-bottom: 15px; color: #6b7280;"></p>
            <div id="ateliersDisponibles">
                <div class="loading">Chargement...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let currentToken = null;
        let currentUser = null;
        let eleveId = null;
        let ateliersData = [];
        let inscriptionsData = [];
        let creneauxData = [];
        let inscriptionsOuvertes = false;

        // Structure des cr√©neaux
        const JOURS = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi'];
        const PERIODES = ['P1-2', 'P3-4', 'P6-7'];

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (token) {
                currentToken = token;
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    if (payload.role === 'eleve') {
                        currentUser = payload;
                        showDashboard();
                    } else {
                        showLogin();
                    }
                } catch (e) {
                    showLogin();
                }
            } else {
                showLogin();
            }
        });

        function showLogin() {
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('dashboardPage').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardPage').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.prenom + ' ' + currentUser.nom;
            loadData();
        }

        // Connexion
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        acronyme: document.getElementById('acronyme').value,
                        password: document.getElementById('password').value
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.user.role === 'eleve') {
                    localStorage.setItem('token', data.token);
                    currentToken = data.token;
                    currentUser = data.user;
                    showDashboard();
                } else if (data.user?.role !== 'eleve') {
                    showError('Ce portail est r√©serv√© aux √©l√®ves.');
                } else {
                    showError(data.message || 'Erreur de connexion');
                }
            } catch (error) {
                showError('Erreur de connexion au serveur');
            }
        });

        function showError(msg) {
            const el = document.getElementById('loginError');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function logout() {
            localStorage.removeItem('token');
            location.reload();
        }

        // Charger les donn√©es
        async function loadData() {
            try {
                // Charger ateliers disponibles
                const respAteliers = await fetch(`${API_URL}/eleves/ateliers-disponibles`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const dataAteliers = await respAteliers.json();
                
                if (dataAteliers.success) {
                    ateliersData = dataAteliers.data || [];
                    inscriptionsOuvertes = dataAteliers.inscriptions_ouvertes;
                    eleveId = dataAteliers.eleve_info?.id;
                    document.getElementById('userClasse').textContent = dataAteliers.eleve_info?.classe || '-';
                    
                    if (!inscriptionsOuvertes) {
                        document.getElementById('alertsBanner').innerHTML = `
                            <div class="alert alert-warning">
                                <strong>‚ö†Ô∏è Inscriptions ferm√©es</strong> - Tu peux consulter les ateliers mais pas encore t'inscrire.
                            </div>
                        `;
                    }
                }

                // Charger mes inscriptions
                const respInscr = await fetch(`${API_URL}/eleves/mes-inscriptions`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const dataInscr = await respInscr.json();
                
                if (dataInscr.success) {
                    inscriptionsData = dataInscr.data || [];
                }

                // Charger les cr√©neaux
                const respCreneaux = await fetch(`${API_URL}/planning/creneaux`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const dataCreneaux = await respCreneaux.json();
                
                if (dataCreneaux.success) {
                    creneauxData = dataCreneaux.data || [];
                }

                // Afficher l'horaire
                displayHoraire();
                
            } catch (error) {
                console.error('Erreur chargement:', error);
                document.getElementById('horaireContainer').innerHTML = 
                    '<div class="alert alert-error">Erreur de chargement des donn√©es</div>';
            }
        }

        // Afficher l'horaire sous forme de tableau
        function displayHoraire() {
            // Cr√©er une map des inscriptions par cr√©neau
            const inscriptionParCreneau = {};
            
            inscriptionsData.forEach(insc => {
                if (insc.creneau_id && insc.nombre_creneaux) {
                    // Pour chaque cr√©neau couvert par l'atelier
                    for (let i = 0; i < insc.nombre_creneaux; i++) {
                        const creneauId = insc.creneau_id + i;
                        inscriptionParCreneau[creneauId] = {
                            ...insc,
                            isStart: i === 0,
                            span: insc.nombre_creneaux
                        };
                    }
                }
            });

            // Cr√©er une map des cr√©neaux par jour/p√©riode
            const creneauMap = {};
            creneauxData.forEach(c => {
                const key = `${c.jour}-${c.periode}`;
                creneauMap[key] = c;
            });

            let html = '<table class="horaire-table"><thead><tr><th></th>';
            JOURS.forEach(jour => {
                html += `<th>${jour.charAt(0).toUpperCase() + jour.slice(1)}</th>`;
            });
            html += '</tr></thead><tbody>';

            PERIODES.forEach(periode => {
                html += `<tr><td class="periode-label">${periode}</td>`;
                
                JOURS.forEach(jour => {
                    const key = `${jour}-${periode}`;
                    const creneau = creneauMap[key];
                    
                    // Mercredi apr√®s-midi
                    if (jour === 'mercredi' && periode === 'P6-7') {
                        html += '<td class="creneau-mercredi-pm">Cong√©</td>';
                        return;
                    }
                    
                    if (!creneau) {
                        html += '<td>-</td>';
                        return;
                    }
                    
                    const inscription = inscriptionParCreneau[creneau.id];
                    
                    if (inscription) {
                        if (inscription.isStart) {
                            // D√©but d'un atelier
                            const cellClass = inscription.nombre_creneaux > 1 ? 'creneau-multi' : 'creneau-rempli';
                            html += `<td class="${cellClass}">
                                <div class="atelier-mini">
                                    <div class="nom">${inscription.atelier_nom}</div>
                                    <div class="salle">üìç ${inscription.salle_nom || '-'}</div>
                                    ${inscription.duree > 2 ? `<div class="salle">‚è±Ô∏è ${inscription.duree}p</div>` : ''}
                                    ${inscriptionsOuvertes ? `<button class="btn-remove" onclick="desinscrire(${inscription.id}, '${inscription.atelier_nom.replace(/'/g, "\\'")}')">‚úï Retirer</button>` : ''}
                                </div>
                            </td>`;
                        } else {
                            // Suite d'un atelier multi-cr√©neaux
                            html += `<td class="creneau-multi">
                                <div class="atelier-mini" style="opacity:0.7;">
                                    <div class="nom">‚Üë Suite</div>
                                    <div class="salle">${inscription.atelier_nom}</div>
                                </div>
                            </td>`;
                        }
                    } else {
                        // Cr√©neau vide
                        if (inscriptionsOuvertes) {
                            html += `<td class="creneau-vide" onclick="openChoixAtelier(${creneau.id}, '${jour}', '${periode}')">
                                <div style="text-align:center;color:#dc2626;">
                                    <div style="font-size:24px;">+</div>
                                    <div style="font-size:11px;">Choisir</div>
                                </div>
                            </td>`;
                        } else {
                            html += `<td class="creneau-vide" style="cursor:default;">
                                <div style="text-align:center;color:#9ca3af;">
                                    <div style="font-size:11px;">Vide</div>
                                </div>
                            </td>`;
                        }
                    }
                });
                
                html += '</tr>';
            });

            html += '</tbody></table>';
            document.getElementById('horaireContainer').innerHTML = html;

            // Validation
            checkValidation();
        }

        // V√©rifier si l'horaire est complet
        function checkValidation() {
            const creneauxRequis = creneauxData.filter(c => 
                !(c.jour === 'mercredi' && c.periode === 'P6-7')
            );
            
            const creneauxRemplis = new Set();
            inscriptionsData.forEach(insc => {
                if (insc.creneau_id && insc.nombre_creneaux) {
                    for (let i = 0; i < insc.nombre_creneaux; i++) {
                        creneauxRemplis.add(insc.creneau_id + i);
                    }
                }
            });

            const creneauxManquants = creneauxRequis.filter(c => !creneauxRemplis.has(c.id));
            
            let html = '';
            if (creneauxManquants.length === 0 && creneauxRequis.length > 0) {
                html = `
                    <div class="validation-box">
                        <h3>‚úÖ Horaire complet !</h3>
                        <p>Tu as un atelier pour chaque cr√©neau de la semaine sp√©ciale.</p>
                        <button class="btn btn-success" onclick="validerHoraire()" style="margin-top:15px;">
                            ‚úîÔ∏è Valider mon horaire
                        </button>
                    </div>
                `;
            } else if (creneauxRequis.length > 0) {
                const manquantsList = creneauxManquants.map(c => 
                    `${c.jour.charAt(0).toUpperCase() + c.jour.slice(1)} ${c.periode}`
                ).join(', ');
                
                html = `
                    <div class="validation-box error">
                        <h3>‚ö†Ô∏è Horaire incomplet</h3>
                        <p>Il te manque ${creneauxManquants.length} cr√©neau(x) : <strong>${manquantsList}</strong></p>
                        <p style="margin-top:10px;font-size:13px;">Clique sur les cases rouges pour choisir des ateliers.</p>
                    </div>
                `;
            }
            
            document.getElementById('validationBox').innerHTML = html;
        }

        // Ouvrir le modal de choix d'atelier
        function openChoixAtelier(creneauId, jour, periode) {
            document.getElementById('modalCreneauInfo').textContent = 
                `${jour.charAt(0).toUpperCase() + jour.slice(1)} - ${periode}`;
            
            // Filtrer les ateliers disponibles pour ce cr√©neau
            const ateliersDispos = ateliersData.filter(a => a.creneau_id === creneauId);
            
            let html = '';
            
            if (ateliersDispos.length === 0) {
                html = '<div class="alert alert-warning">Aucun atelier disponible pour ce cr√©neau.</div>';
            } else {
                ateliersDispos.forEach(a => {
                    const complet = a.places_restantes <= 0;
                    const dejaInscrit = a.deja_inscrit == 1;
                    
                    let placesClass = 'dispo';
                    if (complet) placesClass = 'complet';
                    else if (a.places_restantes <= 3) placesClass = 'peu';
                    
                    const optionClass = complet ? 'atelier-option complet' : 'atelier-option';
                    const onclick = complet || dejaInscrit ? '' : `onclick="inscrire(${a.planning_id}, '${a.nom.replace(/'/g, "\\'")}')"`;
                    
                    html += `
                        <div class="${optionClass}" ${onclick}>
                            <div class="nom">${a.nom}</div>
                            <div class="details">
                                üë§ ${a.enseignant_prenom} ${a.enseignant_nom}
                                ${a.duree > 2 ? ` ‚Ä¢ ‚è±Ô∏è ${a.duree} p√©riodes` : ''}
                                ‚Ä¢ üìç ${a.salle_nom || '-'}
                            </div>
                            ${a.description ? `<div class="details" style="margin-top:5px;">${a.description.substring(0, 100)}${a.description.length > 100 ? '...' : ''}</div>` : ''}
                            <span class="places ${placesClass}">
                                ${complet ? 'Complet' : dejaInscrit ? '‚úì D√©j√† inscrit' : `${a.places_restantes} place(s)`}
                            </span>
                        </div>
                    `;
                });
            }
            
            document.getElementById('ateliersDisponibles').innerHTML = html;
            document.getElementById('modalChoixAtelier').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modalChoixAtelier').classList.remove('show');
        }

        // S'inscrire √† un atelier
        async function inscrire(planningId, nomAtelier) {
            if (!confirm(`T'inscrire √† "${nomAtelier}" ?`)) return;
            
            try {
                const response = await fetch(`${API_URL}/eleves/inscrire/${planningId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal();
                    loadData(); // Recharger
                } else {
                    alert(data.message || 'Erreur lors de l\'inscription');
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        // Se d√©sinscrire
        async function desinscrire(inscriptionId, nomAtelier) {
            if (!confirm(`Te d√©sinscrire de "${nomAtelier}" ?`)) return;
            
            try {
                const response = await fetch(`${API_URL}/eleves/desinscrire/${inscriptionId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadData();
                } else {
                    alert(data.message || 'Erreur');
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        // Valider l'horaire
        async function validerHoraire() {
            alert('‚úÖ Ton horaire a √©t√© valid√© ! Tu recevras une confirmation.');
            // TODO: Impl√©menter la validation c√¥t√© serveur si n√©cessaire
        }

        // Changer mot de passe
        function showChangePassword() {
            const newPwd = prompt('Nouveau mot de passe :');
            if (!newPwd) return;
            
            const confirmPwd = prompt('Confirmer le mot de passe :');
            if (newPwd !== confirmPwd) {
                alert('Les mots de passe ne correspondent pas');
                return;
            }
            
            fetch(`${API_URL}/auth/change-password`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentToken}`
                },
                body: JSON.stringify({ newPassword: newPwd })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('Mot de passe modifi√© !');
                } else {
                    alert(data.message || 'Erreur');
                }
            })
            .catch(() => alert('Erreur'));
        }
    </script>
</body>
</html>
